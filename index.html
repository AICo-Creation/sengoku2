<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legend of General Star　群雄将星伝</title>
    <style>
        :root {
            --bg-primary: #000; --bg-secondary: #111; --bg-tertiary: #222; --bg-card: #333; --bg-hover: #444;
            --border-primary: #666; --border-secondary: #555;
            --text-primary: #fff; --text-secondary: #ccc; --text-muted: #888;
            --accent-red: #ff6666; --accent-green: #66ff66; --accent-blue: #6666ff; --accent-yellow: #ffff66;
            --gradient-primary: linear-gradient(145deg, #333, #555);
            --gradient-button: linear-gradient(145deg, #444, #666);
            --gradient-hover: linear-gradient(145deg, #555, #777);
            --shadow-glow: 0 0 10px rgba(255, 102, 102, 0.5);
            --transition-smooth: all 0.3s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); color: var(--text-primary); font: 12px Arial, sans-serif; overflow: hidden; }
        .container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        .header { height: 60px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-primary); }
        .title { font: bold 24px Arial; color: var(--accent-red); text-shadow: 2px 2px 4px #000; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .control-panel { width: 320px; height: 180px; background: var(--bg-tertiary); border-top: 2px solid var(--border-primary); padding: 8px 10px; display: flex; flex-direction: column; gap: 8px; }
        .log-area { flex: 1; height: 180px; background: var(--bg-secondary); border-top: 2px solid var(--border-primary); border-left: 1px solid var(--border-secondary); padding: 10px; overflow-y: auto; line-height: 1.4; }
        .bottom-section { display: flex; height: 180px; }
        .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .turn-display { position: absolute; top: 10px; left: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 8px 12px; font-weight: bold; z-index: 100; }
        .map-area { position: relative; }
        
        .daimyo-selection, .map-area { padding: 20px; }
        .map-area { flex: 1; overflow: auto; }
        .daimyo-selection { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 900px; margin: 0 auto; }
        .daimyo-card { background: var(--gradient-primary); border: 2px solid var(--border-primary); border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; transition: var(--transition-smooth); }
        .daimyo-card:hover { border-color: var(--accent-red); transform: scale(1.02); box-shadow: 0 3px 10px rgba(255, 102, 102, 0.3); }
        .daimyo-name { font: bold 16px Arial; color: var(--accent-red); margin-bottom: 8px; }
        .daimyo-desc { font-size: 12px; line-height: 1.4; color: var(--text-secondary); }
        .map-grid { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(3, 1fr); gap: 2px; height: 100%; max-width: 100%; margin: 0 auto; }
        .territory { border: 2px solid var(--border-primary); border-radius: 5px; padding: 1px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; line-height: 1.1; transition: var(--transition-smooth); aspect-ratio: 1; min-height: 55px; }
        .territory:hover { border-color: var(--accent-red); box-shadow: var(--shadow-glow); }
        .territory.empty { background: var(--bg-card); color: var(--text-muted); }
        .territory.player { background: linear-gradient(145deg, #004400, #006600); }
        .territory.enemy { background: linear-gradient(145deg, #440000, #660000); }
        .territory-name { font-weight: bold; margin-bottom: 5px; color: var(--accent-red); }
        .territory-owner { font-size: 10px; margin-bottom: 3px; }
        .territory-stats { font-size: 9px; line-height: 1.1; }
        
        .btn { background: var(--gradient-button); border: 1px solid var(--text-muted); color: var(--text-primary); padding: 6px 8px; border-radius: 5px; cursor: pointer; transition: var(--transition-smooth); font-size: 11px; }
        .btn:hover { background: var(--gradient-hover); border-color: var(--accent-red); }
        .btn:disabled { background: var(--bg-card); border-color: var(--border-secondary); color: var(--text-muted); cursor: not-allowed; }
        .btn.primary { background: linear-gradient(145deg, #ff4444, var(--accent-red)); border-color: #ff8888; }
        .btn.primary:hover { background: linear-gradient(145deg, var(--accent-red), #ff8888); }
        .status-display { background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 8px; display: flex; gap: 15px; justify-content: space-around; }
        
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-card); border: 2px solid var(--border-primary); border-radius: 10px; padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font: bold 18px Arial; color: var(--accent-red); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .log-entry { margin-bottom: 5px; padding: 2px 5px; border-left: 3px solid var(--border-primary); }
        .log-entry.battle { border-left-color: var(--accent-red); }
        .log-entry.diplomacy { border-left-color: var(--accent-green); }
        .log-entry.strategy { border-left-color: var(--accent-blue); }
        .hidden { display: none !important; }
        
        .generals-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-primary); padding-bottom: 10px; }
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border-primary); padding: 8px 16px; border-radius: 5px 5px 0 0; }
        .tab-btn.active { background: var(--border-secondary); border-color: var(--accent-red); color: var(--accent-red); }
        .tab-content { display: none; min-height: 300px; }
        .tab-content.active { display: block; }
        .tab-content h3 { color: var(--accent-red); margin-bottom: 15px; font-size: 16px; }
        .role-settings { display: grid; gap: 15px; }
        .role-group { display: flex; align-items: center; gap: 10px; }
        .role-group label { min-width: 100px; font-weight: bold; }
        .role-group select, .formation-position select, .assignment-controls select, .recruit-controls select { background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 5px 10px; border-radius: 3px; }
        .role-group select { min-width: 200px; }
        .assignment-controls select, .recruit-controls select { background: var(--bg-tertiary); border-color: var(--border-secondary); padding: 3px 8px; min-width: 150px; }
        .formation-position select { width: 100%; background: var(--bg-tertiary); border-color: var(--border-secondary); padding: 5px; }
        .formation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .formation-position { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 5px; padding: 10px; }
        .formation-position label { display: block; font-weight: bold; color: var(--accent-red); margin-bottom: 5px; }
        .position-info { color: var(--text-secondary); font-style: italic; }
        .army-stats, .current-roles-display, .current-army-display, .recruit-info { background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 5px; padding: 15px; margin-bottom: 20px; }
        .army-stats h4, .current-roles-display h4, .current-army-display h4, .recruit-info h4 { color: var(--accent-red); margin-bottom: 10px; font-size: 14px; }
        .territory-assignment, .general-card, .recruit-general-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 5px; padding: 10px; margin-bottom: 10px; }
        .territory-assignment { display: flex; justify-content: space-between; align-items: center; }
        .territory-info { flex: 1; }
        .territory-name-assign, .general-name, .recruit-general-name { font-weight: bold; color: var(--accent-red); }
        .territory-stats-assign { color: var(--text-secondary); }
        .assignment-controls, .recruit-controls { display: flex; gap: 10px; align-items: center; }
        .general-card { padding: 15px; }
        .general-name { font-size: 16px; margin-bottom: 8px; }
        .general-stats-detail { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 8px; }
        .stat-item, .recruit-stat-item { display: flex; justify-content: space-between; }
        .general-skill, .recruit-general-skill { color: var(--accent-green); margin-bottom: 5px; }
        .general-loyalty { color: var(--accent-yellow); }
        .assignment-status { font-size: 11px; color: var(--text-secondary); margin-top: 5px; }
        
        .role-item, .formation-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border-secondary); }
        .role-item:last-child, .formation-item:last-child { border-bottom: none; }
        .role-label, .formation-label { font-weight: bold; color: var(--text-secondary); }
        .role-value, .formation-value { color: var(--accent-green); }
        .role-value.empty, .formation-value.empty { color: var(--text-muted); font-style: italic; }
        
        .power-display { display: grid; gap: 8px; }
        .power-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background: var(--bg-card); border-radius: 3px; }
        .power-value { font: bold 16px Arial; color: var(--accent-green); }
        .total-power { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-hover); border: 2px solid var(--accent-red); border-radius: 5px; margin-top: 10px; }
        .total-value { font: bold 20px Arial; color: var(--accent-red); }
        
        .formation-display { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .available-generals-list { max-height: 400px; overflow-y: auto; }
        .recruit-general-card { display: flex; justify-content: space-between; align-items: center; }
        .recruit-general-info { flex: 1; }
        .recruit-general-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; margin-bottom: 5px; }
        .recruit-cost { color: var(--accent-yellow); font-weight: bold; }
        .recruit-controls { display: flex; flex-direction: column; align-items: center; gap: 10px; min-width: 120px; }
        .recruit-chance { font-size: 11px; color: var(--text-secondary); text-align: center; }
        .recruit-chance.high { color: var(--accent-green); }
        .recruit-chance.medium { color: var(--accent-yellow); }
        .recruit-chance.low { color: var(--accent-red); }
        
        .recruit-btn { background: linear-gradient(145deg, #006600, #008800); border: 1px solid #00aa00; color: var(--text-primary); padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; transition: var(--transition-smooth); }
        .recruit-btn:hover { background: linear-gradient(145deg, #008800, #00aa00); }
        .recruit-btn:disabled { background: var(--bg-card); border-color: var(--border-secondary); color: var(--text-muted); cursor: not-allowed; }
        
        .battle-participants { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; }
        .attacker-info, .defender-info { padding: 15px; border: 1px solid var(--border-primary); border-radius: 5px; }
        .attacker-info { background: #003300; border-color: var(--accent-green); }
        .defender-info { background: #330000; border-color: var(--accent-red); }
        .participant-stats { margin-top: 10px; }
        .participant-stats div { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 2px 5px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        
        .battle-log-content { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
        .battle-event { margin-bottom: 8px; padding: 8px; border-left: 3px solid var(--border-primary); background: var(--bg-tertiary); border-radius: 3px; font-size: 13px; line-height: 1.4; }
        .battle-event.attack { border-left-color: var(--accent-red); background: #331111; }
        .battle-event.defense { border-left-color: var(--accent-blue); background: #111133; }
        .battle-event.damage { border-left-color: var(--accent-yellow); background: #333311; }
        .battle-event.victory { border-left-color: var(--accent-green); background: #113311; }
        .battle-event.skill { border-left-color: #ff66ff; background: #331133; }
        .battle-event.general-activity { border-left-color: #66ccff; background: #113333; }
        
        .battle-result { background: var(--bg-tertiary); border: 2px solid var(--accent-red); border-radius: 8px; padding: 15px; text-align: center; }
        .result-summary { font: bold 16px Arial; margin-bottom: 15px; }
        .result-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .result-item { padding: 8px; background: var(--bg-card); border-radius: 5px; display: flex; justify-content: space-between; }
        .power-display { color: var(--accent-green); font-weight: bold; }
        .damage-display { color: var(--accent-red); font-weight: bold; }
        .success-display { color: var(--accent-yellow); font-weight: bold; }
        
        #generals-reset-btn { background: linear-gradient(145deg, #994400, #bb6600); border: 1px solid #dd8800; }
        #generals-reset-btn:hover { background: linear-gradient(145deg, #bb6600, #dd8800); }
        
        .turn-log { background: rgba(0, 0, 0, 0.9); position: fixed; inset: 0; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .turn-log-content { background: var(--bg-tertiary); border: 2px solid var(--border-primary); border-radius: 10px; padding: 30px; max-width: 80%; max-height: 80%; overflow-y: auto; }
        .turn-log-title { font: bold 24px Arial; color: var(--accent-red); text-align: center; margin-bottom: 20px; }
        .turn-events { font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
        .turn-log-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .action-log-section, .personnel-log-section { flex: 1; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; }
        .log-section-title { color: var(--accent-red); font: bold 16px Arial; margin-bottom: 15px; text-align: center; border-bottom: 1px solid var(--border-primary); padding-bottom: 8px; }
        .personnel-log-section .log-section-title { color: var(--accent-green); }
        .no-events { text-align: center; color: var(--text-muted); font-style: italic; padding: 20px; }
        .event-entry { margin-bottom: 10px; padding: 8px; border-radius: 5px; background: var(--bg-card); }
        
        @media (max-width: 768px) {
            .map-grid { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); }
            .bottom-section { flex-direction: column; height: auto; }
            .control-panel { width: 100%; height: auto; }
            .log-area { height: 100px; border-left: none; border-top: 1px solid var(--border-secondary); }
            .daimyo-selection { grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; }
            .daimyo-card { padding: 10px; }
            .daimyo-name { font-size: 14px; margin-bottom: 6px; }
            .daimyo-desc { font-size: 11px; }
            .turn-log-container { flex-direction: column; gap: 15px; }
            .action-log-section, .personnel-log-section { max-height: 300px; }
        }
        
        @media (max-width: 480px) {
            .daimyo-selection { grid-template-columns: 1fr; gap: 8px; padding: 10px; }
            .daimyo-card { padding: 8px; }
            .daimyo-name { font-size: 13px; margin-bottom: 5px; }
            .daimyo-desc { font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header hidden" id="game-header"></div>
        <div id="daimyo-selection-screen" class="main-content" style="overflow-y: auto;">
            <div class="header"><div class="title">The Legend of General Star　群雄将星伝</div></div>
            <div class="daimyo-selection" style="min-height: calc(100vh - 60px); padding-bottom: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 900px; margin: 0 auto;">
                <div class="daimyo-card" data-daimyo="oda"><div class="daimyo-name">織田信長</div><div class="daimyo-desc">革新的な戦術で天下統一を目指す</div></div>
                <div class="daimyo-card" data-daimyo="hashiba"><div class="daimyo-name">羽柴秀吉</div><div class="daimyo-desc">成り上がりの天下人</div></div>
                <div class="daimyo-card" data-daimyo="tokugawa"><div class="daimyo-name">徳川家康</div><div class="daimyo-desc">三河の堅実な統治者</div></div>
            </div>
        </div>
        
        <div id="scout-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-title">偵察報告</div>
                <div id="scout-body">
                    <div id="scout-target-info" style="margin-bottom: 20px;"></div>
                    <div id="scout-generals-info"></div>
                </div>
                <div class="action-buttons"><button class="btn primary" id="scout-close-btn">閉じる</button></div>
            </div>
        </div>
        <div id="recruit-general-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-title">武将登用</div>
                <div id="recruit-general-body">
                    <div class="recruit-info">
                        <h4>登用条件</h4>
                        <p>・登用には一律金100が必要です</p>
                        <p>・成功率は人事総監の魅力に依存します</p>
                        <p>・失敗しても金は消費されます</p>
                    </div>
                    <div class="available-generals-list" id="available-generals-list"></div>
                </div>
                <div class="action-buttons"><button class="btn" id="recruit-general-cancel-btn">閉じる</button></div>
            </div>
        </div>
        <div id="battle-log-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-title">出兵記録</div>
                <div id="battle-log-body">
                    <div class="battle-participants">
                        <div class="attacker-info">
                            <h4 style="color: #66ff66;">【攻撃側】</h4>
                            <div id="attacker-details"></div>
                        </div>
                        <div class="defender-info">
                            <h4 style="color: #ff6666;">【防御側】</h4>
                            <div id="defender-details"></div>
                        </div>
                    </div>
                    <div class="battle-log-content">
                        <h4 style="color: #ffff66; text-align: center; margin: 20px 0;">戦闘経過</h4>
                        <div id="battle-events-log"></div>
                    </div>
                    <div class="battle-result">
                        <h4 style="color: #ff6666; text-align: center; margin: 20px 0;">戦果</h4>
                        <div id="battle-final-result"></div>
                    </div>
                </div>
                <div class="action-buttons"><button class="btn primary" id="battle-log-close-btn">閉じる</button></div>
            </div>
        </div>
        
        <div id="game-screen" class="main-content hidden">
            <div class="turn-display"><span>ターン:</span> <span id="current-turn">1</span></div>
            <div class="map-area"><div class="map-grid" id="map-grid"></div></div>
            <div class="bottom-section">
                <div class="control-panel">
                    <div class="status-display">
                        <div><strong>金:</strong> <span id="player-gold">1000</span></div>
                        <div><strong>米:</strong> <span id="player-rice">500</span></div>
                    </div>
                    <div class="button-grid">
                        <button class="btn primary" id="next-turn-btn">ターン更新</button>
                        <button class="btn" id="trade-btn">米売買</button>
                        <button class="btn" id="recruit-btn">兵雇用</button>
                        <button class="btn" id="recruit-general-btn">武将登用</button>
                        <button class="btn" id="generals-btn">武将設定</button>
                        <button class="btn" id="attack-btn" disabled>出兵</button>
                        <button class="btn" id="strategy-btn" disabled>謀略</button>
                        <button class="btn" id="diplomacy-btn" disabled>外交</button>
                        <button class="btn" id="scout-btn" disabled>偵察</button>
                    </div>
                </div>
                <div class="log-area" id="log-area"><div class="log-entry">ゲーム開始。天下統一を目指せ！</div></div>
            </div>
        </div>
        
        <div id="turn-log-screen" class="turn-log hidden">
            <div class="turn-log-content">
                <div class="turn-log-title">戦況報告</div>
                <div class="turn-log-container">
                    <div class="action-log-section">
                        <h3 class="log-section-title">行動ログ</h3>
                        <div class="turn-events" id="action-events"></div>
                    </div>
                    <div class="personnel-log-section">
                        <h3 class="log-section-title">人事ログ</h3>
                        <div class="turn-events" id="personnel-events"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;"><button class="btn primary" id="confirm-turn-btn">確認</button></div>
            </div>
        </div>
        <div id="action-modal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="modal-title">行動選択</div>
                <div id="modal-body"></div>
                <div class="action-buttons">
                    <button class="btn" id="modal-cancel-btn">キャンセル</button>
                    <button class="btn primary" id="modal-confirm-btn">実行</button>
                </div>
            </div>
        </div>
        
        <div id="generals-modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-title">武将設定</div>
                <div id="generals-body">
                    <div class="generals-tabs">
                        <button class="btn tab-btn active" data-tab="assignment">城主配置</button>
                        <button class="btn tab-btn" data-tab="roles">役職設定</button>
                        <button class="btn tab-btn" data-tab="army">軍団編成</button>
                        <button class="btn tab-btn" data-tab="reward">下賜</button>
                        <button class="btn tab-btn" data-tab="list">武将一覧</button>
                    </div>
                    <div id="tab-assignment" class="tab-content active">
                        <h3>城主配置</h3>
                        <div id="territory-assignment-list"></div>
                    </div>
                    <div id="tab-roles" class="tab-content">
                        <h3>役職設定</h3>
                        <div class="current-roles-display">
                            <h4>現在の役職設定</h4>
                            <div id="current-roles-list"></div>
                        </div>
                        <div class="role-settings">
                            <div style="color: #ff6666; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid #666; padding-bottom: 8px;">重要役職</div>
                            <div class="role-group"><label>参謀:</label><select id="strategist-select"><option value="">未設定</option></select></div>
                            <div class="role-group"><label>外交担当:</label><select id="diplomat-select"><option value="">未設定</option></select></div>
                            <div class="role-group"><label>人事総監:</label><select id="administrator-select"><option value="">未設定</option></select></div>
                            
                            <div style="color: #66ff66; margin: 20px 0 15px 0; font-weight: bold; border-bottom: 1px solid #666; padding-bottom: 8px;">奉行職</div>
                            <div class="role-group"><label>検地奉行:</label><select id="kenchi-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">農業向上(政治)</span></div>
                            <div class="role-group"><label>米奉行:</label><select id="rice-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">米増産(政治)</span></div>
                            <div class="role-group"><label>町奉行:</label><select id="town-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">商業発展(政治)</span></div>
                            <div class="role-group"><label>金奉行:</label><select id="gold-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">収入増加(政治)</span></div>
                            <div class="role-group"><label>普請奉行:</label><select id="construction-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">城壁強化(統率)</span></div>
                            <div class="role-group"><label>兵奉行:</label><select id="military-commissioner-select"><option value="">未設定</option></select><span style="color: #ccc; font-size: 10px; margin-left: 10px;">兵力増強(戦闘)</span></div>
                        </div>
                    </div>
                    <div id="tab-army" class="tab-content">
                        <h3>軍団編成</h3>
                        <div class="current-army-display">
                            <h4>現在の編成</h4>
                            <div id="current-army-formation"></div>
                        </div>
                        <div class="army-formation">
                            <div class="formation-grid">
                                <div class="formation-position"><label>大将:</label><div class="position-info"><span id="general-name">[大名固定]</span></div></div>
                                <div class="formation-position"><label>軍師:</label><select id="army-strategist"><option value="">未設定</option></select></div>
                                <div class="formation-position"><label>前衛:</label><select id="vanguard"><option value="">未設定</option></select></div>
                                <div class="formation-position"><label>右翼:</label><select id="right-wing"><option value="">未設定</option></select></div>
                                <div class="formation-position"><label>左翼:</label><select id="left-wing"><option value="">未設定</option></select></div>
                                <div class="formation-position"><label>後詰:</label><select id="reserve"><option value="">未設定</option></select></div>
                            </div>
                            <div class="army-stats">
                                <h4>軍団戦力</h4>
                                <div class="power-display">
                                    <div class="power-item"><span>攻撃力:</span><span id="army-attack" class="power-value">0</span></div>
                                    <div class="power-item"><span>防御力:</span><span id="army-defense" class="power-value">0</span></div>
                                    <div class="power-item"><span>知謀力:</span><span id="army-intelligence" class="power-value">0</span></div>
                                    <div class="total-power"><span>総合戦力:</span><span id="total-army-power" class="total-value">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-reward" class="tab-content">
                        <h3>下賜</h3>
                        <div class="recruit-info">
                            <h4>下賜について</h4>
                            <p>・金100を使用して武将の忠誠度を25上昇させます</p>
                            <p>・忠誠度は最大100まで上昇します</p>
                            <p>・忠誠度が高い武将ほど裏切りにくくなります</p>
                        </div>
                        <div id="reward-generals-list"></div>
                    </div>
                    <div id="tab-list" class="tab-content">
                        <h3>配下武将一覧</h3>
                        <div id="generals-list"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn" id="generals-cancel-btn">閉じる</button>
                    <button class="btn" id="generals-reset-btn">再編成</button>
                    <button class="btn primary" id="generals-save-btn">設定保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ゲーム状態管理
        class GameState {
            constructor() {
                this.turn = 1;
                this.playerDaimyo = null;
                this.selectedTerritory = null;
                this.attackUsed = false; // 出兵使用フラグ
                this.diplomacyUsed = false; // 外交使用フラグ
                this.strategyUsed = false; // 謀略使用フラグ
                this.rumorDefenseActive = false; // 虚報防御発動フラグ
                this.rumorActivationRate = 0; // 虚報発動率
                this.territories = [];
                this.generals = [];
                this.daimyos = [];
                this.turnEvents = [];
                this.personnelEvents = []; // 人事ログ用
                this.gameLog = [];
                this.diplomacyTreaties = {}; // 外交協定管理 {daimyoId: [相手のdaimyoId配列]}
                this.playerRoles = {
                    strategist: null,
                    diplomat: null,
                    administrator: null,
                    kenchiCommissioner: null, // 検地奉行
                    riceCommissioner: null, // 米奉行
                    townCommissioner: null, // 町奉行
                    goldCommissioner: null, // 金奉行
                    constructionCommissioner: null, // 普請奉行
                    militaryCommissioner: null, // 兵奉行
                    armyStrategist: null,
                    vanguard: null,
                    rightWing: null,
                    leftWing: null,
                    reserve: null
                };
                this.aiRoles = {}; // AI大名の役職設定
                this.availableGenerals = []; // 登用可能な武将
                this.yamashiroControl = {}; // 山城支配ターン数管理 {daimyoId: turnCount}
                this.tenkaninStatus = {}; // 天下人認定状況 {daimyoId: boolean}
                this.init();
            }
            
            init() {
                this.initializeDaimyos();
                this.initializeGenerals();
                this.initializeAvailableGenerals();
                this.initializeTerritories();
                this.setupAIGenerals();
            }
            
            initializeDaimyos() {
                this.daimyos = [
                    {
                        id: 'oda',
                        name: '織田信長',
                        stats: { battle: 85, command: 88, politics: 95, intelligence: 90, charm: 85 },
                        skill: '革新者',
                        startTerritory: 'owari',
                        preferredUnit: 'arquebus', // 鉄砲
                        gold: 1500,
                        rice: 800,
                        color: '#ff6666'
                    },
                    {
                        id: 'takeda',
                        name: '武田信玄',
                        stats: { battle: 90, command: 95, politics: 91, intelligence: 93, charm: 94 },
                        skill: '風林火山',
                        startTerritory: 'kai',
                        preferredUnit: 'cavalry', // 騎馬
                        gold: 1200,
                        rice: 700,
                        color: '#ff9999'
                    },
                    {
                        id: 'uesugi',
                        name: '上杉謙信',
                        stats: { battle: 100, command: 96, politics: 78, intelligence: 82, charm: 95 },
                        skill: '軍神',
                        startTerritory: 'shinano',
                        preferredUnit: 'infantry', // 歩兵
                        gold: 1000,
                        rice: 600,
                        color: '#ffcc99'
                    },
                    {
                        id: 'tokugawa',
                        name: '徳川家康',
                        stats: { battle: 85, command: 90, politics: 92, intelligence: 88, charm: 85 },
                        skill: '忍耐',
                        startTerritory: 'mikawa',
                        preferredUnit: 'infantry', // 歩兵
                        gold: 1300,
                        rice: 750,
                        color: '#99ff99'
                    },
                    {
                        id: 'hojo',
                        name: '北条氏康',
                        stats: { battle: 86, command: 90, politics: 91, intelligence: 88, charm: 90 },
                        skill: '関東制覇',
                        startTerritory: 'kaga',
                        preferredUnit: 'infantry', // 歩兵
                        gold: 1200,
                        rice: 700,
                        color: '#99ffff'
                    },
                    {
                        id: 'mori',
                        name: '毛利元就',
                        stats: { battle: 78, command: 84, politics: 90, intelligence: 99, charm: 89 },
                        skill: '謀将',
                        startTerritory: 'aki',
                        preferredUnit: 'arquebus', // 鉄砲
                        gold: 1000,
                        rice: 600,
                        color: '#9999ff'
                    },
                    {
                        id: 'otomo',
                        name: '大友宗麟',
                        stats: { battle: 75, command: 80, politics: 85, intelligence: 78, charm: 80 },
                        skill: '南蛮貿易',
                        startTerritory: 'suruga',
                        preferredUnit: 'arquebus', // 鉄砲
                        gold: 1400,
                        rice: 700,
                        color: '#ff99ff'
                    },
                    {
                        id: 'shimazu',
                        name: '島津義久',
                        stats: { battle: 78, command: 88, politics: 93, intelligence: 82, charm: 91 },
                        skill: '薩摩隼人',
                        startTerritory: 'bungo',
                        preferredUnit: 'cavalry', // 騎馬
                        gold: 900,
                        rice: 500,
                        color: '#ffff99'
                    },
                    {
                        id: 'date',
                        name: '伊達政宗',
                        stats: { battle: 90, command: 88, politics: 82, intelligence: 85, charm: 92 },
                        skill: '独眼竜',
                        startTerritory: 'mutsu',
                        preferredUnit: 'cavalry', // 騎馬
                        gold: 1000,
                        rice: 550,
                        color: '#ccccff'
                    },
                    {
                        id: 'sanada',
                        name: '真田昌幸',
                        stats: { battle: 78, command: 86, politics: 80, intelligence: 96, charm: 89 },
                        skill: '表裏比興',
                        startTerritory: 'echigo',
                        preferredUnit: 'infantry', // 歩兵
                        gold: 800,
                        rice: 450,
                        color: '#cc9966'
                    },
                    {
                        id: 'hashiba',
                        name: '羽柴秀吉',
                        stats: { battle: 85, command: 90, politics: 95, intelligence: 88, charm: 98 },
                        skill: '天下人',
                        startTerritory: 'harima',
                        preferredUnit: 'arquebus', // 鉄砲
                        gold: 1600,
                        rice: 900,
                        color: '#ffcc33'
                    },
                    {
                        id: 'ryuzoji',
                        name: '龍造寺隆信',
                        stats: { battle: 85, command: 88, politics: 82, intelligence: 85, charm: 80 },
                        skill: '肥前の熊',
                        startTerritory: 'hizen',
                        preferredUnit: 'arquebus', // 鉄砲
                        gold: 1100,
                        rice: 600,
                        color: '#66cc99'
                    }
                ];
            }
            
            initializeAvailableGenerals() {
                // 初期は浪人なし
                this.availableGenerals = [];
                
                // 通常浪人プール
                this.normalRonin = [
                    { id: 'ishida_mitsunari', name: '石田三成', stats: { battle: 56, command: 68, politics: 92, intelligence: 78, charm: 78 }, skill: '行政の鬼', recruitCost: 100, baseCharm: 60 },
                    { id: 'kato_kiyomasa', name: '加藤清正', stats: { battle: 86, command: 76, politics: 75, intelligence: 63, charm: 82 }, skill: '築城名人', recruitCost: 100, baseCharm: 70 },
                    { id: 'fukushima_masanori', name: '福島正則', stats: { battle: 87, command: 78, politics: 60, intelligence: 62, charm: 68 }, skill: '猛将', recruitCost: 100, baseCharm: 75 },
                    { id: 'yamanaka_shikanosuke', name: '山中鹿之介', stats: { battle: 84, command: 85, politics: 71, intelligence: 89, charm: 79 }, skill: '七難八苦', recruitCost: 100, baseCharm: 75 },
                    { id: 'akai_naomasa', name: '赤井直正', stats: { battle: 82, command: 81, politics: 68, intelligence: 75, charm: 80 }, skill: '丹波の赤鬼', recruitCost: 100, baseCharm: 70 },
                    { id: 'matsunaga_hisahide', name: '松永久秀', stats: { battle: 77, command: 79, politics: 82, intelligence: 90, charm: 75 }, skill: '梟雄', recruitCost: 100, baseCharm: 65 },
                    { id: 'gamo_ujisato', name: '蒲生氏郷', stats: { battle: 81, command: 85, politics: 84, intelligence: 86, charm: 83 }, skill: '会津の麒麟児', recruitCost: 100, baseCharm: 80 },
                    { id: 'saiga_magoichi', name: '雑賀孫一', stats: { battle: 89, command: 80, politics: 70, intelligence: 78, charm: 81 }, skill: '鉄砲大将', recruitCost: 100, baseCharm: 75 },
                    { id: 'shima_sakon', name: '島左近', stats: { battle: 87, command: 88, politics: 72, intelligence: 79, charm: 88 }, skill: '鬼左近', recruitCost: 100, baseCharm: 70 },
                    { id: 'otani_yoshitsugu', name: '大谷吉継', stats: { battle: 85, command: 89, politics: 78, intelligence: 82, charm: 86 }, skill: '白頭巾', recruitCost: 100, baseCharm: 75 },
                    { id: 'goto_matabei', name: '後藤又兵衛', stats: { battle: 88, command: 79, politics: 58, intelligence: 66, charm: 77 }, skill: '黒母衣衆', recruitCost: 100, baseCharm: 65 },
                    { id: 'watanabe_kanbei', name: '渡辺勘兵衛', stats: { battle: 85, command: 74, politics: 49, intelligence: 52, charm: 78 }, skill: '渡辺の槍', recruitCost: 100, baseCharm: 70 },
                    { id: 'kimura_shigenari', name: '木村重成', stats: { battle: 85, command: 78, politics: 65, intelligence: 72, charm: 88 }, skill: '若武者', recruitCost: 100, baseCharm: 75 },
                    { id: 'sue_harutaka', name: '陶晴賢', stats: { battle: 80, command: 76, politics: 72, intelligence: 78, charm: 66 }, skill: '謀反の将', recruitCost: 100, baseCharm: 70 },
                    { id: 'ota_sukemasa', name: '太田資正', stats: { battle: 77, command: 74, politics: 68, intelligence: 80, charm: 64 }, skill: '関東の驍将', recruitCost: 100, baseCharm: 65 },
                    { id: 'tsugaru_tamenobu', name: '津軽為信', stats: { battle: 74, command: 72, politics: 84, intelligence: 82, charm: 72 }, skill: '奥州の梟雄', recruitCost: 100, baseCharm: 75 },
                    { id: 'akaike_nagato', name: '赤池長任', stats: { battle: 84, command: 76, politics: 60, intelligence: 70, charm: 66 }, skill: '越後武士', recruitCost: 100, baseCharm: 70 },
                    { id: 'kuroda_nagamasa', name: '黒田長政', stats: { battle: 81, command: 83, politics: 78, intelligence: 72, charm: 84 }, skill: '如水の子', recruitCost: 100, baseCharm: 80 },
                    { id: 'konishi_yukinaga', name: '小西行長', stats: { battle: 68, command: 70, politics: 84, intelligence: 72, charm: 70 }, skill: '南蛮商人', recruitCost: 100, baseCharm: 75 },
                    { id: 'kanamori_nagachika', name: '金森長近', stats: { battle: 60, command: 62, politics: 78, intelligence: 76, charm: 70 }, skill: '飛騨守', recruitCost: 100, baseCharm: 70 },
                    { id: 'kani_yoshinaga', name: '可児吉長', stats: { battle: 84, command: 74, politics: 52, intelligence: 60, charm: 72 }, skill: '笹の才蔵', recruitCost: 100, baseCharm: 65 },
                    { id: 'inaba_ittetsu', name: '稲葉一鉄', stats: { battle: 78, command: 72, politics: 66, intelligence: 64, charm: 66 }, skill: '美濃三人衆', recruitCost: 100, baseCharm: 70 },
                    { id: 'ando_morinari', name: '安藤守就', stats: { battle: 70, command: 74, politics: 74, intelligence: 68, charm: 74 }, skill: '美濃三人衆', recruitCost: 100, baseCharm: 70 },
                    { id: 'ujiie_bokuzen', name: '氏家卜全', stats: { battle: 77, command: 75, politics: 68, intelligence: 63, charm: 66 }, skill: '美濃三人衆', recruitCost: 100, baseCharm: 70 },
                    { id: 'kuki_yoshitaka', name: '九鬼嘉隆', stats: { battle: 74, command: 80, politics: 66, intelligence: 68, charm: 72 }, skill: '水軍大将', recruitCost: 100, baseCharm: 75 },
                    { id: 'todo_takatora', name: '藤堂高虎', stats: { battle: 78, command: 87, politics: 82, intelligence: 79, charm: 80 }, skill: '築城の名手', recruitCost: 100, baseCharm: 80 }
                ];
                
                // レア浪人プール
                this.rareRonin = [
                    { id: 'shirai_tanenao', name: '白井胤治', stats: { battle: 75, command: 92, politics: 85, intelligence: 98, charm: 88 }, skill: '臼井の奇策', recruitCost: 100, baseCharm: 75 },
                    { id: 'maeda_keiji', name: '前田慶次', stats: { battle: 90, command: 80, politics: 60, intelligence: 75, charm: 95 }, skill: '傾奇者', recruitCost: 100, baseCharm: 85 },
                    { id: 'miyamoto_musashi', name: '宮本武蔵', stats: { battle: 94, command: 70, politics: 30, intelligence: 69, charm: 75 }, skill: '二刀流', recruitCost: 100, baseCharm: 90 },
                    { id: 'yagyu_jubei', name: '柳生十兵衛', stats: { battle: 93, command: 65, politics: 60, intelligence: 68, charm: 80 }, skill: '隻眼の剣士', recruitCost: 100, baseCharm: 80 },
                    { id: 'asakura_soteki', name: '朝倉宗滴', stats: { battle: 90, command: 92, politics: 69, intelligence: 77, charm: 88 }, skill: '一乗谷の鬼', recruitCost: 100, baseCharm: 75 },
                    { id: 'taigen_sessai', name: '太原雪斎', stats: { battle: 70, command: 88, politics: 96, intelligence: 91, charm: 87 }, skill: '今川軍師', recruitCost: 100, baseCharm: 80 }
                ];
            }
            
            initializeGenerals() {
                this.generals = [
                    // 織田家
                    { id: 'akechi', name: '明智光秀', lord: 'oda', stats: { battle: 78, command: 89, politics: 87, intelligence: 91, charm: 80 }, skill: '謀反', loyalty: 70 },
                    { id: 'shibata', name: '柴田勝家', lord: 'oda', stats: { battle: 90, command: 85, politics: 69, intelligence: 66, charm: 74 }, skill: '鬼柴田', loyalty: 90 },
                    { id: 'niwa', name: '丹羽長秀', lord: 'oda', stats: { battle: 79, command: 80, politics: 84, intelligence: 77, charm: 84 }, skill: '米五郎左', loyalty: 95 },
                    { id: 'takigawa', name: '滝川一益', lord: 'oda', stats: { battle: 86, command: 75, politics: 76, intelligence: 78, charm: 76 }, skill: '関東管領', loyalty: 88 },
                    { id: 'sassa', name: '佐々成政', lord: 'oda', stats: { battle: 85, command: 77, politics: 60, intelligence: 68, charm: 68 }, skill: '黒母衣衆', loyalty: 90 },
                    { id: 'maeda_toshiie', name: '前田利家', lord: 'oda', stats: { battle: 84, command: 76, politics: 88, intelligence: 72, charm: 88 }, skill: '槍の又左', loyalty: 92 },
                    { id: 'mori_ranmaru', name: '森蘭丸', lord: 'oda', stats: { battle: 76, command: 72, politics: 66, intelligence: 70, charm: 84 }, skill: '小姓頭', loyalty: 99 },
                    { id: 'ikeda', name: '池田恒興', lord: 'oda', stats: { battle: 72, command: 78, politics: 70, intelligence: 65, charm: 74 }, skill: '乳兄弟', loyalty: 95 },
                    { id: 'hosokawa_fujitaka', name: '細川藤孝', lord: 'oda', stats: { battle: 70, command: 76, politics: 88, intelligence: 87, charm: 78 }, skill: '幽斎', loyalty: 80 },
                    { id: 'oda_nobutada', name: '織田信忠', lord: 'oda', stats: { battle: 82, command: 84, politics: 74, intelligence: 76, charm: 87 }, skill: '嫡男', loyalty: 99 },
                    { id: 'murai_sadakatsu', name: '村井貞勝', lord: 'oda', stats: { battle: 50, command: 56, politics: 86, intelligence: 78, charm: 64 }, skill: '京都所司代', loyalty: 95 },
                    
                    // 武田家
                    { id: 'takeda_nobushige', name: '武田信繁', lord: 'takeda', stats: { battle: 84, command: 88, politics: 78, intelligence: 79, charm: 92 }, skill: '副将', loyalty: 99 },
                    { id: 'takeda_katsuyori', name: '武田勝頼', lord: 'takeda', stats: { battle: 86, command: 82, politics: 60, intelligence: 68, charm: 72 }, skill: '諏訪勝頼', loyalty: 95 },
                    { id: 'takeda_nobukado', name: '武田信廉', lord: 'takeda', stats: { battle: 60, command: 68, politics: 74, intelligence: 72, charm: 66 }, skill: '影武者', loyalty: 95 },
                    { id: 'yamagata', name: '山県昌景', lord: 'takeda', stats: { battle: 93, command: 90, politics: 69, intelligence: 70, charm: 84 }, skill: '赤備え', loyalty: 90 },
                    { id: 'baba', name: '馬場信春', lord: 'takeda', stats: { battle: 90, command: 92, politics: 74, intelligence: 76, charm: 82 }, skill: '不死身', loyalty: 92 },
                    { id: 'naito', name: '内藤昌豊', lord: 'takeda', stats: { battle: 88, command: 85, politics: 58, intelligence: 68, charm: 79 }, skill: '武田四天王', loyalty: 90 },
                    { id: 'kosaka', name: '高坂昌信', lord: 'takeda', stats: { battle: 84, command: 93, politics: 70, intelligence: 82, charm: 84 }, skill: '逃げ弾正', loyalty: 95 },
                    { id: 'oyamada', name: '小山田信茂', lord: 'takeda', stats: { battle: 78, command: 74, politics: 64, intelligence: 68, charm: 66 }, skill: '郡内領主', loyalty: 65 },
                    { id: 'amari', name: '甘利虎泰', lord: 'takeda', stats: { battle: 82, command: 80, politics: 55, intelligence: 65, charm: 70 }, skill: '武田重臣', loyalty: 88 },
                    { id: 'yamamoto_kansuke', name: '山本勘助', lord: 'takeda', stats: { battle: 81, command: 76, politics: 72, intelligence: 94, charm: 69 }, skill: '啄木鳥戦法', loyalty: 95 },
                    { id: 'hara_toratane', name: '原虎胤', lord: 'takeda', stats: { battle: 89, command: 84, politics: 50, intelligence: 60, charm: 68 }, skill: '武田宿老', loyalty: 92 },
                    { id: 'iitomi_toramasa', name: '飯富虎昌', lord: 'takeda', stats: { battle: 86, command: 80, politics: 52, intelligence: 60, charm: 80 }, skill: '赤備えの祖', loyalty: 90 },
                    { id: 'sanada_yukitaka', name: '真田幸隆', lord: 'takeda', stats: { battle: 72, command: 78, politics: 68, intelligence: 92, charm: 76 }, skill: '攻め弾正', loyalty: 88 },
                    { id: 'nagasaka_chokansai', name: '長坂釣閑斎', lord: 'takeda', stats: { battle: 69, command: 78, politics: 83, intelligence: 79, charm: 68 }, skill: '武田軍学', loyalty: 90 },
                    { id: 'itagaki_nobukata', name: '板垣信方', lord: 'takeda', stats: { battle: 74, command: 82, politics: 80, intelligence: 72, charm: 75 }, skill: '甲州法度', loyalty: 95 },
                    { id: 'anayama_baisetsu', name: '穴山梅雪', lord: 'takeda', stats: { battle: 61, command: 70, politics: 80, intelligence: 76, charm: 67 }, skill: '河内守', loyalty: 75 },
                    { id: 'akiyama_torashige', name: '秋山虎繁', lord: 'takeda', stats: { battle: 79, command: 76, politics: 68, intelligence: 71, charm: 72 }, skill: '岩村城主', loyalty: 88 },
                    { id: 'nishina_morinobu', name: '仁科盛信', lord: 'takeda', stats: { battle: 78, command: 77, politics: 50, intelligence: 62, charm: 72 }, skill: '高遠城主', loyalty: 99 },
                    { id: 'tsuchiya_masatsune', name: '土屋昌恒', lord: 'takeda', stats: { battle: 80, command: 76, politics: 45, intelligence: 58, charm: 64 }, skill: '片手千人斬', loyalty: 92 },
                    
                    // 上杉家
                    { id: 'naoe', name: '直江兼続', lord: 'uesugi', stats: { battle: 78, command: 85, politics: 94, intelligence: 91, charm: 90 }, skill: '愛の字', loyalty: 95 },
                    { id: 'naoe_kagetsuna', name: '直江景綱', lord: 'uesugi', stats: { battle: 70, command: 76, politics: 84, intelligence: 82, charm: 75 }, skill: '上杉執政', loyalty: 95 },
                    { id: 'kakizaki', name: '柿崎景家', lord: 'uesugi', stats: { battle: 86, command: 82, politics: 68, intelligence: 70, charm: 72 }, skill: '先陣', loyalty: 88 },
                    { id: 'uesugi_kagekatsu', name: '上杉景勝', lord: 'uesugi', stats: { battle: 76, command: 82, politics: 85, intelligence: 84, charm: 95 }, skill: '無言', loyalty: 99 },
                    { id: 'nagano_narimasa', name: '長野業正', lord: 'uesugi', stats: { battle: 84, command: 96, politics: 78, intelligence: 80, charm: 85 }, skill: '上野の黄斑', loyalty: 88 },
                    { id: 'irobe', name: '色部勝長', lord: 'uesugi', stats: { battle: 74, command: 78, politics: 70, intelligence: 72, charm: 68 }, skill: '色部勢', loyalty: 90 },
                    { id: 'honjo', name: '本庄繁長', lord: 'uesugi', stats: { battle: 80, command: 76, politics: 66, intelligence: 70, charm: 70 }, skill: '本庄勢', loyalty: 85 },
                    { id: 'saito_tomonobu', name: '斎藤朝信', lord: 'uesugi', stats: { battle: 77, command: 76, politics: 68, intelligence: 74, charm: 69 }, skill: '下越守護', loyalty: 88 },
                    { id: 'shibata_shigeie', name: '新発田重家', lord: 'uesugi', stats: { battle: 82, command: 74, politics: 60, intelligence: 66, charm: 65 }, skill: '新発田勢', loyalty: 70 },
                    { id: 'murakami', name: '村上義清', lord: 'uesugi', stats: { battle: 88, command: 84, politics: 64, intelligence: 70, charm: 74 }, skill: '信濃武士', loyalty: 85 },
                    { id: 'usami_sadamitsu', name: '宇佐見定満', lord: 'uesugi', stats: { battle: 65, command: 70, politics: 88, intelligence: 92, charm: 76 }, skill: '上杉重臣', loyalty: 92 },
                    { id: 'onijima_yatarou', name: '鬼小島弥太郎', lord: 'uesugi', stats: { battle: 94, command: 75, politics: 40, intelligence: 50, charm: 60 }, skill: '鬼小島', loyalty: 95 },
                    
                    // 徳川家
                    { id: 'honda_tadakatsu', name: '本多忠勝', lord: 'tokugawa', stats: { battle: 97, command: 85, politics: 55, intelligence: 60, charm: 88 }, skill: '無傷', loyalty: 95 },
                    { id: 'sakai', name: '酒井忠次', lord: 'tokugawa', stats: { battle: 76, command: 79, politics: 81, intelligence: 75, charm: 74 }, skill: '宿老', loyalty: 95 },
                    { id: 'ishikawa', name: '石川数正', lord: 'tokugawa', stats: { battle: 65, command: 72, politics: 84, intelligence: 86, charm: 65 }, skill: '調整', loyalty: 75 },
                    { id: 'sakakibara', name: '榊原康政', lord: 'tokugawa', stats: { battle: 82, command: 84, politics: 77, intelligence: 72, charm: 76 }, skill: '徳川四天王', loyalty: 95 },
                    { id: 'ii_naomasa', name: '井伊直政', lord: 'tokugawa', stats: { battle: 84, command: 83, politics: 78, intelligence: 70, charm: 87 }, skill: '赤鬼', loyalty: 95 },
                    { id: 'matsudaira_nobutsuna', name: '松平信綱', lord: 'tokugawa', stats: { battle: 66, command: 74, politics: 88, intelligence: 90, charm: 89 }, skill: '知恵伊豆', loyalty: 90 },
                    { id: 'okubo', name: '大久保忠世', lord: 'tokugawa', stats: { battle: 78, command: 76, politics: 70, intelligence: 68, charm: 68 }, skill: '三河武士', loyalty: 95 },
                    { id: 'hiraiwa', name: '平岩親吉', lord: 'tokugawa', stats: { battle: 70, command: 72, politics: 66, intelligence: 65, charm: 64 }, skill: '徳川譜代', loyalty: 95 },
                    { id: 'torii', name: '鳥居元忠', lord: 'tokugawa', stats: { battle: 80, command: 78, politics: 60, intelligence: 62, charm: 86 }, skill: '伏見城', loyalty: 99 },
                    { id: 'hattori', name: '服部半蔵', lord: 'tokugawa', stats: { battle: 84, command: 70, politics: 55, intelligence: 83, charm: 60 }, skill: '忍者頭', loyalty: 90 },
                    
                    // 北条家
                    { id: 'hojo_ujiteru', name: '北条氏照', lord: 'hojo', stats: { battle: 79, command: 80, politics: 72, intelligence: 74, charm: 76 }, skill: '滝山城主', loyalty: 95 },
                    { id: 'hojo_ujikuni', name: '北条氏邦', lord: 'hojo', stats: { battle: 78, command: 79, politics: 68, intelligence: 70, charm: 72 }, skill: '鉢形城主', loyalty: 95 },
                    { id: 'toyama_tsunakage', name: '遠山綱景', lord: 'hojo', stats: { battle: 76, command: 78, politics: 65, intelligence: 68, charm: 66 }, skill: '上野衆', loyalty: 88 },
                    { id: 'hojo_ujimasa', name: '北条氏政', lord: 'hojo', stats: { battle: 72, command: 78, politics: 74, intelligence: 76, charm: 84 }, skill: '継承者', loyalty: 95 },
                    { id: 'matsuda', name: '松田憲秀', lord: 'hojo', stats: { battle: 66, command: 72, politics: 80, intelligence: 78, charm: 64 }, skill: '内政', loyalty: 88 },
                    { id: 'hojo_ujinao', name: '北条氏直', lord: 'hojo', stats: { battle: 70, command: 74, politics: 76, intelligence: 74, charm: 80 }, skill: '若殿', loyalty: 95 },
                    { id: 'daidoji', name: '大道寺政繁', lord: 'hojo', stats: { battle: 82, command: 84, politics: 68, intelligence: 72, charm: 78 }, skill: '関東の鬼', loyalty: 90 },
                    { id: 'narita', name: '成田氏長', lord: 'hojo', stats: { battle: 80, command: 78, politics: 66, intelligence: 70, charm: 68 }, skill: '忍城主', loyalty: 85 },
                    { id: 'ota_ujisuke', name: '太田氏資', lord: 'hojo', stats: { battle: 68, command: 72, politics: 78, intelligence: 80, charm: 66 }, skill: '江戸城主', loyalty: 88 },
                    { id: 'shimizu', name: '清水康英', lord: 'hojo', stats: { battle: 64, command: 68, politics: 74, intelligence: 76, charm: 62 }, skill: '北条重臣', loyalty: 90 },
                    { id: 'hojo_tsunashige', name: '北条綱成', lord: 'hojo', stats: { battle: 91, command: 88, politics: 60, intelligence: 65, charm: 78 }, skill: '地黄八幡', loyalty: 95 },
                    { id: 'fuma_kotaro', name: '風魔小太郎', lord: 'hojo', stats: { battle: 82, command: 70, politics: 50, intelligence: 85, charm: 60 }, skill: '風魔忍術', loyalty: 88 },
                    { id: 'itabeoka_sessai', name: '板部岡江雪斎', lord: 'hojo', stats: { battle: 58, command: 66, politics: 86, intelligence: 74, charm: 72 }, skill: '外交僧', loyalty: 90 },
                    { id: 'hojo_genan', name: '北条玄庵', lord: 'hojo', stats: { battle: 52, command: 64, politics: 85, intelligence: 81, charm: 87 }, skill: '名医', loyalty: 92 },
                    
                    // 毛利家
                    { id: 'mori_takamoto', name: '毛利隆元', lord: 'mori', stats: { battle: 72, command: 78, politics: 82, intelligence: 80, charm: 83 }, skill: '嫡男', loyalty: 99 },
                    { id: 'mori_terumoto', name: '毛利輝元', lord: 'mori', stats: { battle: 66, command: 74, politics: 85, intelligence: 76, charm: 82 }, skill: '中国大名', loyalty: 98 },
                    { id: 'kobayakawa', name: '小早川隆景', lord: 'mori', stats: { battle: 78, command: 86, politics: 90, intelligence: 92, charm: 91 }, skill: '両川', loyalty: 90 },
                    { id: 'kikkawa', name: '吉川元春', lord: 'mori', stats: { battle: 91, command: 88, politics: 70, intelligence: 74, charm: 81 }, skill: '勇猛', loyalty: 92 },
                    { id: 'ankokuji', name: '安国寺恵瓊', lord: 'mori', stats: { battle: 50, command: 62, politics: 88, intelligence: 90, charm: 70 }, skill: '外交僧', loyalty: 85 },
                    { id: 'fukuhara', name: '福原貞俊', lord: 'mori', stats: { battle: 72, command: 76, politics: 70, intelligence: 74, charm: 66 }, skill: '毛利重臣', loyalty: 90 },
                    { id: 'kuchiba', name: '口羽通良', lord: 'mori', stats: { battle: 74, command: 78, politics: 66, intelligence: 70, charm: 65 }, skill: '石見守護', loyalty: 88 },
                    { id: 'katsura', name: '桂元澄', lord: 'mori', stats: { battle: 76, command: 74, politics: 68, intelligence: 72, charm: 64 }, skill: '桂勢', loyalty: 85 },
                    { id: 'sugi', name: '椙杜隆康', lord: 'mori', stats: { battle: 70, command: 68, politics: 60, intelligence: 65, charm: 62 }, skill: '山陰道', loyalty: 88 },
                    { id: 'shimizu_muneharu', name: '清水宗治', lord: 'mori', stats: { battle: 80, command: 82, politics: 62, intelligence: 68, charm: 85 }, skill: '忠義の士', loyalty: 99 },
                    { id: 'fukuhara_hirotoshi', name: '福原広俊', lord: 'mori', stats: { battle: 68, command: 72, politics: 70, intelligence: 72, charm: 66 }, skill: '毛利家老', loyalty: 88 },
                    { id: 'shishido_takaiie', name: '宍戸隆家', lord: 'mori', stats: { battle: 74, command: 73, politics: 64, intelligence: 68, charm: 63 }, skill: '宍戸勢', loyalty: 86 },
                    { id: 'kodama_narahide', name: '児玉就英', lord: 'mori', stats: { battle: 70, command: 70, politics: 58, intelligence: 66, charm: 60 }, skill: '備後衆', loyalty: 84 },
                    { id: 'amano_takashige', name: '天野隆重', lord: 'mori', stats: { battle: 72, command: 74, politics: 64, intelligence: 68, charm: 62 }, skill: '銀山衆', loyalty: 87 },
                    
                    // 大友家
                    { id: 'tachibana_dosetsu', name: '立花道雪', lord: 'otomo', stats: { battle: 88, command: 98, politics: 80, intelligence: 85, charm: 88 }, skill: '雷神', loyalty: 90 },
                    { id: 'takahashi', name: '高橋紹運', lord: 'otomo', stats: { battle: 85, command: 90, politics: 78, intelligence: 80, charm: 85 }, skill: '忠臣', loyalty: 95 },
                    { id: 'yoshihiro_akizuki', name: '吉弘鑑理', lord: 'otomo', stats: { battle: 74, command: 72, politics: 68, intelligence: 70, charm: 66 }, skill: '大友重臣', loyalty: 88 },
                    { id: 'usuki', name: '臼杵鑑速', lord: 'otomo', stats: { battle: 66, command: 70, politics: 72, intelligence: 68, charm: 64 }, skill: '豊後勢', loyalty: 90 },
                    { id: 'takita', name: '田北鑑重', lord: 'otomo', stats: { battle: 72, command: 70, politics: 58, intelligence: 62, charm: 62 }, skill: '肥後衆', loyalty: 85 },
                    { id: 'tsunokuma', name: '角隈石宗', lord: 'otomo', stats: { battle: 45, command: 58, politics: 86, intelligence: 79, charm: 84 }, skill: '豊後三老', loyalty: 88 },
                    { id: 'kai_soun', name: '甲斐宗運', lord: 'otomo', stats: { battle: 65, command: 72, politics: 76, intelligence: 85, charm: 76 }, skill: '立花道雪養子', loyalty: 92 },

                    { id: 'tachibana_muneshige', name: '立花宗茂', lord: 'otomo', stats: { battle: 95, command: 92, politics: 82, intelligence: 85, charm: 88 }, skill: '西国無双', loyalty: 90 },
                    
                    // 島津家
                    { id: 'shimazu_yoshihiro', name: '島津義弘', lord: 'shimazu', stats: { battle: 89, command: 95, politics: 75, intelligence: 80, charm: 92 }, skill: '鬼島津', loyalty: 95 },
                    { id: 'shimazu_iehisa', name: '島津家久', lord: 'shimazu', stats: { battle: 92, command: 89, politics: 68, intelligence: 76, charm: 80 }, skill: '智将', loyalty: 95 },
                    { id: 'shimazu_toyohisa', name: '島津豊久', lord: 'shimazu', stats: { battle: 81, command: 78, politics: 56, intelligence: 62, charm: 79 }, skill: '若武者', loyalty: 95 },
                    { id: 'niiro', name: '新納忠元', lord: 'shimazu', stats: { battle: 82, command: 78, politics: 60, intelligence: 64, charm: 68 }, skill: '薩摩勢', loyalty: 90 },
                    { id: 'ijuin', name: '伊集院忠棟', lord: 'shimazu', stats: { battle: 76, command: 74, politics: 65, intelligence: 68, charm: 66 }, skill: '島津重臣', loyalty: 85 },
                    { id: 'kabayama', name: '樺山久高', lord: 'shimazu', stats: { battle: 70, command: 72, politics: 72, intelligence: 70, charm: 64 }, skill: '樺山勢', loyalty: 88 },
                    { id: 'ei', name: '頴娃久虎', lord: 'shimazu', stats: { battle: 74, command: 70, politics: 58, intelligence: 60, charm: 62 }, skill: '薩摩武士', loyalty: 90 },
                    { id: 'shimazu_toshihisa', name: '島津歳久', lord: 'shimazu', stats: { battle: 86, command: 84, politics: 66, intelligence: 80, charm: 74 }, skill: '薩摩の副将', loyalty: 95 },
                    
                    // 伊達家
                    { id: 'katakura', name: '片倉景綱', lord: 'date', stats: { battle: 84, command: 88, politics: 75, intelligence: 82, charm: 85 }, skill: '軍師', loyalty: 95 },
                    { id: 'date_shigezane', name: '伊達成実', lord: 'date', stats: { battle: 90, command: 85, politics: 60, intelligence: 70, charm: 78 }, skill: '勇将', loyalty: 90 },
                    { id: 'shigeta', name: '留守政景', lord: 'date', stats: { battle: 68, command: 72, politics: 76, intelligence: 78, charm: 70 }, skill: '伊達重臣', loyalty: 88 },
                    { id: 'harada', name: '原田宗時', lord: 'date', stats: { battle: 78, command: 74, politics: 55, intelligence: 66, charm: 68 }, skill: '槍奉行', loyalty: 85 },
                    { id: 'shiroishi', name: '白石宗実', lord: 'date', stats: { battle: 72, command: 70, politics: 58, intelligence: 64, charm: 60 }, skill: '白石勢', loyalty: 88 },
                    { id: 'oniniwa', name: '鬼庭綱元', lord: 'date', stats: { battle: 82, command: 80, politics: 62, intelligence: 68, charm: 72 }, skill: '鬼庭勢', loyalty: 90 },
                    { id: 'endo', name: '遠藤基信', lord: 'date', stats: { battle: 60, command: 68, politics: 88, intelligence: 86, charm: 74 }, skill: '山形城主', loyalty: 85 },
                    
                    // 真田家
                    { id: 'sanada_nobuyuki', name: '真田信之', lord: 'sanada', stats: { battle: 70, command: 78, politics: 89, intelligence: 77, charm: 89 }, skill: '兄弟の絆', loyalty: 95 },
                    { id: 'sanada_yukimura', name: '真田幸村', lord: 'sanada', stats: { battle: 91, command: 98, politics: 70, intelligence: 88, charm: 91 }, skill: '日本一の兵', loyalty: 99 },
                    { id: 'sarutobi_sasuke', name: '猿飛佐助', lord: 'sanada', stats: { battle: 84, command: 74, politics: 50, intelligence: 82, charm: 70 }, skill: '忍術の極意', loyalty: 90 },
                    { id: 'kirigakure_saizo', name: '霧隠才蔵', lord: 'sanada', stats: { battle: 82, command: 72, politics: 48, intelligence: 80, charm: 68 }, skill: '霧隠れ', loyalty: 85 },
                    { id: 'anayama_kosuke', name: '穴山小助', lord: 'sanada', stats: { battle: 78, command: 70, politics: 46, intelligence: 68, charm: 64 }, skill: '十勇士', loyalty: 88 },
                    { id: 'unno_rokuro', name: '海野六郎', lord: 'sanada', stats: { battle: 80, command: 72, politics: 52, intelligence: 66, charm: 65 }, skill: '十勇士', loyalty: 90 },
                    { id: 'nezu_jinpachi', name: '根津甚八', lord: 'sanada', stats: { battle: 76, command: 68, politics: 44, intelligence: 64, charm: 62 }, skill: '十勇士', loyalty: 92 },
                    { id: 'yuri_kamanosuke', name: '由利鎌之助', lord: 'sanada', stats: { battle: 78, command: 70, politics: 48, intelligence: 66, charm: 63 }, skill: '十勇士', loyalty: 87 },
                    { id: 'kakei_juzo', name: '筧十蔵', lord: 'sanada', stats: { battle: 75, command: 70, politics: 60, intelligence: 68, charm: 66 }, skill: '十勇士', loyalty: 89 },
                    { id: 'mochizuki_rokuro', name: '望月六郎', lord: 'sanada', stats: { battle: 72, command: 66, politics: 54, intelligence: 64, charm: 60 }, skill: '十勇士', loyalty: 85 },
                    { id: 'miyoshi_isa', name: '三好伊三', lord: 'sanada', stats: { battle: 74, command: 68, politics: 50, intelligence: 65, charm: 62 }, skill: '十勇士', loyalty: 88 },
                    { id: 'miyoshi_seikai', name: '三好清海', lord: 'sanada', stats: { battle: 76, command: 70, politics: 46, intelligence: 60, charm: 61 }, skill: '十勇士', loyalty: 90 },
                    
                    // 羽柴家
                    { id: 'takenaka_hanbei_h', name: '竹中半兵衛', lord: 'hashiba', stats: { battle: 68, command: 78, politics: 77, intelligence: 100, charm: 75 }, skill: '天才軍師', loyalty: 95 },
                    { id: 'kuroda_kanbei_h', name: '黒田官兵衛', lord: 'hashiba', stats: { battle: 80, command: 82, politics: 87, intelligence: 96, charm: 84 }, skill: '軍師の才', loyalty: 90 },
                    { id: 'hachisuka_masakatsu_h', name: '蜂須賀正勝', lord: 'hashiba', stats: { battle: 80, command: 78, politics: 70, intelligence: 74, charm: 76 }, skill: '蜂須賀小六', loyalty: 95 },
                    { id: 'hashiba_hidenaga', name: '羽柴秀長', lord: 'hashiba', stats: { battle: 75, command: 85, politics: 90, intelligence: 88, charm: 89 }, skill: '大和大納言', loyalty: 99 },
                    { id: 'asano_nagamasa', name: '浅野長政', lord: 'hashiba', stats: { battle: 66, command: 70, politics: 82, intelligence: 79, charm: 78 }, skill: '五奉行', loyalty: 92 },
                    { id: 'mashita_nagamori', name: '増田長盛', lord: 'hashiba', stats: { battle: 60, command: 68, politics: 84, intelligence: 77, charm: 70 }, skill: '五奉行', loyalty: 88 },
                    { id: 'natsuka_masaie', name: '長束正家', lord: 'hashiba', stats: { battle: 58, command: 66, politics: 86, intelligence: 78, charm: 68 }, skill: '五奉行', loyalty: 85 },
                    { id: 'maeno_nagayasu', name: '前野長康', lord: 'hashiba', stats: { battle: 74, command: 72, politics: 70, intelligence: 68, charm: 66 }, skill: '豊臣家臣', loyalty: 90 },
                    
                    // 龍造寺家
                    { id: 'nabeshima_naoshige_r', name: '鍋島直茂', lord: 'ryuzoji', stats: { battle: 82, command: 88, politics: 86, intelligence: 88, charm: 84 }, skill: '化け猫騒動', loyalty: 85 },
                    { id: 'ryuzoji_masaie', name: '龍造寺政家', lord: 'ryuzoji', stats: { battle: 62, command: 68, politics: 74, intelligence: 72, charm: 66 }, skill: '龍造寺一族', loyalty: 95 },
                    { id: 'goto_sumiharu', name: '後藤家信', lord: 'ryuzoji', stats: { battle: 78, command: 74, politics: 60, intelligence: 68, charm: 64 }, skill: '肥前勢', loyalty: 90 },
                    { id: 'egami_shigemune', name: '江上家種', lord: 'ryuzoji', stats: { battle: 74, command: 70, politics: 58, intelligence: 66, charm: 62 }, skill: '肥前勢', loyalty: 88 },
                    { id: 'chiba_tsunemura', name: '千葉胤連', lord: 'ryuzoji', stats: { battle: 76, command: 72, politics: 64, intelligence: 70, charm: 66 }, skill: '肥前勢', loyalty: 85 },
                    { id: 'takagi_taneshige', name: '高木胤繁', lord: 'ryuzoji', stats: { battle: 78, command: 80, politics: 78, intelligence: 78, charm: 76 }, skill: '肥前勢', loyalty: 88 },
                    { id: 'hyakutake_masukane', name: '百武賢兼', lord: 'ryuzoji', stats: { battle: 78, command: 75, politics: 60, intelligence: 66, charm: 64 }, skill: '肥前武士', loyalty: 85 },
                    { id: 'narimatsu_nobukatsu', name: '成松信勝', lord: 'ryuzoji', stats: { battle: 80, command: 73, politics: 45, intelligence: 55, charm: 61 }, skill: '龍造寺家臣', loyalty: 90 },
                    { id: 'enjoji_nobutane', name: '円城寺信胤', lord: 'ryuzoji', stats: { battle: 74, command: 70, politics: 50, intelligence: 64, charm: 58 }, skill: '肥前豪族', loyalty: 87 }
                ];
            }
            
            initializeTerritories() {
                const territoryNames = [
                    'mutsu', 'dewa', 'kai', 'shinano', 'echigo', 'kaga', 'noto', 'etchu',
                    'kozuke', 'shimotsuke', 'musashi', 'sagami', 'izu', 'mikawa', 'suruga', 'hizen',
                    'owari', 'mino', 'omi', 'yamashiro', 'yamato', 'harima', 'aki', 'bungo',
                ];
                
                const displayNames = [
                    '陸奥', '出羽', '甲斐', '越後', '信濃', '相模', '能登', '越中',
                    '上野', '下野', '武蔵', '伊勢', '伊豆', '三河', '豊前', '肥前',
                    '尾張', '美濃', '近江', '山城', '大和', '播磨', '安芸', '薩摩'
                ];
                
                // 地域特性：有利な兵科を設定（各兵科8個ずつ均等配分）
                const regionalAdvantages = [
                    'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry', 'cavalry',
                    'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry', 'infantry',
                    'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus', 'arquebus'
                ];
                
                this.territories = territoryNames.map((id, index) => ({
                    id: id,
                    name: displayNames[index],
                    owner: null,
                    agriculture: 50,
                    commerce: 50,
                    troops: 0,
                    walls: 50,
                    gold: 0,
                    rice: 0,
                    unitType: 'infantry', // 初期は歩兵
                    advantageType: regionalAdvantages[index], // 地域特性
                    agriculturalOfficer: null,
                    commercialOfficer: null,
                    diplomacyOfficer: null,
                    generalGarrison: null,
                    adjacentTerritories: []
                }));
                
                // 隣接関係を設定（簡略化）
                this.setAdjacencies();
                
                // 大名の初期配置と個別設定
                this.daimyos.forEach(daimyo => {
                    const territory = this.territories.find(t => t.id === daimyo.startTerritory);
                    if (territory) {
                        territory.owner = daimyo.id;
                        
                        // 史実に基づく個別設定
                        switch(daimyo.id) {
                            case 'oda': // 織田信長 - 尾張
                                territory.troops = 1200;
                                territory.walls = 500;
                                territory.agriculture = 65;
                                territory.commerce = 85; // 商業の中心地
                                daimyo.gold = 1800; // 商業で裕福
                                daimyo.rice = 600;
                                break;
                                
                            case 'takeda': // 武田信玄 - 甲斐
                                territory.troops = 1500; // 最強騎馬軍団
                                territory.walls = 500;
                                territory.agriculture = 55; // 山国で農業は厳しい
                                territory.commerce = 60;
                                daimyo.gold = 1000;
                                daimyo.rice = 500;
                                break;
                                
                            case 'uesugi': // 上杉謙信 - 信濃
                                territory.troops = 1400; // 軍神の精兵
                                territory.walls = 500;
                                territory.agriculture = 65; // 山国
                                territory.commerce = 55;
                                daimyo.gold = 1000;
                                daimyo.rice = 600;
                                break;
                                
                            case 'tokugawa': // 徳川家康 - 三河
                                territory.troops = 1100;
                                territory.walls = 500; // 質実剛健な守り
                                territory.agriculture = 75;
                                territory.commerce = 70;
                                daimyo.gold = 1300;
                                daimyo.rice = 750;
                                break;
                                
                            case 'hojo': // 北条氏康 - 伊勢（旧加賀）
                                territory.troops = 1000;
                                territory.walls = 1000; // 小田原城の堅固な守り
                                territory.agriculture = 70;
                                territory.commerce = 75;
                                daimyo.gold = 1200;
                                daimyo.rice = 700;
                                break;
                                
                            case 'mori': // 毛利元就 - 安芸
                                territory.troops = 1100;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 75;
                                daimyo.gold = 1100;
                                daimyo.rice = 650;
                                break;
                                
                            case 'otomo': // 大友宗麟 - 豊後
                                territory.troops = 900;
                                territory.walls = 500;
                                territory.agriculture = 65;
                                territory.commerce = 80; // 南蛮貿易
                                daimyo.gold = 2000; // 貿易で大いに潤う
                                daimyo.rice = 600;
                                break;
                                
                            case 'shimazu': // 島津義久 - 薩摩
                                territory.troops = 1000; // 少数精鋭
                                territory.walls = 500; // 九州の要害
                                territory.agriculture = 60; // 辺境の地
                                territory.commerce = 50;
                                daimyo.gold = 700;
                                daimyo.rice = 400;
                                break;
                                
                            case 'date': // 伊達政宗 - 陸奥
                                territory.troops = 1200;
                                territory.walls = 500;
                                territory.agriculture = 75;
                                territory.commerce = 65;
                                daimyo.gold = 1000;
                                daimyo.rice = 650;
                                break;
                                
                            case 'sanada': // 真田昌幸 - 越後
                                territory.troops = 600; // 小領主で兵数少ない
                                territory.walls = 500; // 山城で守りは堅い
                                territory.agriculture = 75; // 米どころ
                                territory.commerce = 55;
                                daimyo.gold = 800; // 資金に乏しい
                                daimyo.rice = 450; // 米は少ない
                                break;
                                
                            case 'hashiba': // 羽柴秀吉 - 播磨
                                territory.troops = 1100;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 85; // 商才に長ける
                                daimyo.gold = 1700; // 成り上がりの富
                                daimyo.rice = 800;
                                break;
                                
                            case 'ryuzoji': // 龍造寺隆信 - 肥前
                                territory.troops = 900; // 肥前の熊
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 65;
                                daimyo.gold = 900;
                                daimyo.rice = 550;
                                break;
                                
                            default: // デフォルト設定
                                territory.troops = 1000;
                                territory.walls = 500;
                                territory.agriculture = 70;
                                territory.commerce = 70;
                                break;
                        }
                        
                        // 大名の得意兵科を設定
                        territory.unitType = daimyo.preferredUnit || 'infantry';
                    }
                });
            }
            
            setupAIGenerals() {
                try {
                    // 各AI大名の武将を自動配置
                    this.daimyos.forEach(daimyo => {
                        if (daimyo.id !== this.playerDaimyo) {
                            this.assignAIGenerals(daimyo.id);
                        }
                    });
                } catch (error) {
                    console.warn('AI武将設定中にエラーが発生:', error);
                }
            }
            
            assignAIGenerals(daimyoId) {
                try {
                    // このAI大名の武将を取得
                    const aiGenerals = this.generals.filter(g => g.lord === daimyoId);
                    if (aiGenerals.length === 0) return;
                    
                    // AI大名の役職設定を初期化
                    if (!this.aiRoles[daimyoId]) {
                        this.aiRoles[daimyoId] = {
                            strategist: null,
                            diplomat: null,
                            administrator: null,
                            kenchiCommissioner: null,
                            riceCommissioner: null,
                            townCommissioner: null,
                            goldCommissioner: null,
                            constructionCommissioner: null,
                            militaryCommissioner: null,
                            armyStrategist: null,
                            vanguard: null,
                            rightWing: null,
                            leftWing: null,
                            reserve: null
                        };
                    }
                    
                    const availableGenerals = [...aiGenerals]; // コピーを作成
                    
                    // 【第1優先】軍団編成を最優先で配置（新しい優先順位）
                    // 1. 知謀最高を軍師に
                    if (availableGenerals.length > 0) {
                        const bestStrategist = availableGenerals.reduce((best, current) => 
                            (current.stats?.intelligence || 0) > (best.stats?.intelligence || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['armyStrategist'] = bestStrategist.id;
                        const index = availableGenerals.indexOf(bestStrategist);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 2. 戦闘最高を前衛に
                    if (availableGenerals.length > 0) {
                        const bestVanguard = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['vanguard'] = bestVanguard.id;
                        const index = availableGenerals.indexOf(bestVanguard);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 3. 統率最高を後詰に
                    if (availableGenerals.length > 0) {
                        const bestReserve = availableGenerals.reduce((best, current) => 
                            (current.stats?.command || 0) > (best.stats?.command || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['reserve'] = bestReserve.id;
                        const index = availableGenerals.indexOf(bestReserve);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 4. 残りの中で戦闘最高を右翼に
                    if (availableGenerals.length > 0) {
                        const bestRightWing = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['rightWing'] = bestRightWing.id;
                        const index = availableGenerals.indexOf(bestRightWing);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 5. 残りの中で戦闘最高を左翼に
                    if (availableGenerals.length > 0) {
                        const bestLeftWing = availableGenerals.reduce((best, current) => 
                            (current.stats?.battle || 0) > (best.stats?.battle || 0) ? current : best
                        );
                        this.aiRoles[daimyoId]['leftWing'] = bestLeftWing.id;
                        const index = availableGenerals.indexOf(bestLeftWing);
                        if (index > -1) availableGenerals.splice(index, 1);
                    }
                    
                    // 【第2優先】重要役職を配置
                    const importantRoles = ['strategist', 'diplomat', 'administrator'];
                    importantRoles.forEach(role => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            const score = this.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestGeneral = general;
                            }
                        });
                        
                        if (bestGeneral) {
                            this.aiRoles[daimyoId][role] = bestGeneral.id;
                            // 配置した武将を利用可能リストから削除
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // 【第3優先】奉行職を配置（残った武将で）
                    const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                    commissionerRoles.forEach(role => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            const score = this.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestGeneral = general;
                            }
                        });
                        
                        if (bestGeneral) {
                            this.aiRoles[daimyoId][role] = bestGeneral.id;
                            // 配置した武将を利用可能リストから削除
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // 残った武将を領土担当に配置
                    this.assignAITerritoryGenerals(daimyoId, availableGenerals);
                    
                } catch (error) {
                    console.warn(`AI大名${daimyoId}の武将配置中にエラー:`, error);
                }
            }
            
            calculateGeneralScore(general, role) {
                try {
                    if (!general || !general.stats) return 0;
                    
                    // 役職に応じて適性スコアを計算
                    switch (role) {
                        case 'strategist':
                        case 'armyStrategist':
                            return general.stats.intelligence + general.stats.command;
                        case 'diplomat':
                            return general.stats.politics + general.stats.charm;
                        case 'administrator':
                            return general.stats.politics + general.stats.intelligence;
                        case 'kenchiCommissioner':
                        case 'riceCommissioner':
                        case 'townCommissioner':
                        case 'goldCommissioner':
                            return general.stats.politics * 2; // 奉行職は政治重視
                        case 'constructionCommissioner':
                            return general.stats.command + general.stats.politics; // 普請奉行は統率+政治
                        case 'militaryCommissioner':
                            return general.stats.battle + general.stats.command; // 兵奉行は戦闘+統率
                        case 'vanguard':
                            return general.stats.battle + general.stats.command;
                        case 'rightWing':
                        case 'leftWing':
                            return general.stats.battle;
                        case 'reserve':
                            return general.stats.command;
                        default:
                            return general.stats.battle + general.stats.command + general.stats.politics;
                    }
                } catch (error) {
                    console.warn('武将スコア計算中にエラー:', error);
                    return 0;
                }
            }
            
            assignAITerritoryGenerals(daimyoId, availableGenerals) {
                try {
                    // この大名の領土を取得
                    const territories = this.territories.filter(t => t.owner === daimyoId);
                    
                    territories.forEach((territory, index) => {
                        if (availableGenerals.length > index) {
                            territory.generalGarrison = availableGenerals[index].id;
                        }
                    });
                } catch (error) {
                    console.warn(`AI大名${daimyoId}の領土武将配置中にエラー:`, error);
                }
            }
            
            setAdjacencies() {
                // 隣接関係の設定（8x3のグリッドベース、8方向）
                const adjacencyMap = {
                    0: [1, 8, 9],
                    1: [0, 2, 8, 9, 10],
                    2: [1, 3, 9, 10, 11],
                    3: [2, 4, 10, 11, 12],
                    4: [3, 5, 11, 12, 13],
                    5: [4, 6, 12, 13, 14],
                    6: [5, 7, 13, 14, 15],
                    7: [6, 14, 15],
                    8: [0, 1, 9, 16, 17],
                    9: [0, 1, 2, 8, 10, 16, 17, 18],
                    10: [1, 2, 3, 9, 11, 17, 18, 19],
                    11: [2, 3, 4, 10, 12, 18, 19, 20],
                    12: [3, 4, 5, 11, 13, 19, 20, 21],
                    13: [4, 5, 6, 12, 14, 20, 21, 22],
                    14: [5, 6, 7, 13, 15, 21, 22, 23],
                    15: [6, 7, 14, 22, 23],
                    16: [8, 9, 17],
                    17: [8, 9, 10, 16, 18],
                    18: [9, 10, 11, 17, 19],
                    19: [10, 11, 12, 18, 20],
                    20: [11, 12, 13, 19, 21],
                    21: [12, 13, 14, 20, 22],
                    22: [13, 14, 15, 21, 23],
                    23: [14, 15, 22]
                };
                
                Object.entries(adjacencyMap).forEach(([index, adjacents]) => {
                    const territory = this.territories[parseInt(index)];
                    territory.adjacentTerritories = adjacents.map(i => this.territories[i].id);
                });
            }
            
            getPlayerTerritories() {
                return this.territories.filter(t => t.owner === this.playerDaimyo);
            }
            
            getPlayerDaimyoData() {
                return this.daimyos.find(d => d.id === this.playerDaimyo);
            }
            
            addLog(message, type = 'normal') {
                this.gameLog.push({ message, type, turn: this.turn });
                this.updateLogDisplay();
            }
            
            addPersonnelLog(message) {
                try {
                    if (!this.personnelEvents) {
                        this.personnelEvents = [];
                    }
                    this.personnelEvents.push({
                        type: 'personnel',
                        message: message || '',
                        turn: this.turn || 1
                    });
                } catch (error) {
                    console.warn('人事ログ追加中にエラー:', error);
                }
            }
            
            updateLogDisplay() {
                const logArea = document.getElementById('log-area');
                const latestLogs = this.gameLog.slice(-5);
                logArea.innerHTML = latestLogs.map(log => 
                    `<div class="log-entry ${log.type}">${log.message}</div>`
                ).join('');
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        
        // UI管理
        class UIManager {
            constructor(gameState) {
                this.gameState = gameState;
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // 大名選択
                document.querySelectorAll('.daimyo-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const daimyoId = e.currentTarget.dataset.daimyo;
                        this.selectDaimyo(daimyoId);
                    });
                });
                
                // ゲーム内ボタン
                document.getElementById('next-turn-btn').addEventListener('click', () => this.nextTurn());
                document.getElementById('attack-btn').addEventListener('click', () => this.showAttackModal());
                document.getElementById('strategy-btn').addEventListener('click', () => this.showStrategyModal());
                document.getElementById('diplomacy-btn').addEventListener('click', () => this.showDiplomacyModal());
                document.getElementById('scout-btn').addEventListener('click', () => this.showScoutModal());
                document.getElementById('trade-btn').addEventListener('click', () => this.showTradeModal());
                document.getElementById('recruit-btn').addEventListener('click', () => this.showRecruitModal());
                document.getElementById('recruit-general-btn').addEventListener('click', () => this.showRecruitGeneralModal());
                document.getElementById('generals-btn').addEventListener('click', () => this.showGeneralsModal());
                
                // モーダル
                document.getElementById('modal-cancel-btn').addEventListener('click', () => this.hideModal());
                document.getElementById('modal-confirm-btn').addEventListener('click', () => this.executeModalAction());
                document.getElementById('confirm-turn-btn').addEventListener('click', () => this.hideTurnLog());
                document.getElementById('generals-cancel-btn').addEventListener('click', () => this.hideGeneralsModal());
                document.getElementById('generals-save-btn').addEventListener('click', () => this.saveGeneralsSettings());
                document.getElementById('generals-reset-btn').addEventListener('click', () => this.resetCurrentTab());
                document.getElementById('recruit-general-cancel-btn').addEventListener('click', () => this.hideRecruitGeneralModal());
                document.getElementById('battle-log-close-btn').addEventListener('click', () => this.hideBattleLogModal());
                document.getElementById('scout-close-btn').addEventListener('click', () => this.hideScoutModal());
                
                // 武将設定タブ
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // 領土クリック
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('territory')) {
                        this.selectTerritory(e.target.dataset.territoryId);
                    }
                });
            }
            
            selectDaimyo(daimyoId) {
                try {
                    this.gameState.playerDaimyo = daimyoId;
                    this.gameState.attackUsed = false; // ゲーム開始時は行動可能に設定
                    this.gameState.diplomacyUsed = false;
                    this.gameState.strategyUsed = false;
                    
                    // プレイヤー選択後にAI武将を再配置（安全に実行）
                    if (this.gameState.setupAIGenerals) {
                        this.gameState.setupAIGenerals();
                    }
                    
                    // プレイヤーの武将を自動配置
                    this.setupInitialPlayerGenerals();
                    
                    document.getElementById('daimyo-selection-screen').classList.add('hidden');
                    document.getElementById('game-screen').classList.remove('hidden');
                    this.initializeGameUI();
                    
                    const playerDaimyo = this.gameState.getPlayerDaimyoData();
                    const daimyoName = playerDaimyo ? playerDaimyo.name : '選択された大名';
                    
                    // 大名ごとの個性的な開始メッセージ
                    let startMessage = '';
                    switch(this.gameState.playerDaimyo) {
                        case 'oda':
                            startMessage = `${daimyoName}として革新的な天下統一が始まる！商業の力と鉄砲で新時代を切り開け！`;
                            break;
                        case 'takeda':
                            startMessage = `${daimyoName}として甲斐の虎が覇道を歩む！風林火山の旗のもと、無敵の騎馬突撃で天下を駆けろ！`;
                            break;
                        case 'uesugi':
                            startMessage = `${daimyoName}として軍神の戦いが始まる！信濃の山国から義を背負い、無双の武と神威で敵の守備を粉砕せよ！`;
                            break;
                        case 'tokugawa':
                            startMessage = `${daimyoName}として忍耐の道が始まる！三河武士の忠義と堅実な統治で太平の世を築け！`;
                            break;
                        case 'hojo':
                            startMessage = `${daimyoName}として関東の覇者が立つ！小田原城の鉄壁の守りを誇り、関東制覇から天下へ！`;
                            break;
                        case 'mori':
                            startMessage = `${daimyoName}として中国地方の謀将が動く！三本の矢の教えと巧みな策略で天下を手中に！`;
                            break;
                        case 'otomo':
                            startMessage = `${daimyoName}として南蛮の知識で新時代を！豊後の地から西洋の技術と富で天下統一を！`;
                            break;
                        case 'shimazu':
                            startMessage = `${daimyoName}として薩摩隼人の魂が燃える！九州の最果てから少数精鋭で天下に挑め！`;
                            break;
                        case 'date':
                            startMessage = `${daimyoName}として独眼竜が翔ける！奥州の覇者として伊達の威風で天下を震撼させよ！`;
                            break;
                        case 'sanada':
                            startMessage = `${daimyoName}として表裏比興の智謀戦開始！越後の米どころを拠点に知略で大勢力を翻弄し、天下の夢を掴め！`;
                            break;
                        case 'hashiba':
                            startMessage = `${daimyoName}として成り上がりの野望が始まる！人たらしの才と商才で、百姓から天下人への道を歩め！`;
                            break;
                        case 'ryuzoji':
                            startMessage = `${daimyoName}として肥前の熊が咆哮する！九州統一から天下へ、武力で道を切り開け！`;
                            break;
                        default:
                            startMessage = `${daimyoName}として天下統一の戦いが始まった！`;
                            break;
                    }
                    
                    this.gameState.addLog(startMessage);
                    
                    // 配置された武将をログに表示
                    this.showInitialGeneralStatus();
                    
                } catch (error) {
                    console.error('大名選択中にエラーが発生:', error);
                    // エラーが発生してもゲームは開始する
                    this.gameState.attackUsed = false; // エラー時も行動可能に
                    this.gameState.diplomacyUsed = false;
                    this.gameState.strategyUsed = false;
                    document.getElementById('daimyo-selection-screen').classList.add('hidden');
                    document.getElementById('game-screen').classList.remove('hidden');
                    this.initializeGameUI();
                    this.gameState.addLog('ゲームが開始されました');
                }
            }
            
            setupInitialPlayerGenerals() {
                try {
                    // プレイヤーの配下武将を取得
                    const playerGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === this.gameState.playerDaimyo
                    );
                    
                    if (playerGenerals.length === 0) {
                        return; // 武将がいない場合は何もしない
                    }
                    
                    // 武将をコピーして配置用リストを作成
                    const availableGenerals = [...playerGenerals];
                    
                    // 【第1優先】軍団編成を最優先で配置
                    const militaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    militaryRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // 武将適性計算中にエラーが発生しても継続
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // 配置した武将を利用可能リストから削除
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // 【第2優先】重要役職を配置
                    const importantRoles = ['strategist', 'diplomat', 'administrator'];
                    importantRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // 武将適性計算中にエラーが発生しても継続
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // 配置した武将を利用可能リストから削除
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // 【第3優先】奉行職を配置（残った武将で）
                    const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                    commissionerRoles.forEach(roleKey => {
                        if (availableGenerals.length === 0) return;
                        
                        let bestGeneral = null;
                        let bestScore = -1;
                        
                        availableGenerals.forEach(general => {
                            try {
                                const score = this.gameState.calculateGeneralScore(general, roleKey);
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestGeneral = general;
                                }
                            } catch (error) {
                                // 武将適性計算中にエラーが発生しても継続
                            }
                        });
                        
                        if (bestGeneral) {
                            this.gameState.playerRoles[roleKey] = bestGeneral.id;
                            // 配置した武将を利用可能リストから削除
                            const index = availableGenerals.indexOf(bestGeneral);
                            if (index > -1) {
                                availableGenerals.splice(index, 1);
                            }
                        }
                    });
                    
                    // 残った武将を領土担当に配置
                    this.assignGeneralsToTerritories(availableGenerals);
                    
                } catch (error) {
                    // 初期武将配置中にエラーが発生しても継続
                }
            }
            
            assignGeneralsToTerritories(remainingGenerals) {
                try {
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    
                    remainingGenerals.forEach((general, index) => {
                        if (index < playerTerritories.length && general && playerTerritories[index]) {
                            playerTerritories[index].generalGarrison = general.id;
                        }
                    });
                } catch (error) {
                    // 領土武将配置中にエラーが発生しても継続
                }
            }
            
            showInitialGeneralStatus() {
                try {
                    const playerGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === this.gameState.playerDaimyo
                    );
                    
                    if (playerGenerals.length > 0) {
                        // 各カテゴリーの配置数をカウント
                        const militaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        const importantRoles = ['strategist', 'diplomat', 'administrator'];
                        const commissionerRoles = ['kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                        
                        const assignedMilitary = militaryRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        const assignedImportant = importantRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        const assignedCommissioner = commissionerRoles.filter(role => this.gameState.playerRoles[role] !== null);
                        
                        // 領土に配置された武将をカウント
                        const assignedTerritories = this.gameState.getPlayerTerritories().filter(t => t.generalGarrison !== null);
                        
                        this.gameState.addLog(`配下武将${playerGenerals.length}名が参集`, 'diplomacy');
                        
                        // 優先順位に従った配置状況を表示
                        if (assignedMilitary.length > 0) {
                            this.gameState.addLog(`【軍団編成】${assignedMilitary.length}名を最優先配置`, 'diplomacy');
                        }
                        if (assignedImportant.length > 0) {
                            this.gameState.addLog(`【重要役職】${assignedImportant.length}名を配置`, 'diplomacy');
                        }
                        if (assignedCommissioner.length > 0) {
                            this.gameState.addLog(`【奉行職】${assignedCommissioner.length}名を配置`, 'diplomacy');
                        }
                        if (assignedTerritories.length > 0) {
                            this.gameState.addLog(`【領土担当】${assignedTerritories.length}名を配置`, 'diplomacy');
                        }
                        
                        // 主要な軍団メンバーを具体的に表示
                        try {
                            const militaryAssignments = [];
                            const roleNames = {
                                'armyStrategist': '軍師',
                                'vanguard': '前衛',
                                'rightWing': '右翼',
                                'leftWing': '左翼',
                                'reserve': '後詰'
                            };
                            
                            militaryRoles.forEach(roleKey => {
                                const generalId = this.gameState.playerRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general) {
                                        militaryAssignments.push(`${general.name}(${roleNames[roleKey]})`);
                                    }
                                }
                            });
                            
                            if (militaryAssignments.length > 0) {
                                const displayAssignments = militaryAssignments.slice(0, 3); // 最大3名まで表示
                                let assignmentMessage = '';
                                if (militaryAssignments.length <= 3) {
                                    assignmentMessage = `軍団主力: ${displayAssignments.join('、')}`;
                                } else {
                                    assignmentMessage = `軍団主力: ${displayAssignments.join('、')}ら${militaryAssignments.length}名`;
                                }
                                this.gameState.addLog(assignmentMessage, 'diplomacy');
                            }
                        } catch (error) {
                            console.warn('軍団メンバー表示中にエラー:', error);
                        }
                        

                    }
                } catch (error) {
                    // 初期配置ログ出力中にエラーが発生しても継続
                }
            }
            
            initializeGameUI() {
                try {
                    this.renderMap();
                    this.updateStatus();
                    // 初期軍団戦力を計算
                    this.calculateArmyStats();
                    
                    // 武将設定の初期化状態をログに表示
                    const assignedRoles = Object.values(this.gameState.playerRoles).filter(id => id !== null);
                    if (assignedRoles.length > 0) {
                        this.gameState.addLog(`武将配置完了：役職${assignedRoles.length}名配置済み`);
                    }
                } catch (error) {
                    // 初期UI更新中にエラーが発生しても継続
                }
            }
            
            renderMap() {
                const mapGrid = document.getElementById('map-grid');
                mapGrid.innerHTML = '';
                
                // 兵科アイコン
                const unitIcons = {
                    'infantry': '⚔️',
                    'cavalry': '🐎',
                    'arquebus': '🔫'
                };
                
                this.gameState.territories.forEach((territory, index) => {
                    const territoryDiv = document.createElement('div');
                    territoryDiv.className = 'territory';
                    territoryDiv.dataset.territoryId = territory.id;
                    
                    let className = 'territory';
                    if (!territory.owner) {
                        className += ' empty';
                    } else if (territory.owner === this.gameState.playerDaimyo) {
                        className += ' player';
                    } else {
                        className += ' enemy';
                    }
                    
                    territoryDiv.className = className;
                    
                    const ownerName = territory.owner ? 
                        this.gameState.daimyos.find(d => d.id === territory.owner)?.name || '不明' : 
                        '空白地';
                    
                    // 兵科表示の改善
                    let unitDisplay = '';
                    let advantageDisplay = '';
                    
                    if (territory.owner) {
                        // 支配されている領土：現在の兵科マーク
                        if (territory.troops > 0 && territory.unitType) {
                            unitDisplay = ` ${unitIcons[territory.unitType] || '⚔️'}`;
                        }
                        
                        // 地域特性と一致している場合はチェックマーク、そうでなければ地域特性のアイコン
                        if (territory.unitType === territory.advantageType) {
                            advantageDisplay = ' <span style="color: #66ff66;">✓</span>';
                        } else {
                            advantageDisplay = ` <span style="color: #ffaa66; font-size: 10px;">${unitIcons[territory.advantageType] || '⚔️'}</span>`;
                        }
                    } else {
                        // 空白地：地域特性のマークを名前の横に表示
                        advantageDisplay = ` <span style="color: #ffaa66;">${unitIcons[territory.advantageType] || '⚔️'}</span>`;
                    }
                    
                    // 地域特性の表示テキストを作成
                    const advantageText = territory.advantageType === 'infantry' ? '歩兵' : 
                                        territory.advantageType === 'cavalry' ? '騎馬' : '鉄砲';
                    
                    let statsContent = '';
                    if (territory.owner) {
                        // 支配済み領土
                        statsContent = `農:${territory.agriculture} 商:${territory.commerce}<br>兵:${territory.troops}${unitDisplay} 壁:${territory.walls}`;
                        
                        // 地域特性と現在の兵科が違う場合は地域特性を表示
                        if (territory.unitType !== territory.advantageType) {
                            statsContent += `<br><span style="color: #ffaa66; font-size: 10px;">${unitIcons[territory.advantageType]}${advantageText}有利</span>`;
                        }
                    } else {
                        // 空白地
                        statsContent = `農:${territory.agriculture} 商:${territory.commerce}<br>${unitIcons[territory.advantageType] || '⚔️'} ${advantageText}有利`;
                    }
                    
                    territoryDiv.innerHTML = `
                        <div class="territory-name">${territory.name}${advantageDisplay}</div>
                        <div class="territory-owner">${ownerName}</div>
                        <div class="territory-stats">${statsContent}</div>
                    `;
                    
                    mapGrid.appendChild(territoryDiv);
                });
            }
            
            updateStatus() {
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                document.getElementById('current-turn').textContent = this.gameState.turn;
                document.getElementById('player-gold').textContent = playerDaimyo.gold;
                document.getElementById('player-rice').textContent = playerDaimyo.rice;
            }
            
            selectTerritory(territoryId) {
                const territory = this.gameState.territories.find(t => t.id === territoryId);
                this.gameState.selectedTerritory = territory;
                
                // 選択状態の表示更新
                document.querySelectorAll('.territory').forEach(t => {
                    t.style.border = '2px solid #666';
                });
                
                const territoryElement = document.querySelector(`[data-territory-id="${territoryId}"]`);
                if (territoryElement) {
                    territoryElement.style.border = '3px solid #ff6666';
                }
                
                // ボタンの有効/無効を更新
                this.updateActionButtons();
                
                // 選択情報をログに表示（改善されたメッセージ）
                if (territory) {
                    const ownerName = territory.owner ? 
                        this.gameState.daimyos.find(d => d.id === territory.owner)?.name || '不明' : 
                        '空白地';
                    
                    let statusMessage = `${territory.name}を選択 (支配者: ${ownerName})`;
                    
                    // 攻撃可能性をチェック
                    const isPlayerTerritory = territory.owner === this.gameState.playerDaimyo;
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    const isAdjacent = this.isAdjacentToPlayerTerritory(territory);
                    
                    const canAttack = !this.gameState.attackUsed && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    const canStrategy = !this.gameState.strategyUsed && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    const canDiplomacy = !this.gameState.diplomacyUsed && !isPlayerTerritory && playerTerritories.length > 0 && isAdjacent;
                    
                    if (isPlayerTerritory) {
                        statusMessage += ' - 自領土のため行動不可';
                    } else if (playerTerritories.length === 0) {
                        statusMessage += ' - 自領土を持っていません';
                    } else if (!isAdjacent) {
                        if (territory.id === 'yamashiro') {
                            statusMessage += ' - 山城への出兵には近江・大和が必要';
                        } else {
                            statusMessage += ' - 隣接していないため出兵・謀略不可';
                        }
                    } else {
                        const availableActions = [];
                        if (canAttack) availableActions.push('出兵');
                        if (canStrategy) availableActions.push('謀略');
                        if (canDiplomacy) availableActions.push('外交');
                        
                        if (availableActions.length > 0) {
                            statusMessage += ` - 実行可能: ${availableActions.join('、')}`;
                        } else {
                            statusMessage += ' - 全ての行動を使用済み';
                        }
                    }
                    
                    this.gameState.addLog(statusMessage);
                }
            }
            
            updateActionButtons() {
                const selectedTerritory = this.gameState.selectedTerritory;
                const isPlayerTerritory = selectedTerritory?.owner === this.gameState.playerDaimyo;
                
                // プレイヤーが領土を持っているかチェック
                const playerTerritories = this.gameState.getPlayerTerritories();
                const hasPlayerTerritories = playerTerritories.length > 0;
                
                // 隣接チェック：選択された領土がプレイヤー領土と隣接しているか
                const isAdjacent = this.isAdjacentToPlayerTerritory(selectedTerritory);
                
                // 各行動を個別にチェック（隣接条件を追加）
                const canAttack = !this.gameState.attackUsed && selectedTerritory && !isPlayerTerritory && hasPlayerTerritories && isAdjacent;
                const canStrategy = !this.gameState.strategyUsed && hasPlayerTerritories; // 虚報は対象不要なので条件緩和
                const canDiplomacy = !this.gameState.diplomacyUsed && selectedTerritory && !isPlayerTerritory && hasPlayerTerritories && isAdjacent;
                
                // 偵察は敵領土であれば行動済みでも可能（隣接不要）
                const canScout = selectedTerritory && !isPlayerTerritory;
                
                document.getElementById('attack-btn').disabled = !canAttack;
                document.getElementById('strategy-btn').disabled = !canStrategy;
                document.getElementById('diplomacy-btn').disabled = !canDiplomacy;
                document.getElementById('scout-btn').disabled = !canScout;
                
                // 兵雇用ボタンのテキストを動的に変更
                const recruitBtn = document.getElementById('recruit-btn');
                if (recruitBtn) {
                    if (selectedTerritory && isPlayerTerritory) {
                        recruitBtn.textContent = `${selectedTerritory.name}に雇用`;
                        recruitBtn.style.backgroundColor = '#006600';
                        recruitBtn.style.borderColor = '#008800';
                    } else {
                        recruitBtn.textContent = '兵雇用';
                        recruitBtn.style.backgroundColor = '';
                        recruitBtn.style.borderColor = '';
                    }
                }
            }
            
            // 選択された領土がプレイヤーの領土と隣接しているかチェック
            isAdjacentToPlayerTerritory(targetTerritory) {
                if (!targetTerritory) return false;
                
                const playerTerritories = this.gameState.getPlayerTerritories();
                if (playerTerritories.length === 0) return false;
                
                // 山城への出兵は近江・大和からのみ可能
                if (targetTerritory.id === 'yamashiro') {
                    return playerTerritories.some(playerTerritory => 
                        playerTerritory.id === 'omi' || playerTerritory.id === 'yamato'
                    );
                }
                
                // その他の領土は通常の隣接チェック
                return playerTerritories.some(playerTerritory => 
                    playerTerritory.adjacentTerritories.includes(targetTerritory.id)
                );
            }
            
            showAttackModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                // 兵科アイコンと名前
                const unitIcons = {
                    'infantry': '⚔️',
                    'cavalry': '🐎',
                    'arquebus': '🔫'
                };
                
                const unitNames = {
                    'infantry': '歩兵',
                    'cavalry': '騎馬',
                    'arquebus': '鉄砲'
                };
                
                // 地域特性情報
                const advantageIcon = unitIcons[target.advantageType] || '⚔️';
                const advantageName = unitNames[target.advantageType] || '不明';
                
                // プレイヤーの主力兵科を判定（最も兵数の多い領土の兵科）
                const playerTerritories = this.gameState.getPlayerTerritories();
                let playerMainUnit = 'infantry';
                let maxTroops = 0;
                
                playerTerritories.forEach(territory => {
                    if (territory.troops > maxTroops) {
                        maxTroops = territory.troops;
                        playerMainUnit = territory.unitType;
                    }
                });
                
                const playerUnitIcon = unitIcons[playerMainUnit] || '⚔️';
                const playerUnitName = unitNames[playerMainUnit] || '不明';
                
                // 相性判定
                let compatibilityText = '';
                let compatibilityColor = '#ffaa66';
                
                if (playerMainUnit === target.advantageType) {
                    compatibilityText = '【有利】この地域では我軍の兵科が+20%ボーナス！';
                    compatibilityColor = '#66ff66';
                } else {
                    compatibilityText = `【通常】我軍${playerUnitIcon}${playerUnitName} vs 地域特性${advantageIcon}${advantageName}`;
                    compatibilityColor = '#ffaa66';
                }
                
                // 山城への出兵条件チェック
                let attackCondition = '';
                if (target.id === 'yamashiro') {
                    const hasOmi = playerTerritories.some(t => t.id === 'omi');
                    const hasYamato = playerTerritories.some(t => t.id === 'yamato');
                    
                    if (hasOmi && hasYamato) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">【山城出兵路】</h4><p style="color: #66ccff;">近江・大和の両方を確保！万全の体制で天下の中心地を攻略</p></div>';
                    } else if (hasOmi) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">【山城出兵路】</h4><p style="color: #66ccff;">近江から天下の中心地・山城への進軍</p></div>';
                    } else if (hasYamato) {
                        attackCondition = '<div style="background: #003366; border: 1px solid #66ccff; border-radius: 5px; padding: 10px; margin-bottom: 15px;"><h4 style="color: #66ccff; margin-bottom: 8px;">【山城出兵路】</h4><p style="color: #66ccff;">大和から天下の中心地・山城への進軍</p></div>';
                    }
                }
                
                let battlePhase = '';
                if (target.troops > 0) {
                    battlePhase = '<p><strong style="color: #ffff66;">第1段階:</strong> まず守備兵を撃破する必要があります</p>';
                } else {
                    battlePhase = '<p><strong style="color: #ff6666;">第2段階:</strong> 守備兵は全滅済み。城壁を破壊して攻略！</p>';
                }
                
                document.getElementById('modal-title').textContent = `${target.name}への出兵`;
                document.getElementById('modal-body').innerHTML = `
                    ${attackCondition}
                    <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #ff6666; margin-bottom: 10px;">【攻撃目標情報】</h4>
                        <p><strong>領土名:</strong> ${target.name}</p>
                        <p><strong>守備兵力:</strong> ${target.troops}</p>
                        <p><strong>城壁強度:</strong> ${target.walls}</p>
                        <p><strong>地域特性:</strong> ${advantageIcon} ${advantageName}有利地域</p>
                    </div>
                    
                    <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #66ff66; margin-bottom: 10px;">【兵科相性】</h4>
                        <p style="color: ${compatibilityColor};">${compatibilityText}</p>
                        ${playerMainUnit === target.advantageType ? 
                            '<p style="color: #66ff66; font-size: 12px;">※地域特性ボーナスにより戦闘力が大幅に向上します</p>' : 
                            '<p style="color: #ccc; font-size: 12px;">※兵科変更で地域特性ボーナス(+20%)を得られます</p>'
                        }
                    </div>
                    
                    ${battlePhase}
                    <p style="font-size: 11px; color: #ccc;">※兵数が0になってから城壁が攻撃対象となります</p>
                    <p><strong>出兵しますか？</strong></p>
                `;
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'attack';
            }
            
            showStrategyModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                document.getElementById('modal-title').textContent = `謀略工作`;
                document.getElementById('modal-body').innerHTML = `
                    <p>謀略の種類を選択してください:</p>
                    <select id="strategy-type" style="width: 100%; padding: 8px; background: #333; border: 1px solid #666; color: #fff; border-radius: 5px;">
                        <option value="rumor">虚報防御</option>
                        <option value="fire">火攻め</option>
                        <option value="water">水攻め</option>
                        <option value="defection">調略</option>
                    </select>
                `;
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'strategy';
            }
            
            showDiplomacyModal() {
                const target = this.gameState.selectedTerritory;
                if (!target) return;
                
                document.getElementById('modal-title').textContent = `${target.name}との外交`;
                document.getElementById('modal-body').innerHTML = `
                    <p>外交交渉を行います。</p>
                    <p>停戦協定を提案しますか？</p>
                `;
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'diplomacy';
            }
            
            showTradeModal() {
                document.getElementById('modal-title').textContent = '米売買';
                document.getElementById('modal-body').innerHTML = `
                    <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #ffff66; margin-bottom: 10px;">【現在の相場】</h4>
                        <p style="text-align: center; font-size: 16px;">金100 ⇔ 米50</p>
                    </div>
                    
                    <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #66ff66; margin-bottom: 15px;">【取引設定】</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #fff;">取引種別:</label>
                            <select id="trade-type" style="width: 100%; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px;">
                                <option value="buy">米を買う (金→米)</option>
                                <option value="sell">米を売る (米→金)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #fff;">取引数量:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button class="btn" onclick="uiManager.adjustTradeAmount(-100)" style="padding: 8px 12px;">-100</button>
                                <input type="number" id="trade-amount" min="0" max="5000" value="100" 
                                       style="flex: 1; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; text-align: center;">
                                <button class="btn" onclick="uiManager.adjustTradeAmount(100)" style="padding: 8px 12px;">+100</button>
                            </div>
                            <div style="text-align: center; margin-top: 8px; color: #ccc; font-size: 12px;">
                                ※直接入力も可能です
                            </div>
                        </div>
                        
                        <div id="trade-preview" style="background: #444; border: 1px solid #666; border-radius: 5px; padding: 10px; text-align: center; color: #ffff66;">
                            <!-- 取引プレビューがここに表示される -->
                        </div>
                    </div>
                `;
                
                // 取引プレビューを更新
                this.updateTradePreview();
                
                // リアルタイム更新のイベントリスナー
                const amountInput = document.getElementById('trade-amount');
                const typeSelect = document.getElementById('trade-type');
                
                if (amountInput) {
                    amountInput.addEventListener('input', () => this.updateTradePreview());
                }
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => this.updateTradePreview());
                }
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'trade';
            }
            
            adjustTradeAmount(change) {
                const input = document.getElementById('trade-amount');
                if (input) {
                    const currentValue = parseInt(input.value) || 0;
                    const newValue = Math.max(0, Math.min(5000, currentValue + change));
                    input.value = newValue;
                    this.updateTradePreview();
                }
            }
            
            updateTradePreview() {
                const amount = parseInt(document.getElementById('trade-amount')?.value || '0');
                const type = document.getElementById('trade-type')?.value;
                const preview = document.getElementById('trade-preview');
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!preview || !playerDaimyo) return;
                
                let previewText = '';
                let canAfford = false;
                
                if (type === 'buy') {
                    const cost = amount * 2;
                    canAfford = playerDaimyo.gold >= cost;
                    previewText = `金${cost}で米${amount}を購入`;
                    if (!canAfford) {
                        previewText += ` <span style="color: #ff6666;">(資金不足)</span>`;
                    }
                } else {
                    const income = amount * 2;
                    canAfford = playerDaimyo.rice >= amount;
                    previewText = `米${amount}を売って金${income}を獲得`;
                    if (!canAfford) {
                        previewText += ` <span style="color: #ff6666;">(米不足)</span>`;
                    }
                }
                
                preview.innerHTML = previewText;
                preview.style.color = canAfford ? '#66ff66' : '#ff6666';
            }
            
            showRecruitModal() {
                const playerTerritories = this.gameState.getPlayerTerritories();
                if (playerTerritories.length === 0) {
                    this.gameState.addLog('兵を雇用するには領土が必要です');
                    return;
                }
                
                const selectedTerritory = this.gameState.selectedTerritory;
                const isSelectedPlayerTerritory = selectedTerritory?.owner === this.gameState.playerDaimyo;
                
                let defaultTerritoryId = '';
                if (isSelectedPlayerTerritory) {
                    defaultTerritoryId = selectedTerritory.id;
                }
                
                const unitTypeNames = {
                    'infantry': '歩兵',
                    'cavalry': '騎馬', 
                    'arquebus': '鉄砲'
                };
                
                document.getElementById('modal-title').textContent = '兵士雇用';
                document.getElementById('modal-body').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label>配置先:</label>
                        <select id="recruit-territory" style="width: 100%; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; margin-top: 5px;">
                            ${playerTerritories.map(t => 
                                `<option value="${t.id}" ${t.id === defaultTerritoryId ? 'selected' : ''}>${t.name} (${unitTypeNames[t.unitType]})</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>雇用兵数:</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <button class="btn" onclick="uiManager.adjustRecruitAmount(-100)" style="padding: 8px 12px;">-100</button>
                            <input type="number" id="recruit-amount" min="0" max="2000" value="100" 
                                   style="flex: 1; background: #333; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; text-align: center;">
                            <button class="btn" onclick="uiManager.adjustRecruitAmount(100)" style="padding: 8px 12px;">+100</button>
                        </div>
                        <div style="text-align: center; margin-top: 8px; color: #ccc; font-size: 12px;">
                            費用: 金1 = 兵士1人
                        </div>
                    </div>
                    
                    <div style="background: #333; border: 1px solid #666; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                        <h4 style="color: #ffff66; margin-bottom: 8px;">兵科変更 (費用: 金100)</h4>
                        <div id="unit-type-controls">
                `;
                
                playerTerritories.forEach(territory => {
                    const currentUnit = unitTypeNames[territory.unitType];
                    const advantageUnit = unitTypeNames[territory.advantageType];
                    const isAdvantaged = territory.unitType === territory.advantageType;
                    
                    document.getElementById('modal-body').innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px; background: #222; border-radius: 3px;">
                            <div>
                                <strong style="color: #ff6666;">${territory.name}</strong>
                                <span style="color: #ccc; margin-left: 10px;">${currentUnit} ${isAdvantaged ? '✓' : ''}</span>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <select id="unit-select-${territory.id}" data-territory="${territory.id}" style="background: #333; border: 1px solid #555; color: #fff; padding: 3px;">
                                    <option value="infantry" ${territory.unitType === 'infantry' ? 'selected' : ''}>歩兵</option>
                                    <option value="cavalry" ${territory.unitType === 'cavalry' ? 'selected' : ''}>騎馬</option>
                                    <option value="arquebus" ${territory.unitType === 'arquebus' ? 'selected' : ''}>鉄砲</option>
                                </select>
                                <button class="btn" style="padding: 3px 8px; font-size: 11px;" 
                                        onclick="uiManager.changeUnitType('${territory.id}')" id="change-btn-${territory.id}">
                                    変更
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('modal-body').innerHTML += '</div></div>';
                
                document.getElementById('action-modal').style.display = 'flex';
                this.currentAction = 'recruit';
            }
            
            adjustRecruitAmount(change) {
                const input = document.getElementById('recruit-amount');
                if (input) {
                    const currentValue = parseInt(input.value) || 0;
                    const newValue = Math.max(0, Math.min(2000, currentValue + change));
                    input.value = newValue;
                }
            }
            
            changeUnitType(territoryId) {
                const territory = this.gameState.territories.find(t => t.id === territoryId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const newUnitType = document.getElementById(`unit-select-${territoryId}`).value;
                
                if (!territory || !playerDaimyo) return;
                
                if (territory.unitType === newUnitType) {
                    this.gameState.addLog('既に同じ兵科です');
                    return;
                }
                
                if (playerDaimyo.gold < 100) {
                    this.gameState.addLog('兵科変更には金100が必要です');
                    return;
                }
                
                const unitTypeNames = {
                    'infantry': '歩兵',
                    'cavalry': '騎馬', 
                    'arquebus': '鉄砲'
                };
                
                const oldUnit = unitTypeNames[territory.unitType];
                const newUnit = unitTypeNames[newUnitType];
                
                // 費用を支払い、兵科を変更
                playerDaimyo.gold -= 100;
                territory.unitType = newUnitType;
                
                this.gameState.addLog(`${territory.name}の兵科を${oldUnit}から${newUnit}に変更`, 'strategy');
                this.gameState.addPersonnelLog(`${territory.name}の軍制を${newUnit}に改編（費用: 金100）`);
                
                // モーダルを更新
                this.showRecruitModal();
                this.updateStatus();
            }
            
            hideModal() {
                document.getElementById('action-modal').style.display = 'none';
                this.currentAction = null;
            }
            
            executeModalAction() {
                switch (this.currentAction) {
                    case 'attack':
                        this.executeAttack();
                        break;
                    case 'strategy':
                        this.executeStrategy();
                        break;
                    case 'diplomacy':
                        this.executeDiplomacy();
                        break;
                    case 'trade':
                        this.executeTrade();
                        break;
                    case 'recruit':
                        this.executeRecruit();
                        break;
                }
                this.hideModal();
            }
            
            executeAttack() {
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!target || !playerDaimyo) {
                    this.gameState.addLog('攻撃対象または大名データが不正です', 'battle');
                    return;
                }
                
                // 外交協定チェック：相互不可侵条約がある場合は攻撃を禁止
                if (target.owner && this.gameState.diplomacyTreaties[this.gameState.playerDaimyo] && 
                    this.gameState.diplomacyTreaties[this.gameState.playerDaimyo].includes(target.owner)) {
                    const targetDaimyoName = this.gameState.daimyos.find(d => d.id === target.owner)?.name || '相手';
                    this.gameState.addLog(`${targetDaimyoName}とは外交協定を結んでおり攻撃できません`, 'diplomacy');
                    return; // 攻撃を中止
                }
                
                // 防御側の大名データを取得
                let defenderDaimyo = null;
                if (target.owner) {
                    defenderDaimyo = this.gameState.daimyos.find(d => d && d.id === target.owner);
                }
                
                // 戦闘ログ用のデータを初期化
                const battleLog = {
                    events: [],
                    generalActivities: [], // 武将の活躍ログ
                    skillActivations: [], // 特技発動ログ
                    attacker: {
                        name: playerDaimyo.name || '不明',
                        basePower: playerDaimyo.stats?.battle || 50,
                        totalPower: 0,
                        generals: []
                    },
                    defender: {
                        name: defenderDaimyo ? defenderDaimyo.name : '空白地',
                        troops: target.troops || 0,
                        walls: target.walls || 0,
                        basePower: defenderDaimyo ? (defenderDaimyo.stats?.battle || 50) : 30,
                        generals: []
                    },
                    result: {
                        victory: false,
                        troopDamage: 0,
                        wallDamage: 0,
                        conquered: false,
                        skillBonuses: 0,
                        defenderSkillBonuses: 0
                    }
                };
                
                // 軍団戦力を計算
                let attackPower = playerDaimyo.stats?.battle || 50;
                let defensePower = Math.floor((playerDaimyo.stats?.command || 50) / 3);
                let skillBonus = 0; // 特技による追加ボーナス
                
                // プレイヤー領土の兵科ボーナスを計算
                const playerTerritories = this.gameState.getPlayerTerritories();
                let totalUnitBonus = 0;
                let unitBonusCount = 0;
                
                playerTerritories.forEach(territory => {
                    if (territory.troops > 0 && territory.unitType === territory.advantageType) {
                        // 地域特性と一致する兵科は+20%ボーナス
                        const territoryBonus = Math.floor(territory.troops * 0.2);
                        totalUnitBonus += territoryBonus;
                        unitBonusCount++;
                    }
                });
                
                if (totalUnitBonus > 0) {
                    attackPower += Math.floor(totalUnitBonus / 10); // 兵科ボーナスを戦闘力に反映
                    battleLog.events.push({
                        type: 'attack',
                        message: `${unitBonusCount}領土の兵科特性が発動！戦闘力+${Math.floor(totalUnitBonus / 10)}`
                    });
                }
                
                // 三すくみシステム（歩兵＜騎馬＜鉄砲＜歩兵）
                try {
                    // プレイヤーの主力兵科を安全に取得
                    let playerMainUnit = 'infantry'; // デフォルト
                    let maxTroops = 0;
                    
                    playerTerritories.forEach(territory => {
                        if (territory && territory.troops > maxTroops) {
                            maxTroops = territory.troops;
                            playerMainUnit = territory.unitType || 'infantry';
                        }
                    });
                    
                    // 敵の兵科を取得
                    const enemyUnit = target.unitType || 'infantry';
                    
                    // 相性チェック
                    const isAdvantage = (
                        (playerMainUnit === 'cavalry' && enemyUnit === 'infantry') ||
                        (playerMainUnit === 'arquebus' && enemyUnit === 'cavalry') ||
                        (playerMainUnit === 'infantry' && enemyUnit === 'arquebus')
                    );
                    
                    if (isAdvantage) {
                        const unitBonus = Math.floor(attackPower * 0.2); // 1.2倍相当
                        attackPower += unitBonus;
                        
                        const unitNames = { 'infantry': '歩兵', 'cavalry': '騎馬', 'arquebus': '鉄砲' };
                        battleLog.events.push({
                            type: 'attack',
                            message: `兵科相性有利！${unitNames[playerMainUnit]}が${unitNames[enemyUnit]}を圧倒！戦闘力+${unitBonus}`
                        });
                    }
                } catch (error) {
                    // 三すくみ処理でエラーが発生しても戦闘は継続
                }
                
                // 奇襲攻撃判定（攻撃側のみ）
                let surpriseAttackBonus = 1.0;
                let surpriseAttackActivated = false;
                let surpriseAttackLeader = null;
                
                try {
                    // 防御側の城主統率力を取得
                    let defenderCommandValue = 0;
                    
                    // 防御側大名の統率
                    if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.command) {
                        defenderCommandValue = defenderDaimyo.stats.command;
                    }
                    
                    // 城主武将の統率をチェック
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.command) {
                            defenderCommandValue = Math.max(defenderCommandValue, castleCommander.stats.command);
                        }
                    }
                    
                    // 攻撃側武将の中で城主の統率を上回る武将をチェック
                    const eligibleGenerals = [];
                    
                    // 攻撃側大名もチェック
                    if (playerDaimyo && playerDaimyo.stats && playerDaimyo.stats.command > defenderCommandValue) {
                        eligibleGenerals.push({
                            name: playerDaimyo.name,
                            command: playerDaimyo.stats.command,
                            isLord: true
                        });
                    }
                    
                    // 攻撃側の軍団武将をチェック
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    attackPositions.forEach(roleKey => {
                        try {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.command > defenderCommandValue) {
                                    eligibleGenerals.push({
                                        name: general.name,
                                        command: general.stats.command,
                                        role: roleKey,
                                        isLord: false
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn('奇襲攻撃武将チェック中にエラー:', error);
                        }
                    });
                    
                    // 奇襲攻撃発動判定
                    if (eligibleGenerals.length > 0) {
                        // 統率差が大きいほど成功率が高くなる（基本20%、統率差10につき+10%、最大70%）
                        const bestGeneral = eligibleGenerals.reduce((best, current) => 
                            current.command > best.command ? current : best
                        );
                        
                        const commandDifference = bestGeneral.command - defenderCommandValue;
                        const baseChance = 20;
                        const bonusChance = Math.floor(commandDifference / 10) * 10;
                        const surpriseChance = Math.min(70, baseChance + bonusChance);
                        
                        if (Math.random() * 100 <= surpriseChance) {
                            surpriseAttackActivated = true;
                            surpriseAttackLeader = bestGeneral;
                            surpriseAttackBonus = 1.5;
                            
                            // 奇襲攻撃ログ
                            const roleNames = {
                                'armyStrategist': '軍師', 'vanguard': '前衛', 
                                'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                            };
                            
                            let surpriseMessage = '';
                            if (bestGeneral.isLord) {
                                surpriseMessage = `${bestGeneral.name}が見事な統率で奇襲攻撃を成功させた！`;
                            } else {
                                const roleName = roleNames[bestGeneral.role] || '武将';
                                surpriseMessage = `${bestGeneral.name}(${roleName})が絶妙なタイミングで奇襲攻撃を指揮！`;
                            }
                            
                            battleLog.events.push({
                                type: 'attack',
                                message: `【奇襲攻撃発動】${surpriseMessage}`
                            });
                            
                            battleLog.events.push({
                                type: 'victory',
                                message: `統率差${commandDifference}により奇襲が成功！攻撃力が1.5倍に増強された！`
                            });
                        }
                    }
                } catch (error) {
                    console.warn('奇襲攻撃判定中にエラーが発生:', error);
                }
                const positions = {
                    'armyStrategist': { command: 1, intelligence: 1, description: '軍団を指揮' },
                    'vanguard': { battle: 1, command: 1, description: '先頭で敵軍に突撃' },
                    'rightWing': { battle: 1, description: '右翼から側面攻撃' },
                    'leftWing': { battle: 1, description: '左翼から側面攻撃' },
                    'reserve': { command: 1, description: '後方から全軍を支援' }
                };
                
                Object.entries(positions).forEach(([roleKey, stats]) => {
                    try {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.stats) {
                                // 武将の基本情報を記録
                                battleLog.attacker.generals.push({
                                    name: general.name || '無名武将',
                                    role: roleKey,
                                    battle: general.stats.battle || 0,
                                    command: general.stats.command || 0,
                                    skill: general.skill || '特技なし'
                                });
                                
                                // 基本戦力追加
                                let contribution = 0;
                                if (stats.battle && general.stats.battle) {
                                    attackPower += general.stats.battle;
                                    contribution += general.stats.battle;
                                }
                                if (stats.command && general.stats.command) {
                                    const commandBonus = Math.floor(general.stats.command / 3);
                                    defensePower += commandBonus;
                                    contribution += commandBonus;
                                }
                                
                                // 武将の活躍を記録
                                const roleNames = {
                                    'armyStrategist': '参謀', 'vanguard': '前衛', 
                                    'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                                };
                                
                                battleLog.generalActivities.push({
                                    name: general.name || '無名武将',
                                    role: roleNames[roleKey] || roleKey,
                                    action: stats.description || '戦闘に参加',
                                    contribution: Math.max(1, contribution),
                                    side: 'attacker'
                                });
                                
                                // 特技発動チェック
                                try {
                                    const skillActivation = this.checkSkillActivation(general, roleKey, target);
                                    if (skillActivation && skillActivation.activated) {
                                        skillBonus += skillActivation.bonus || 0;
                                        skillActivation.side = 'attacker';
                                        battleLog.skillActivations.push(skillActivation);
                                    }
                                } catch (skillError) {
                                    console.warn('攻撃側特技チェック中にエラー:', skillError);
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('攻撃側武将処理中にエラー:', error);
                    }
                });
                
                // 攻撃側大名の特技もチェック
                try {
                    const daimyoName = playerDaimyo?.name || '大名';
                    let daimyoContribution = Math.floor((playerDaimyo?.stats?.battle || 50) / 2);
                    
                    if (playerDaimyo && playerDaimyo.skill && playerDaimyo.skill !== '特技なし') {
                        const daimyoSkillActivation = this.checkSkillActivation(playerDaimyo, 'general', target);
                        if (daimyoSkillActivation && daimyoSkillActivation.activated) {
                            skillBonus += daimyoSkillActivation.bonus || 0;
                            daimyoSkillActivation.side = 'attacker';
                            battleLog.skillActivations.push(daimyoSkillActivation);
                            daimyoContribution += daimyoSkillActivation.bonus || 0;
                        }
                    }
                    
                    const daimyoAlreadyRecorded = battleLog.generalActivities.some(activity => 
                        activity && activity.name === daimyoName
                    );
                    
                    if (!daimyoAlreadyRecorded) {
                        battleLog.generalActivities.push({
                            name: daimyoName,
                            role: '大将',
                            action: '軍団を総指揮',
                            contribution: Math.max(10, daimyoContribution),
                            side: 'attacker'
                        });
                    }
                } catch (error) {
                    console.warn('攻撃側大名特技チェック中にエラー:', error);
                    if (!battleLog.generalActivities.some(activity => activity && activity.name && activity.name.includes('大名'))) {
                        battleLog.generalActivities.push({
                            name: playerDaimyo?.name || '大名',
                            role: '大将',
                            action: '戦場を指揮',
                            contribution: 10,
                            side: 'attacker'
                        });
                    }
                }
                
                // 防御側の武将編成と戦力計算
                let defenderAttackPower = battleLog.defender.basePower;
                let defenderDefensePower = Math.floor(battleLog.defender.basePower / 3);
                let defenderSkillBonus = 0;
                let defenderGeneralsList = []; // 鉄壁チェック用
                
                if (defenderDaimyo && defenderDaimyo.id) {
                    try {
                        // 防御側AI武将の編成を取得
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        if (defenderRoles) {
                            const defenderGenerals = this.gameState.generals.filter(g => g && g.lord === defenderDaimyo.id);
                            
                            Object.entries(positions).forEach(([roleKey, stats]) => {
                                try {
                                    const generalId = defenderRoles[roleKey];
                                    if (generalId) {
                                        const general = defenderGenerals.find(g => g && g.id === generalId);
                                        if (general && general.stats) {
                                            // 防御側武将の基本情報を記録
                                            battleLog.defender.generals.push({
                                                name: general.name || '無名武将',
                                                role: roleKey,
                                                battle: general.stats.battle || 0,
                                                command: general.stats.command || 0,
                                                skill: general.skill || '特技なし'
                                            });
                                            
                                            defenderGeneralsList.push(general); // 鉄壁チェック用に追加
                                            
                                            // 防御側戦力追加
                                            let contribution = 0;
                                            if (stats.battle && general.stats.battle) {
                                                defenderAttackPower += Math.floor(general.stats.battle * 0.8); // 防御側は若干弱体化
                                                contribution += general.stats.battle;
                                            }
                                            if (stats.command && general.stats.command) {
                                                const commandBonus = Math.floor(general.stats.command / 3);
                                                defenderDefensePower += commandBonus;
                                                contribution += commandBonus;
                                            }
                                            
                                            // 防御側武将の活躍を記録
                                            const roleNames = {
                                                'armyStrategist': '参謀', 'vanguard': '前衛', 
                                                'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                                            };
                                            
                                            const defenseActions = {
                                                'armyStrategist': '守備隊を統率',
                                                'vanguard': '城門を死守',
                                                'rightWing': '右翼から迎撃',
                                                'leftWing': '左翼から迎撃',
                                                'reserve': '後方から援護'
                                            };
                                            
                                            battleLog.generalActivities.push({
                                                name: general.name || '無名武将',
                                                role: roleNames[roleKey] || roleKey,
                                                action: defenseActions[roleKey] || '防御に参加',
                                                contribution: Math.max(1, contribution),
                                                side: 'defender'
                                            });
                                            
                                            // 防御側武将の特技発動チェック
                                            try {
                                                const skillActivation = this.checkSkillActivation(general, roleKey, target);
                                                if (skillActivation && skillActivation.activated) {
                                                    defenderSkillBonus += skillActivation.bonus || 0;
                                                    skillActivation.side = 'defender';
                                                    battleLog.skillActivations.push(skillActivation);
                                                }
                                            } catch (skillError) {
                                                console.warn('防御側特技チェック中にエラー:', skillError);
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.warn('防御側武将処理中にエラー:', error);
                                }
                            });
                        }
                        
                        // 城主武将も鉄壁チェック対象に追加
                        if (target.generalGarrison) {
                            const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                            if (castleCommander) {
                                defenderGeneralsList.push(castleCommander);
                            }
                        }
                        
                        // 防御側大名も鉄壁チェック対象に追加
                        if (defenderDaimyo) {
                            defenderGeneralsList.push(defenderDaimyo);
                        }
                        
                        // 鉄壁防御チェック
                        const ironwallResult = this.checkIronwallDefense(defenderGeneralsList, battleLog);
                        
                        // 防御側大名の特技もチェック
                        try {
                            const defenderDaimyoName = defenderDaimyo?.name || '守備隊長';
                            let defenderDaimyoContribution = Math.floor((defenderDaimyo?.stats?.battle || 50) / 2);
                            
                            if (defenderDaimyo && defenderDaimyo.skill && defenderDaimyo.skill !== '特技なし') {
                                const defenderDaimyoSkillActivation = this.checkSkillActivation(defenderDaimyo, 'general', target);
                                if (defenderDaimyoSkillActivation && defenderDaimyoSkillActivation.activated) {
                                    defenderSkillBonus += defenderDaimyoSkillActivation.bonus || 0;
                                    defenderDaimyoSkillActivation.side = 'defender';
                                    battleLog.skillActivations.push(defenderDaimyoSkillActivation);
                                    defenderDaimyoContribution += defenderDaimyoSkillActivation.bonus || 0;
                                }
                            }
                            
                            const defenderDaimyoAlreadyRecorded = battleLog.generalActivities.some(activity => 
                                activity && activity.name === defenderDaimyoName && activity.side === 'defender'
                            );
                            
                            if (!defenderDaimyoAlreadyRecorded) {
                                battleLog.generalActivities.push({
                                    name: defenderDaimyoName,
                                    role: '総大将',
                                    action: '全軍の守備を指揮',
                                    contribution: Math.max(10, defenderDaimyoContribution),
                                    side: 'defender'
                                });
                            }
                        } catch (error) {
                            console.warn('防御側大名特技チェック中にエラー:', error);
                        }
                        
                    } catch (error) {
                        console.warn('防御側編成処理中にエラー:', error);
                    }
                }
                
                // 最終戦力に特技ボーナスを追加
                attackPower += skillBonus;
                defenderAttackPower += defenderSkillBonus;
                
                // 戦術的駆け引き：前衛・参謀・後詰の能力比較
                let tacticalDamageToDefender = 0;
                let tacticalDamageToAttacker = 0;
                let tacticalDefenseBonus = 0;
                
                try {
                    // 前衛の先制攻撃（戦闘比較）
                    const attackerVanguard = this.gameState.playerRoles.vanguard ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.vanguard) : null;
                    const defenderVanguard = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].vanguard) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].vanguard) : null;
                    
                    const attackerBattle = attackerVanguard ? (attackerVanguard.stats?.battle || 0) : 0;
                    const defenderBattle = defenderVanguard ? (defenderVanguard.stats?.battle || 0) : 0;
                    
                    if (attackerBattle > 0 && defenderBattle > 0) {
                        if (attackerBattle > defenderBattle) {
                            tacticalDamageToDefender += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `【先制攻撃発動】${attackerVanguard.name}(戦闘${attackerBattle})が${defenderVanguard.name}(戦闘${defenderBattle})を圧倒する電光石火の先制攻撃で敵前衛を粉砕！25の損害！`
                            });
                        } else if (defenderBattle > attackerBattle) {
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `【先制攻撃発動】${defenderVanguard.name}(戦闘${defenderBattle})が${attackerVanguard.name}(戦闘${attackerBattle})を上回る武勇で逆襲の先制攻撃！攻撃軍前衛に25の損害！`
                            });
                        }
                    } else if (attackerBattle > 0 && defenderBattle === 0) {
                        tacticalDamageToDefender += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `【先制攻撃発動】${attackerVanguard.name}が前衛なき敵軍に電撃的な先制攻撃を敢行し25の損害！`
                        });
                    } else if (defenderBattle > 0 && attackerBattle === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `【先制攻撃発動】${defenderVanguard.name}が前衛なき攻撃軍に容赦ない迎撃を行い25の損害！`
                        });
                    }
                    
                    // 参謀の陽動攻撃（知謀比較）
                    const attackerStrategist = this.gameState.playerRoles.armyStrategist ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.armyStrategist) : null;
                    const defenderStrategist = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].armyStrategist) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].armyStrategist) : null;
                    
                    const attackerIntelligence = attackerStrategist ? (attackerStrategist.stats?.intelligence || 0) : 0;
                    const defenderIntelligence = defenderStrategist ? (defenderStrategist.stats?.intelligence || 0) : 0;
                    
                    if (attackerIntelligence > 0 && defenderIntelligence > 0) {
                        if (attackerIntelligence > defenderIntelligence) {
                            tacticalDamageToDefender += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `【陽動攻撃発動】${attackerStrategist.name}(知謀${attackerIntelligence})が${defenderStrategist.name}(知謀${defenderIntelligence})を上回る戦術で敵軍を翻弄！陽動により敵に25の損害！`
                            });
                        } else if (defenderIntelligence > attackerIntelligence) {
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `【陽動攻撃発動】${defenderStrategist.name}(知謀${defenderIntelligence})が${attackerStrategist.name}(知謀${attackerIntelligence})を出し抜く巧妙な策で攻撃軍を混乱させ25の損害！`
                            });
                        }
                    } else if (attackerIntelligence > 0 && defenderIntelligence === 0) {
                        tacticalDamageToDefender += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `【陽動攻撃発動】${attackerStrategist.name}が無防備な敵軍に完璧な陽動戦術を仕掛け25の損害！`
                        });
                    } else if (defenderIntelligence > 0 && attackerIntelligence === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `【陽動攻撃発動】${defenderStrategist.name}が策略なき攻撃軍に罠を仕掛け25の損害！`
                        });
                    }
                    
                    // 後詰の反撃軽減（統率比較）
                    const attackerReserve = this.gameState.playerRoles.reserve ? 
                        this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.reserve) : null;
                    const defenderReserve = (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id] && this.gameState.aiRoles[defenderDaimyo.id].reserve) ?
                        this.gameState.generals.find(g => g && g.id === this.gameState.aiRoles[defenderDaimyo.id].reserve) : null;
                    
                    const attackerCommand = attackerReserve ? (attackerReserve.stats?.command || 0) : 0;
                    const defenderCommand = defenderReserve ? (defenderReserve.stats?.command || 0) : 0;
                    
                    if (attackerCommand > 0 && defenderCommand > 0) {
                        if (attackerCommand > defenderCommand) {
                            tacticalDefenseBonus += 25;
                            battleLog.events.push({
                                type: 'attack',
                                message: `【後方支援発動】${attackerReserve.name}(統率${attackerCommand})が${defenderReserve.name}(統率${defenderCommand})を圧倒する完璧な後方支援で敵の反撃を25軽減！`
                            });
                        } else if (defenderCommand > attackerCommand) {
                            // 防御側の反撃軽減は攻撃側へのダメージ増加として実装
                            tacticalDamageToAttacker += 25;
                            battleLog.events.push({
                                type: 'defense',
                                message: `【後方支援発動】${defenderReserve.name}(統率${defenderCommand})が${attackerReserve.name}(統率${attackerCommand})を上回る統率で完璧な反撃態勢を構築し攻撃軍に25の追加損害！`
                            });
                        }
                    } else if (attackerCommand > 0 && defenderCommand === 0) {
                        tacticalDefenseBonus += 25;
                        battleLog.events.push({
                            type: 'attack',
                            message: `【後方支援発動】${attackerReserve.name}が後方支援なき敵軍に対し完璧な統率で反撃を25軽減！`
                        });
                    } else if (defenderCommand > 0 && attackerCommand === 0) {
                        tacticalDamageToAttacker += 25;
                        battleLog.events.push({
                            type: 'defense',
                            message: `【後方支援発動】${defenderReserve.name}が後方支援なき攻撃軍に容赦ない反撃を仕掛け25の損害！`
                        });
                    }
                } catch (error) {
                    console.warn('戦術的駆け引き処理中にエラー:', error);
                }
                
                // 伊達政宗の騎馬鉄砲隊チェック
                let dateCavalryDamage = 0;
                let dateCavalryActivated = false;
                
                if (playerDaimyo.skill === '独眼竜' && Math.random() * 100 <= 60) {
                    // 敵の兵科をチェック
                    const enemyUnit = target.unitType || 'infantry';
                    if (enemyUnit === 'infantry' || enemyUnit === 'cavalry') {
                        dateCavalryActivated = true;
                        dateCavalryDamage = 100;
                        
                        const unitNames = { 'infantry': '歩兵', 'cavalry': '騎馬' };
                        battleLog.events.push({
                            type: 'attack',
                            message: `【騎馬鉄砲隊突撃】独眼竜政宗の騎馬鉄砲隊が${unitNames[enemyUnit]}隊に襲いかかる！防御無視で100の絶対ダメージ！`
                        });
                    }
                }
                
                // 中央突破チェック（特技とは別枠）
                let centralBreakthroughDamage = 0;
                let centralBreakthroughActivator = null;
                let centralBreakthroughAttempted = false;
                
                // 中央突破を持つ武将をチェック
                const centralBreakthroughSkills = {
                    '無傷': 70,
                    '鬼島津': 60,
                    '日本一の兵': 80,
                    '傾奇者': 50,
                    '西国無双': 50,
                    '二刀流': 75
                };
                
                // 攻撃側大名をチェック
                if (playerDaimyo && playerDaimyo.skill && centralBreakthroughSkills[playerDaimyo.skill]) {
                    centralBreakthroughAttempted = true;
                    battleLog.events.push({
                        type: 'attack',
                        message: `${playerDaimyo.name}は中央突破の構えを見せる`
                    });
                    
                    const successRate = centralBreakthroughSkills[playerDaimyo.skill];
                    if (Math.random() * 100 <= successRate) {
                        centralBreakthroughActivator = {
                            name: playerDaimyo.name,
                            skill: playerDaimyo.skill
                        };
                        centralBreakthroughDamage = 100;
                        
                        battleLog.events.push({
                            type: 'victory',
                            message: `【中央突破発動】${playerDaimyo.name}が敵陣中央を真正面から突破！防御無視で100の絶対ダメージ！`
                        });
                    }
                }
                
                // 攻撃側武将をチェック（大名が発動しなかった場合のみ）
                if (!centralBreakthroughActivator) {
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    for (const roleKey of attackPositions) {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.skill && centralBreakthroughSkills[general.skill]) {
                                centralBreakthroughAttempted = true;
                                battleLog.events.push({
                                    type: 'attack',
                                    message: `${general.name}は中央突破の構えを見せる`
                                });
                                
                                const successRate = centralBreakthroughSkills[general.skill];
                                if (Math.random() * 100 <= successRate) {
                                    centralBreakthroughActivator = {
                                        name: general.name,
                                        skill: general.skill
                                    };
                                    centralBreakthroughDamage = 100;
                                    
                                    battleLog.events.push({
                                        type: 'victory',
                                        message: `【中央突破発動】${general.name}が敵陣中央を一気に突破！防御無視で100の絶対ダメージ！`
                                    });
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // 士気判定システム
                const moralePositions = {
                    'general': { rate: 40, charm: playerDaimyo.stats?.charm || 50 },
                    'armyStrategist': { rate: 10 },
                    'vanguard': { rate: 20 },
                    'rightWing': { rate: 10 },
                    'leftWing': { rate: 10 },
                    'reserve': { rate: 10 }
                };
                
                // 攻撃側士気代表選出
                let attackerMoraleLeader = null;
                for (const [roleKey, config] of Object.entries(moralePositions)) {
                    if (Math.random() * 100 <= config.rate) {
                        if (roleKey === 'general') {
                            attackerMoraleLeader = { name: playerDaimyo.name, charm: config.charm };
                        } else {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats) {
                                    attackerMoraleLeader = { name: general.name, charm: general.stats.charm || 50 };
                                }
                            }
                        }
                        break;
                    }
                }
                
                // 防御側士気代表選出
                let defenderMoraleLeader = null;
                if (defenderDaimyo && this.gameState.aiRoles[defenderDaimyo.id]) {
                    const defRoles = this.gameState.aiRoles[defenderDaimyo.id];
                    for (const [roleKey, config] of Object.entries(moralePositions)) {
                        if (Math.random() * 100 <= config.rate) {
                            if (roleKey === 'general') {
                                defenderMoraleLeader = { name: defenderDaimyo.name, charm: defenderDaimyo.stats?.charm || 50 };
                            } else {
                                const generalId = defRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general && general.stats) {
                                        defenderMoraleLeader = { name: general.name, charm: general.stats.charm || 50 };
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                
                // 士気対決と戦力補正
                let moraleBonus = 1.0;
                if (attackerMoraleLeader && defenderMoraleLeader) {
                    if (attackerMoraleLeader.charm > defenderMoraleLeader.charm) {
                        moraleBonus = 1.2;
                        battleLog.events.unshift({
                            type: 'attack',
                            message: `【士気勝利】${attackerMoraleLeader.name}(魅力${attackerMoraleLeader.charm})が${defenderMoraleLeader.name}(魅力${defenderMoraleLeader.charm})を圧倒！攻撃力1.2倍`
                        });
                    } else if (defenderMoraleLeader.charm > attackerMoraleLeader.charm) {
                        battleLog.events.unshift({
                            type: 'defense',
                            message: `【士気勝利】${defenderMoraleLeader.name}(魅力${defenderMoraleLeader.charm})が${attackerMoraleLeader.name}(魅力${attackerMoraleLeader.charm})を圧倒！守備側有利`
                        });
                    }
                } else if (attackerMoraleLeader) {
                    moraleBonus = 1.2;
                    battleLog.events.unshift({
                        type: 'attack',
                        message: `【士気勝利】${attackerMoraleLeader.name}の鼓舞により攻撃力1.2倍`
                    });
                }
                
                attackPower = Math.floor(attackPower * moraleBonus);
                
                // プレイヤー征夷大将軍効果：士気1.2倍
                if (this.gameState.tenkaninStatus[this.gameState.playerDaimyo]) {
                    attackPower = Math.floor(attackPower * 1.2);
                    battleLog.events.push({
                        type: 'attack',
                        message: `【征夷大将軍】${playerDaimyo.name}の軍が幕府の威光により士気1.2倍で進軍！`
                    });
                }
                
                // 奇襲攻撃ボーナスを適用（攻撃力に1.5倍）
                if (surpriseAttackActivated) {
                    attackPower = Math.floor(attackPower * surpriseAttackBonus);
                    battleLog.events.push({
                        type: 'attack',
                        message: `奇襲攻撃により最終攻撃力: ${Math.floor(attackPower / surpriseAttackBonus)} → ${attackPower}`
                    });
                }
                
                battleLog.result.skillBonuses = skillBonus;
                battleLog.result.defenderSkillBonuses = defenderSkillBonus;
                battleLog.result.surpriseAttack = surpriseAttackActivated;
                battleLog.result.surpriseAttackLeader = surpriseAttackLeader;
                battleLog.result.centralBreakthrough = centralBreakthroughDamage > 0;
                battleLog.result.centralBreakthroughActivator = centralBreakthroughActivator;
                battleLog.result.centralBreakthroughAttempted = centralBreakthroughAttempted;
                battleLog.attacker.totalPower = attackPower; // 士気補正後の値
                
                // 武将が配置されていない場合の確認とフォールバック
                if (!battleLog.generalActivities || battleLog.generalActivities.length === 0) {
                    // 大名のみで戦闘を実行する場合
                    battleLog.generalActivities = [{
                        name: playerDaimyo.name || '大名',
                        role: '大将',
                        action: '単独で戦場を指揮',
                        contribution: playerDaimyo.stats?.battle || 50
                    }];
                }
                
                // 防御側の戦力を計算
                if (target.owner) {
                    if (defenderDaimyo) {
                        battleLog.defender.basePower = defenderDaimyo.stats?.battle || 50;
                    }
                } else {
                    battleLog.defender.basePower = 30; // 空白地の基本防御力
                }
                
                // 戦闘計算（攻撃力を少し強化）
                let finalAttackPower = attackPower + Math.random() * 25 + 10; // +10固定ボーナス、ランダム幅拡大
                
                // 鉄壁効果の適用
                if (typeof ironwallResult !== 'undefined' && ironwallResult.activated) {
                    finalAttackPower = Math.floor(finalAttackPower * ironwallResult.multiplier);
                    battleLog.events.push({
                        type: 'defense',
                        message: `鉄壁効果により攻撃力が半減！${ironwallResult.activator}の完璧な守備陣形が攻撃を封じた！`
                    });
                }
                
                // 武田信玄の風林火山効果：騎馬兵科時の騎馬突撃
                if (playerDaimyo.skill === '風林火山') {
                    // プレイヤーの主力兵科を判定
                    let playerMainUnit = 'infantry';
                    let maxTroops = 0;
                    
                    playerTerritories.forEach(territory => {
                        if (territory && territory.troops > maxTroops) {
                            maxTroops = territory.troops;
                            playerMainUnit = territory.unitType || 'infantry';
                        }
                    });
                    
                    if (playerMainUnit === 'cavalry') {
                        const chargeMultiplier = Math.random() * 0.4 + 1.1; // 1.1-1.5倍
                        finalAttackPower = Math.floor(finalAttackPower * chargeMultiplier);
                        
                        battleLog.events.push({
                            type: 'attack',
                            message: `【騎馬突撃発動】武田信玄の風林火山により騎馬隊が疾風迅雷の突撃！戦力が${(chargeMultiplier * 100).toFixed(0)}%に増強！`
                        });
                    }
                }
                const baseDefensePower = defenderAttackPower + defenderSkillBonus;
                let troopDefensePower = Math.floor((target.troops || 0) / 10) + baseDefensePower + Math.random() * 10;
                
                // 上杉謙信の軍神効果：敵守備力半減
                if (playerDaimyo.skill === '軍神') {
                    troopDefensePower = Math.floor(troopDefensePower / 2);
                    battleLog.events.push({
                        type: 'attack',
                        message: `【軍神効果】上杉謙信の神威により敵の守備力が半減！`
                    });
                }
                
                // 強襲攻撃判定用の戦闘値を取得
                const getAttackerBattleValue = () => {
                    let maxBattle = playerDaimyo.stats?.battle || 50;
                    
                    // 攻撃側武将の最高戦闘値を取得
                    const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                    attackPositions.forEach(roleKey => {
                        const generalId = this.gameState.playerRoles[roleKey];
                        if (generalId) {
                            const general = this.gameState.generals.find(g => g && g.id === generalId);
                            if (general && general.stats && general.stats.battle) {
                                maxBattle = Math.max(maxBattle, general.stats.battle);
                            }
                        }
                    });
                    return maxBattle;
                };
                
                const getDefenderBattleValue = () => {
                    let maxBattle = defenderDaimyo ? (defenderDaimyo.stats?.battle || 50) : 30;
                    
                    // 防御側武将の戦闘値をチェック
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.battle) {
                            maxBattle = Math.max(maxBattle, castleCommander.stats.battle);
                        }
                    }
                    
                    // 防御側AI武将の戦闘値もチェック
                    if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        defenderPositions.forEach(roleKey => {
                            const generalId = defenderRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.battle) {
                                    maxBattle = Math.max(maxBattle, general.stats.battle);
                                }
                            }
                        });
                    }
                    return maxBattle;
                };
                
                // 強襲判定関数
                const checkAssaultAttack = (side, phase) => {
                    let assaultResults = [];
                    
                    if (side === 'attacker') {
                        // 攻撃側の強襲判定：大名と各武将をチェック
                        const attackers = [];
                        
                        // 大名をチェック
                        if (playerDaimyo && playerDaimyo.stats && playerDaimyo.stats.battle >= 80) {
                            attackers.push({
                                name: playerDaimyo.name,
                                battleValue: playerDaimyo.stats.battle,
                                isLord: true
                            });
                        }
                        
                        // 軍団武将をチェック
                        const attackPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        attackPositions.forEach(roleKey => {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.battle >= 80) {
                                    attackers.push({
                                        name: general.name,
                                        battleValue: general.stats.battle,
                                        role: roleKey,
                                        isLord: false
                                    });
                                }
                            }
                        });
                        
                        // 各攻撃者について強襲判定
                        attackers.forEach(attacker => {
                            const baseChance = Math.min(30, (attacker.battleValue - 80) * 2 + 15);
                            if (Math.random() * 100 <= baseChance) {
                                const assaultPower = Math.floor(attacker.battleValue / 4) + Math.random() * 10;
                                
                                // 軍神持ちの場合、強襲威力を1.5倍に
                                let finalAssaultPower = assaultPower;
                                let hasGunsin = false;
                                
                                // 攻撃側に軍神持ちがいるかチェック
                                if (attacker.isLord && playerDaimyo && playerDaimyo.skill === '軍神') {
                                    hasGunsin = true;
                                } else if (!attacker.isLord && attacker.role) {
                                    const generalId = this.gameState.playerRoles[attacker.role];
                                    if (generalId) {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId);
                                        if (general && general.skill === '軍神') {
                                            hasGunsin = true;
                                        }
                                    }
                                }
                                
                                if (hasGunsin) {
                                    finalAssaultPower = Math.floor(assaultPower * 1.5);
                                }
                                
                                assaultResults.push({
                                    name: attacker.name,
                                    power: finalAssaultPower,
                                    role: attacker.role,
                                    isLord: attacker.isLord,
                                    hasGunsin: hasGunsin
                                });
                            }
                        });
                        
                    } else {
                        // 防御側の強襲判定
                        const defenders = [];
                        
                        // 防御側大名をチェック
                        if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.battle >= 80) {
                            defenders.push({
                                name: defenderDaimyo.name,
                                battleValue: defenderDaimyo.stats.battle,
                                isLord: true
                            });
                        }
                        
                        // 城主武将をチェック
                        if (target.generalGarrison) {
                            const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                            if (castleCommander && castleCommander.stats && castleCommander.stats.battle >= 80) {
                                defenders.push({
                                    name: castleCommander.name,
                                    battleValue: castleCommander.stats.battle,
                                    role: 'castle_commander',
                                    isLord: false
                                });
                            }
                        }
                        
                        // 防御側AI武将をチェック
                        if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                            const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                            const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                            defenderPositions.forEach(roleKey => {
                                const generalId = defenderRoles[roleKey];
                                if (generalId) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                                    if (general && general.stats && general.stats.battle >= 80) {
                                        defenders.push({
                                            name: general.name,
                                            battleValue: general.stats.battle,
                                            role: roleKey,
                                            isLord: false
                                        });
                                    }
                                }
                            });
                        }
                        
                        // 各防御者について強襲判定
                        defenders.forEach(defender => {
                            const baseChance = Math.min(30, (defender.battleValue - 80) * 2 + 15);
                            if (Math.random() * 100 <= baseChance) {
                                const assaultPower = Math.floor(defender.battleValue / 4) + Math.random() * 10;
                                assaultResults.push({
                                    name: defender.name,
                                    power: assaultPower,
                                    role: defender.role,
                                    isLord: defender.isLord
                                });
                            }
                        });
                    }
                    
                    // 強襲結果をログに記録
                    if (assaultResults.length > 0) {
                        const sideText = side === 'attacker' ? '攻撃軍' : '守備軍';
                        const phaseText = phase === 'troops' ? '兵士戦' : '攻城戦';
                        
                        assaultResults.forEach(result => {
                            const roleNames = {
                                'armyStrategist': '軍師', 'vanguard': '前衛', 
                                'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰',
                                'castle_commander': '城主'
                            };
                            
                            let assaultMessage = '';
                            if (result.isLord) {
                                assaultMessage = `【強襲発動】${result.name}が${phaseText}で強襲攻撃を敢行！`;
                            } else {
                                const roleName = roleNames[result.role] || '武将';
                                assaultMessage = `【強襲発動】${result.name}(${roleName})が${phaseText}で強襲攻撃を敢行！`;
                            }
                            
                            if (result.hasGunsin) {
                                assaultMessage += ` 軍神の加護により威力1.5倍増強！ 追加威力+${Math.floor(result.power)}`;
                            } else {
                                assaultMessage += ` 追加威力+${Math.floor(result.power)}`;
                            }
                            
                            battleLog.events.push({
                                type: side === 'attacker' ? 'attack' : 'defense',
                                message: assaultMessage
                            });
                        });
                    }
                    
                    return assaultResults.reduce((total, result) => total + result.power, 0);
                };
                
                const attackerBattleValue = getAttackerBattleValue();
                const defenderBattleValue = getDefenderBattleValue();
                
                // 敵からの反撃力計算
                const defenderCounterAttack = baseDefensePower + Math.floor((target.troops || 0) / 8) + Math.random() * 15;
                let playerDefensePower = defensePower + Math.random() * 10;
                
                // 織田信長の革新者効果：守備時の鉄砲反撃
                if (target.owner === this.gameState.playerDaimyo && playerDaimyo.skill === '革新者') {
                    // プレイヤーのこの領土の兵科をチェック
                    if (target.unitType === 'arquebus') {
                        const counterMultiplier = Math.random() * 0.1 + 1.3; // 1.3-1.4倍
                        playerDefensePower = Math.floor(playerDefensePower * counterMultiplier);
                        
                        battleLog.events.push({
                            type: 'defense',
                            message: `【鉄砲反撃発動】織田信長の革新的戦術により鉄砲隊が迎撃！反撃力${(counterMultiplier * 100).toFixed(0)}%増強！`
                        });
                    }
                }
                
                battleLog.events.push({
                    type: 'attack',
                    message: `${playerDaimyo.name}の軍団が${target.name}への総攻撃を開始！`
                });
                
                battleLog.events.push({
                    type: 'attack',
                    message: `攻撃軍戦力: ${Math.floor(finalAttackPower)} (基本戦力${playerDaimyo.stats?.battle || 50} + 軍団補正${Math.floor(attackPower - (playerDaimyo.stats?.battle || 50) - skillBonus)} + 特技効果${skillBonus} + 士気補正)`
                });
                
                // 防御側の戦力表示
                const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                if (defenderGeneralsCount > 0) {
                    battleLog.events.push({
                        type: 'defense',
                        message: `${battleLog.defender.name}の軍団${defenderGeneralsCount}名が迎撃態勢！防御戦力: ${Math.floor(baseDefensePower)} (特技効果+${defenderSkillBonus} + 士気補正)`
                    });
                } else {
                    battleLog.events.push({
                        type: 'defense',
                        message: `${battleLog.defender.name}が迎撃態勢を整える！基本防御力: ${Math.floor(baseDefensePower)} (士気補正込み)`
                    });
                }
                
                // 武将の参戦を戦闘イベントに追加（具体的な武将名で）
                try {
                    const attackerGeneralsCount = battleLog.attacker.generals ? battleLog.attacker.generals.length : 0;
                    if (attackerGeneralsCount > 0 && battleLog.attacker.generals) {
                        const attackerNames = battleLog.attacker.generals
                            .filter(g => g && g.name)
                            .map(g => g.name)
                            .slice(0, 4); // 最大4名まで表示
                        
                        if (attackerNames.length > 0) {
                            let participationMessage = '';
                            if (attackerNames.length <= 2) {
                                participationMessage = `${attackerNames.join('、')}が戦線に参加！`;
                            } else if (attackerNames.length <= 4) {
                                participationMessage = `${attackerNames.join('、')}らが戦線に参加！`;
                            } else {
                                participationMessage = `${attackerNames.slice(0, 3).join('、')}ら${attackerGeneralsCount}名が戦線に参加！`;
                            }
                            
                            battleLog.events.push({
                                type: 'attack',
                                message: participationMessage
                            });
                        }
                    }
                } catch (error) {
                    console.warn('攻撃側武将参戦ログ作成中にエラー:', error);
                    // フォールバック表示
                    const attackerGeneralsCount = battleLog.attacker.generals ? battleLog.attacker.generals.length : 0;
                    if (attackerGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'attack',
                            message: `攻撃軍配下武将${attackerGeneralsCount}名が戦線に参加！`
                        });
                    }
                }
                
                try {
                    const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                    if (defenderGeneralsCount > 0 && battleLog.defender.generals) {
                        const defenderNames = battleLog.defender.generals
                            .filter(g => g && g.name)
                            .map(g => g.name)
                            .slice(0, 4); // 最大4名まで表示
                        
                        if (defenderNames.length > 0) {
                            let defenseMessage = '';
                            if (defenderNames.length <= 2) {
                                defenseMessage = `${defenderNames.join('、')}が防衛線を構築！`;
                            } else if (defenderNames.length <= 4) {
                                defenseMessage = `${defenderNames.join('、')}らが防衛線を構築！`;
                            } else {
                                defenseMessage = `${defenderNames.slice(0, 3).join('、')}ら${defenderGeneralsCount}名が防衛線を構築！`;
                            }
                            
                            battleLog.events.push({
                                type: 'defense',
                                message: defenseMessage
                            });
                        }
                    }
                } catch (error) {
                    console.warn('防御側武将参戦ログ作成中にエラー:', error);
                    // フォールバック表示
                    const defenderGeneralsCount = battleLog.defender.generals ? battleLog.defender.generals.length : 0;
                    if (defenderGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `守備軍配下武将${defenderGeneralsCount}名が防衛線を構築！`
                        });
                    }
                }
                
                // 特技発動を戦闘イベントに追加
                if (battleLog.skillActivations && battleLog.skillActivations.length > 0) {
                    const attackerSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'attacker');
                    const defenderSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'defender');
                    
                    if (attackerSkills.length > 0) {
                        battleLog.events.push({
                            type: 'victory',
                            message: `攻撃軍の特技が${attackerSkills.length}個発動！戦況に大きな影響を与えた`
                        });
                    }
                    
                    if (defenderSkills.length > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `守備軍の特技が${defenderSkills.length}個発動！守りを固めた`
                        });
                    }
                }
                
                // 双方向戦闘の開始
                battleLog.events.push({
                    type: 'attack',
                    message: `激しい戦闘が開始された！両軍が激突する！`
                });
                
                // プレイヤー軍の損害計算（敵からの反撃 + 戦術的ダメージ）
                let playerCasualties = 0;
                
                // 戦術的ダメージを先に適用
                if (tacticalDamageToAttacker > 0) {
                    playerCasualties += tacticalDamageToAttacker;
                    battleLog.events.push({
                        type: 'damage',
                        message: `戦術的攻撃により攻撃軍に${tacticalDamageToAttacker}の損害が発生`
                    });
                }
                
                // 通常の反撃ダメージ（後詰による軽減を適用）
                let effectiveCounterAttack = Math.max(0, defenderCounterAttack - tacticalDefenseBonus);
                if (tacticalDefenseBonus > 0) {
                    battleLog.events.push({
                        type: 'attack',
                        message: `後方支援により敵の反撃力${defenderCounterAttack}→${effectiveCounterAttack}に軽減！`
                    });
                }
                
                if (effectiveCounterAttack > playerDefensePower) {
                    const additionalCasualties = Math.floor((effectiveCounterAttack - playerDefensePower) * (Math.random() * 0.4 + 0.2));
                    playerCasualties += additionalCasualties;
                    
                    if (defenderGeneralsCount > 0) {
                        battleLog.events.push({
                            type: 'defense',
                            message: `${battleLog.defender.name}の反撃！配下武将が奮戦し攻撃軍に${playerCasualties}の損害を与えた`
                        });
                    } else {
                        battleLog.events.push({
                            type: 'defense',
                            message: `${battleLog.defender.name}の反撃により攻撃軍に${playerCasualties}の損害が発生`
                        });
                    }
                    
                    // プレイヤーの領土から兵力を減らす
                    const playerTerritories = this.gameState.getPlayerTerritories();
                    if (playerTerritories.length > 0) {
                        // 最も兵力の多い領土から損害を差し引く
                        const strongestTerritory = playerTerritories.reduce((strongest, current) => 
                            (current.troops || 0) > (strongest.troops || 0) ? current : strongest
                        );
                        
                        const originalTroops = strongestTerritory.troops || 0;
                        strongestTerritory.troops = Math.max(0, originalTroops - playerCasualties);
                        
                        if (strongestTerritory.troops < originalTroops) {
                            battleLog.events.push({
                                type: 'damage',
                                message: `${strongestTerritory.name}の守備兵が${originalTroops}→${strongestTerritory.troops}に減少`
                            });
                        }
                    }
                } else {
                    battleLog.events.push({
                        type: 'attack',
                        message: `攻撃軍の防御が堅く、敵の反撃を最小限に抑えた`
                    });
                    // 小規模な損害は発生
                    playerCasualties = Math.floor(Math.random() * 5);
                    if (playerCasualties > 0) {
                        battleLog.events.push({
                            type: 'damage',
                            message: `それでも小規模な損害${playerCasualties}が発生`
                        });
                        
                        const playerTerritories = this.gameState.getPlayerTerritories();
                        if (playerTerritories.length > 0) {
                            const randomTerritory = playerTerritories[Math.floor(Math.random() * playerTerritories.length)];
                            randomTerritory.troops = Math.max(0, (randomTerritory.troops || 0) - playerCasualties);
                        }
                    }
                }
                
                // 記録用に損害を保存
                battleLog.result.playerCasualties = playerCasualties;
                
                if (target.troops > 0) {
                    // 第1段階: 兵数への攻撃
                    battleLog.events.push({
                        type: 'defense',
                        message: `${target.name}の守備兵${target.troops}が迎撃態勢を整える！防御力: ${Math.floor(troopDefensePower)}`
                    });
                    
                    // 騎馬鉄砲隊による防御無視ダメージを先に適用
                    if (dateCavalryDamage > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - dateCavalryDamage);
                        
                        battleLog.result.troopDamage += dateCavalryDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `騎馬鉄砲隊の突撃により守備兵に${dateCavalryDamage}の防御無視ダメージ！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の守備兵: ${previousTroops} → ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `騎馬鉄砲隊の猛攻により守備兵が壊滅！城への総攻撃を開始する`
                            });
                        }
                    }
                    
                    // 戦術的ダメージを先に適用
                    if (tacticalDamageToDefender > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - tacticalDamageToDefender);
                        
                        battleLog.result.troopDamage += tacticalDamageToDefender;
                        battleLog.events.push({
                            type: 'victory',
                            message: `戦術的攻撃により守備兵に${tacticalDamageToDefender}の直接損害！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の守備兵: ${previousTroops} → ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `戦術的攻撃により守備兵が壊滅！城への総攻撃を開始する`
                            });
                        }
                    }
                    
                    // 中央突破による防御無視ダメージを先に適用
                    if (centralBreakthroughDamage > 0) {
                        const previousTroops = target.troops;
                        target.troops = Math.max(0, target.troops - centralBreakthroughDamage);
                        
                        battleLog.result.troopDamage = centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `中央突破により防御無視で守備兵に${centralBreakthroughDamage}の絶対ダメージ！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の守備兵: ${previousTroops} → ${target.troops}`
                        });
                        
                        if (target.troops === 0) {
                            battleLog.events.push({
                                type: 'victory',
                                message: `中央突破により守備兵が瞬時に全滅！城への総攻撃を開始する`
                            });
                        }
                    }
                    
                    // 通常の戦闘判定（中央突破で兵がまだ残っている場合）
                    if (target.troops > 0) {
                        // 戦闘開始時の強襲判定
                        let attackerAssaultBonus = 0;
                        let defenderAssaultBonus = 0;
                        
                        // 攻撃側強襲判定（最大3回まで）
                        for (let i = 0; i < 3; i++) {
                            const assault = checkAssaultAttack('attacker', 'troops');
                            if (assault > 0) {
                                attackerAssaultBonus += assault;
                            } else {
                                break; // 失敗したら終了
                            }
                        }
                        
                        // 防御側強襲判定（最大3回まで）
                        for (let i = 0; i < 3; i++) {
                            const assault = checkAssaultAttack('defender', 'troops');
                            if (assault > 0) {
                                defenderAssaultBonus += assault;
                            } else {
                                break; // 失敗したら終了
                            }
                        }
                        
                        // 強襲ボーナスを戦闘力に適用（攻撃力強化）
                        const adjustedAttackPower = finalAttackPower + attackerAssaultBonus + 8; // +8追加ボーナス
                        const adjustedDefensePower = troopDefensePower + defenderAssaultBonus;
                        
                        if (adjustedAttackPower > adjustedDefensePower) {
                            const damage = Math.floor((adjustedAttackPower - adjustedDefensePower) * (Math.random() * 0.5 + 0.5));
                            const previousTroops = target.troops;
                            target.troops = Math.max(0, target.troops - damage);
                            
                            battleLog.result.troopDamage += damage; // 中央突破ダメージに追加
                            battleLog.events.push({
                                type: 'damage',
                                message: `通常攻撃が成功！守備兵にさらに${damage}の損害を与えた`
                            });
                            
                            battleLog.events.push({
                                type: 'damage',
                                message: `${target.name}の守備兵: ${previousTroops} → ${target.troops}`
                            });
                            
                            if (target.troops === 0) {
                                battleLog.events.push({
                                    type: 'victory',
                                    message: `${target.name}の守備兵が完全に全滅！城への総攻撃を開始する`
                                });
                            }
                        } else {
                            battleLog.events.push({
                                type: 'defense',
                                message: `守備兵の奮戦により通常攻撃を防御された`
                            });
                        }
                    }
                } else {
                    // 兵数が既に0の場合、戦術的ダメージを城壁に適用
                    if (tacticalDamageToDefender > 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - tacticalDamageToDefender);
                        
                        battleLog.result.wallDamage = tacticalDamageToDefender;
                        battleLog.events.push({
                            type: 'victory',
                            message: `戦術的攻撃により城壁に${tacticalDamageToDefender}の直接損害！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の城壁: ${previousWalls} → ${target.walls}`
                        });
                    }
                    
                    // 中央突破ダメージを城壁に適用
                    if (centralBreakthroughDamage > 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - centralBreakthroughDamage);
                        
                        battleLog.result.wallDamage += centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `中央突破により防御無視で城壁に${centralBreakthroughDamage}の絶対ダメージ！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の城壁: ${previousWalls} → ${target.walls}`
                        });
                    }
                } 
                
                if (target.troops === 0) {
                    // 第2段階: 城壁への攻撃（兵数が0の場合のみ）
                    let wallDefensePower = Math.floor(target.walls / 5) + Math.random() * 10;
                    
                    // 攻城戦での守備武将能力を追加
                    let siegeDefenderBonus = 0;
                    
                    // 城主武将の統率力を攻城戦守備力に追加
                    if (target.generalGarrison) {
                        const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                        if (castleCommander && castleCommander.stats && castleCommander.stats.command) {
                            siegeDefenderBonus += Math.floor(castleCommander.stats.command / 5);
                            battleLog.events.push({
                                type: 'defense',
                                message: `城主${castleCommander.name}(統率${castleCommander.stats.command})が城壁防御を指揮！守備力+${Math.floor(castleCommander.stats.command / 5)}`
                            });
                        }
                    }
                    
                    // 防御側大名の統率力も攻城戦守備力に追加
                    if (defenderDaimyo && defenderDaimyo.stats && defenderDaimyo.stats.command) {
                        const daimyoDefenseBonus = Math.floor(defenderDaimyo.stats.command / 8);
                        siegeDefenderBonus += daimyoDefenseBonus;
                        battleLog.events.push({
                            type: 'defense',
                            message: `${defenderDaimyo.name}(統率${defenderDaimyo.stats.command})の指揮により城壁守備力+${daimyoDefenseBonus}`
                        });
                    }
                    
                    // 防御側軍団武将の統率力も攻城戦守備力に追加
                    if (defenderDaimyo && defenderDaimyo.id && this.gameState.aiRoles && this.gameState.aiRoles[defenderDaimyo.id]) {
                        const defenderRoles = this.gameState.aiRoles[defenderDaimyo.id];
                        const defenderPositions = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                        
                        defenderPositions.forEach(roleKey => {
                            const generalId = defenderRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats && general.stats.command) {
                                    const roleDefenseBonus = Math.floor(general.stats.command / 10);
                                    if (roleDefenseBonus > 0) {
                                        siegeDefenderBonus += roleDefenseBonus;
                                        
                                        const roleNames = {
                                            'armyStrategist': '軍師', 'vanguard': '前衛', 
                                            'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                                        };
                                        const roleName = roleNames[roleKey] || roleKey;
                                        
                                        battleLog.events.push({
                                            type: 'defense',
                                            message: `${general.name}(${roleName})の統率により城壁守備力+${roleDefenseBonus}`
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // 守備武将ボーナスを適用
                    wallDefensePower += siegeDefenderBonus;
                    
                    // 上杉謙信の軍神効果：城壁守備力も半減
                    if (playerDaimyo.skill === '軍神') {
                        wallDefensePower = Math.floor(wallDefensePower / 2);
                        battleLog.events.push({
                            type: 'attack',
                            message: `【軍神効果】城壁への攻撃でも敵の守備力が半減！`
                        });
                    }
                    
                    battleLog.events.push({
                        type: 'attack',
                        message: `城壁への攻城戦開始！城壁強度: ${target.walls}, 防御力: ${Math.floor(wallDefensePower)}`
                    });
                    
                    // 中央突破による防御無視ダメージを先に適用（兵がいない場合）
                    if (centralBreakthroughDamage > 0 && battleLog.result.troopDamage === 0) {
                        const previousWalls = target.walls;
                        target.walls = Math.max(0, target.walls - centralBreakthroughDamage);
                        
                        battleLog.result.wallDamage = centralBreakthroughDamage;
                        battleLog.events.push({
                            type: 'victory',
                            message: `中央突破により防御無視で城壁に${centralBreakthroughDamage}の絶対ダメージ！`
                        });
                        
                        battleLog.events.push({
                            type: 'damage',
                            message: `${target.name}の城壁: ${previousWalls} → ${target.walls}`
                        });
                        
                        if (target.walls <= 0) {
                            // 中央突破で城壁破壊完了の場合は後の処理へ
                        }
                    }
                    
                    // 通常の攻城戦（城壁がまだ残っている場合）
                    if (target.walls > 0) {
                        // 攻城戦での強襲判定
                        let siegeAttackerAssaultBonus = 0;
                        let siegeDefenderAssaultBonus = 0;
                        
                        // 攻撃側強襲判定（攻城戦）
                        for (let i = 0; i < 3; i++) { // 最大3回まで判定
                            const assault = checkAssaultAttack('attacker', 'siege');
                            if (assault > 0) {
                                siegeAttackerAssaultBonus += assault;
                            } else {
                                break; // 失敗したら終了
                            }
                        }
                        
                        // 防御側強襲判定（攻城戦）
                        for (let i = 0; i < 3; i++) { // 最大3回まで判定
                            const assault = checkAssaultAttack('defender', 'siege');
                            if (assault > 0) {
                                siegeDefenderAssaultBonus += assault;
                            } else {
                                break; // 失敗したら終了
                            }
                        }
                        
                        // 強襲ボーナスを適用した攻城戦（攻撃力強化）
                        const adjustedSiegeAttack = finalAttackPower + siegeAttackerAssaultBonus + 12; // +12追加ボーナス
                        const adjustedWallDefense = wallDefensePower + siegeDefenderAssaultBonus;
                        
                        if (adjustedSiegeAttack > adjustedWallDefense) {
                            const wallDamage = Math.floor((adjustedSiegeAttack - adjustedWallDefense) * (Math.random() * 0.4 + 0.3));
                            const previousWalls = target.walls;
                            target.walls = Math.max(0, target.walls - wallDamage);
                            
                            battleLog.result.wallDamage += wallDamage; // 中央突破ダメージに追加
                            battleLog.events.push({
                                type: 'damage',
                                message: `攻城兵器が城壁にさらに${wallDamage}の損傷を与えた`
                            });
                            
                            battleLog.events.push({
                                type: 'damage',
                                message: `${target.name}の城壁: ${previousWalls} → ${target.walls}`
                            });
                        } else {
                            battleLog.events.push({
                                type: 'defense',
                                message: `城壁が堅固すぎて通常の攻城兵器では破壊できなかった`
                            });
                        }
                    }
                    
                    // 城壁が完全に破壊された場合の処理
                    if (target.walls <= 0) {
                        // 城壁破壊で領土陥落
                        const previousOwner = target.owner ? 
                            this.gameState.daimyos.find(d => d.id === target.owner)?.name || '不明勢力' : 
                            '空白地';
                        
                        target.owner = this.gameState.playerDaimyo;
                        target.troops = Math.floor(attackPower / 5); // 新たな守備兵配置
                        target.walls = 100; // 奪取直後は100スタート
                        
                        // 新領土に大名の得意兵科を設定
                        const playerDaimyo = this.gameState.getPlayerDaimyoData();
                        if (playerDaimyo && playerDaimyo.preferredUnit) {
                            target.unitType = playerDaimyo.preferredUnit;
                        } else {
                            target.unitType = 'infantry'; // デフォルトは歩兵
                        }
                        
                        battleLog.result.conquered = true;
                        battleLog.result.victory = true;
                        
                        battleLog.events.push({
                            type: 'victory',
                            message: `城壁が完全に崩壊！${target.name}が陥落した！`
                        });
                        
                        if (previousOwner !== '空白地') {
                            battleLog.events.push({
                                type: 'victory',
                                message: `${previousOwner}の支配から${target.name}を奪取！新たな守備兵${target.troops}を配置`
                            });
                        } else {
                            battleLog.events.push({
                                type: 'victory',
                                message: `${target.name}を新領土として確保！新たな守備兵${target.troops}を配置`
                            });
                        }
                        
                        // 一般ログにも追加（武将の活躍を簡潔に表示）
                        let conquestLog = `${target.name}攻略成功！`;
                        if (surpriseAttackActivated && surpriseAttackLeader) {
                            conquestLog += ` ${surpriseAttackLeader.name}の奇襲攻撃が決定打に！`;
                        }
                        if (centralBreakthroughDamage > 0 && centralBreakthroughActivator) {
                            conquestLog += ` ${centralBreakthroughActivator.name}の中央突破で敵陣を粉砕！`;
                        }
                        if (playerCasualties > 0) {
                            conquestLog += ` (我軍損害: ${playerCasualties})`;
                        }
                        this.gameState.addLog(conquestLog, 'battle');
                        
                        // 活躍した武将を具体的にログ表示
                        try {
                            if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                                const attackerActivities = battleLog.generalActivities.filter(activity => 
                                    activity && activity.name && (!activity.side || activity.side === 'attacker')
                                );
                                
                                if (attackerActivities.length > 0) {
                                    const topContributors = attackerActivities
                                        .sort((a, b) => (b.contribution || 0) - (a.contribution || 0))
                                        .slice(0, 3); // 上位3名まで
                                    
                                    const contributorNames = topContributors
                                        .filter(g => g && g.name)
                                        .map(g => g.name);
                                    
                                    if (contributorNames.length > 0) {
                                        let contributionMessage = '';
                                        if (contributorNames.length === 1) {
                                            contributionMessage = `${contributorNames[0]}が奮戦`;
                                        } else if (contributorNames.length === 2) {
                                            contributionMessage = `${contributorNames.join('、')}が奮戦`;
                                        } else {
                                            contributionMessage = `${contributorNames.join('、')}らが奮戦`;
                                        }
                                        this.gameState.addLog(contributionMessage, 'battle');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('武将活躍ログ作成中にエラー:', error);
                            // フォールバック表示
                            if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                                const attackerCount = battleLog.generalActivities.filter(activity => 
                                    activity && (!activity.side || activity.side === 'attacker')
                                ).length;
                                if (attackerCount > 0) {
                                    this.gameState.addLog(`配下武将${attackerCount}名が奮戦`, 'battle');
                                }
                            }
                        }
                        
                        // 特技発動を具体的にログ表示
                        try {
                            const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated && s.name && s.skill);
                            if (activatedSkills.length > 0) {
                                const attackerSkills = activatedSkills.filter(s => s.side === 'attacker' || !s.side);
                                const defenderSkills = activatedSkills.filter(s => s.side === 'defender');
                                
                                if (attackerSkills.length === 1 && defenderSkills.length === 0) {
                                    this.gameState.addLog(`${attackerSkills[0].name}の「${attackerSkills[0].skill}」が発動`, 'battle');
                                } else if (defenderSkills.length === 1 && attackerSkills.length === 0) {
                                    this.gameState.addLog(`敵${defenderSkills[0].name}の「${defenderSkills[0].skill}」が発動`, 'battle');
                                } else if (attackerSkills.length > 0 && defenderSkills.length > 0) {
                                    this.gameState.addLog(`両軍特技${attackerSkills.length + defenderSkills.length}個が発動し激戦に`, 'battle');
                                } else if (attackerSkills.length > 0) {
                                    if (attackerSkills.length === 1) {
                                        this.gameState.addLog(`${attackerSkills[0].name}の「${attackerSkills[0].skill}」が発動`, 'battle');
                                    } else {
                                        this.gameState.addLog(`特技${attackerSkills.length}個が発動し戦況が有利に`, 'battle');
                                    }
                                } else if (defenderSkills.length > 0) {
                                    if (defenderSkills.length === 1) {
                                        this.gameState.addLog(`敵${defenderSkills[0].name}の「${defenderSkills[0].skill}」が発動`, 'battle');
                                    } else {
                                        this.gameState.addLog(`敵特技${defenderSkills.length}個が発動し守りを固める`, 'battle');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('特技ログ作成中にエラー:', error);
                            // フォールバック表示
                            try {
                                const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated);
                                if (activatedSkills.length > 0) {
                                    const attackerSkillCount = activatedSkills.filter(s => s.side === 'attacker' || !s.side).length;
                                    const defenderSkillCount = activatedSkills.filter(s => s.side === 'defender').length;
                                    
                                    if (attackerSkillCount > 0 && defenderSkillCount > 0) {
                                        this.gameState.addLog(`両軍特技${attackerSkillCount + defenderSkillCount}個が発動し激戦に`, 'battle');
                                    } else if (attackerSkillCount > 0) {
                                        this.gameState.addLog(`特技${attackerSkillCount}個が発動し戦況が有利に`, 'battle');
                                    }
                                }
                            } catch (fallbackError) {
                                console.warn('特技ログフォールバック表示中にエラー:', fallbackError);
                            }
                        }
                        
                        // 中央突破をターンイベントに追加
                        if (centralBreakthroughActivator) {
                            this.gameState.turnEvents.push({
                                type: 'battle',
                                message: `${centralBreakthroughActivator.name}の中央突破により${target.name}を電撃攻略！`
                            });
                        }
                    } else {
                        battleLog.events.push({
                            type: 'defense',
                            message: `城壁に損傷を与えたが、まだ堅固な守りを保っている`
                        });
                    }
                }
                
                // 戦闘ログモーダルを表示
                this.displayBattleLog(battleLog);
                
                // 戦闘結果の統合ログ表示（重複防止）
                if (!battleLog.result.conquered && (battleLog.result.troopDamage > 0 || battleLog.result.wallDamage > 0)) {
                    // 部分的成功の場合はここでまとめてログ表示
                    let partialSuccessLog = `${target.name}に損害を与えた`;
                    if (surpriseAttackActivated && surpriseAttackLeader) {
                        partialSuccessLog += ` (${surpriseAttackLeader.name}の奇襲が効果的)`;
                    }
                    if (centralBreakthroughDamage > 0 && centralBreakthroughActivator) {
                        partialSuccessLog += ` (${centralBreakthroughActivator.name}の中央突破で大打撃)`;
                    }
                    if (playerCasualties > 0) {
                        partialSuccessLog += ` (我軍損害: ${playerCasualties})`;
                    }
                    this.gameState.addLog(partialSuccessLog, 'battle');
                    
                    // 中央突破をターンイベントに追加（部分的成功時）
                    if (centralBreakthroughActivator) {
                        this.gameState.turnEvents.push({
                            type: 'battle',
                            message: `${centralBreakthroughActivator.name}の中央突破により${target.name}に大打撃！`
                        });
                    }
                    
                    // 武将活躍ログ（部分的成功時）
                    try {
                        if (battleLog.generalActivities && battleLog.generalActivities.length > 0) {
                            const attackerActivities = battleLog.generalActivities.filter(activity => 
                                activity && activity.name && (!activity.side || activity.side === 'attacker')
                            );
                            
                            if (attackerActivities.length > 0) {
                                const topContributors = attackerActivities
                                    .sort((a, b) => (b.contribution || 0) - (a.contribution || 0))
                                    .slice(0, 2); // 上位2名まで
                                
                                const contributorNames = topContributors
                                    .filter(g => g && g.name)
                                    .map(g => g.name);
                                
                                if (contributorNames.length > 0) {
                                    let contributionMessage = '';
                                    if (contributorNames.length === 1) {
                                        contributionMessage = `${contributorNames[0]}が活躍`;
                                    } else {
                                        contributionMessage = `${contributorNames.join('、')}が活躍`;
                                    }
                                    this.gameState.addLog(contributionMessage, 'battle');
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('部分的成功時の武将ログ作成中にエラー:', error);
                    }
                    
                    // 特技発動の簡潔なログ（部分的成功時）
                    try {
                        const activatedSkills = battleLog.skillActivations.filter(s => s && s.activated);
                        if (activatedSkills.length > 0) {
                            const attackerSkills = activatedSkills.filter(s => s.side === 'attacker' || !s.side);
                            const defenderSkills = activatedSkills.filter(s => s.side === 'defender');
                            
                            if (attackerSkills.length > 0 && defenderSkills.length > 0) {
                                this.gameState.addLog(`両軍特技${attackerSkills.length + defenderSkills.length}個が発動し激戦に`, 'battle');
                            } else if (attackerSkills.length === 1 && defenderSkills.length === 0) {
                                if (attackerSkills[0].name && attackerSkills[0].skill) {
                                    this.gameState.addLog(`${attackerSkills[0].name}の「${attackerSkills[0].skill}」が発動`, 'battle');
                                } else {
                                    this.gameState.addLog(`特技${attackerSkills.length}個が発動`, 'battle');
                                }
                            } else if (attackerSkills.length > 1) {
                                this.gameState.addLog(`特技${attackerSkills.length}個が発動`, 'battle');
                            } else if (defenderSkills.length === 1) {
                                if (defenderSkills[0].name && defenderSkills[0].skill) {
                                    this.gameState.addLog(`敵${defenderSkills[0].name}の「${defenderSkills[0].skill}」が発動し守りを固める`, 'battle');
                                } else {
                                    this.gameState.addLog(`敵特技${defenderSkills.length}個が発動し守りを固める`, 'battle');
                                }
                            } else if (defenderSkills.length > 1) {
                                this.gameState.addLog(`敵特技${defenderSkills.length}個が発動し守りを固める`, 'battle');
                            }
                        }
                    } catch (error) {
                        console.warn('部分的成功時の特技ログ作成中にエラー:', error);
                    }
                }
                
                this.gameState.attackUsed = true;
                this.updateActionButtons();
                this.renderMap();
                this.updateStatus();
            }
            
            // 鉄壁防御チェック（隠れ特技）
            checkIronwallDefense(defenderGenerals, battleLog) {
                try {
                    const ironwallRates = {
                        '立花道雪': 80,
                        '長野業正': 70,
                        '北条綱成': 65,
                        '鍋島直茂': 65,
                        '真田幸村': 60,
                        '山中鹿之介': 55,
                        '高橋紹運': 45,
                        '高坂昌信': 45
                    };
                    
                    // 鉄壁持ちの武将をチェック
                    const ironwallGenerals = defenderGenerals.filter(general => 
                        general && general.name && ironwallRates[general.name]
                    );
                    
                    if (ironwallGenerals.length === 0) {
                        return { activated: false, multiplier: 1.0 };
                    }
                    
                    let ironwallActivated = false;
                    let activatorName = '';
                    
                    // 各鉄壁武将について判定（成功率の高い順）
                    ironwallGenerals.sort((a, b) => ironwallRates[b.name] - ironwallRates[a.name]);
                    
                    for (const general of ironwallGenerals) {
                        const rate = ironwallRates[general.name];
                        
                        // 準備コメント（成功失敗関係なく表示）
                        battleLog.events.push({
                            type: 'defense',
                            message: `${general.name}は鉄壁の陣を敷こうとしている...`
                        });
                        
                        // 発動判定
                        if (Math.random() * 100 <= rate) {
                            ironwallActivated = true;
                            activatorName = general.name;
                            
                            // 成功時の派手なコメント
                            const ironwallMessages = {
                                '立花道雪': `【鉄壁発動】雷神立花道雪が完璧な鉄壁陣形を構築！神雷の如き守備で敵の攻撃を完全に封殺！`,
                                '長野業正': `【鉄壁発動】上野の黄斑長野業正が箕輪城の鉄壁戦術を展開！関東随一の守備で敵の猛攻を完全に封じ込める！`,
                                '北条綱成': `【鉄壁発動】地黄八幡北条綱成が鉄壁の陣を敷く！黄金の采配旗のもと、敵軍の攻撃を完全に粉砕！`,
                                '鍋島直茂': `【鉄壁発動】肥前の智将鍋島直茂が化け猫の如き神速の采配で鉄壁の守りを完成！敵軍の攻撃が霧散した！`,
                                '真田幸村': `【鉄壁発動】日本一の兵真田幸村が真田丸の要塞で鉄壁の防御！赤備えの精鋭が敵軍の攻撃を完全に封殺！`,
                                '山中鹿之介': `【鉄壁発動】山中鹿之介が七難八苦を乗り越えた不屈の精神で鉄壁の守りを構築！三日月の加護により攻撃を無効化！`,
                                '高橋紹運': `【鉄壁発動】忠臣高橋紹運が主君への忠義を込めて鉄壁の守備を展開！その意志は岩をも砕く！`,
                                '高坂昌信': `【鉄壁発動】逃げ弾正高坂昌信が巧妙な戦術で攻撃を完全に封じ込める！その守備戦術は芸術の域！`
                            };
                            
                            battleLog.events.push({
                                type: 'victory',
                                message: ironwallMessages[general.name] || `【鉄壁発動】${general.name}の鉄壁の陣により敵の攻撃を半減！`
                            });
                            
                            break; // 一人が成功したら終了
                        }
                    }
                    
                    return {
                        activated: ironwallActivated,
                        multiplier: ironwallActivated ? 0.5 : 1.0,
                        activator: activatorName
                    };
                } catch (error) {
                    console.warn('鉄壁防御チェック中にエラー:', error);
                    return { activated: false, multiplier: 1.0 };
                }
            }
            
            checkSkillActivation(general, roleKey, target) {
                try {
                    // 安全な初期値設定
                    const skillData = {
                        activated: false,
                        name: general?.name || '無名武将',
                        skill: general?.skill || '特技なし',
                        description: '',
                        bonus: 0
                    };
                    
                    // 入力値の安全性チェック
                    if (!general || !general.stats) {
                        return skillData;
                    }
                    
                    // 特技なしの場合は発動しない
                    if (!general.skill || general.skill === '特技なし' || general.skill === '') {
                        return skillData;
                    }
                    
                    // 発動率を低めに設定（5-25%の範囲）
                    const battleStat = Math.max(0, Math.min(100, general.stats.battle || 50));
                    const baseChance = Math.min(25, Math.max(5, battleStat / 4));
                    const roll = Math.random() * 100;
                    
                    // 発動判定
                    if (roll > baseChance) {
                        return skillData; // 発動しない
                    }
                    
                    // 特技別の効果
                    skillData.activated = true;
                    
                    switch (general.skill) {
                        case '革新者':
                            skillData.description = '鉄砲隊を指揮して敵陣を破砕！守備時は鉄砲兵科で反撃力1.3-1.4倍！';
                            skillData.bonus = 15;
                            break;
                        case '風林火山':
                            skillData.description = '騎馬隊が疾風のごとく敵軍を突破！騎馬兵科時は必ず騎馬突撃発動！';
                            skillData.bonus = 20;
                            break;
                        case '軍神':
                            skillData.description = '神がかりの采配で戦況を一変！さらに全軍の強襲威力が1.5倍、敵の守備力を半減させる！';
                            skillData.bonus = 25;
                            break;
                        case '忍耐':
                            skillData.description = '堅実な戦術で敵の攻撃を無効化！';
                            skillData.bonus = 12;
                            break;
                        case '関東制覇':
                            skillData.description = '城攻めの経験が威力を発揮！';
                            skillData.bonus = 18;
                            break;
                        case '謀将':
                            skillData.description = '巧妙な策略で敵軍を混乱させた！';
                            skillData.bonus = 16;
                            break;
                        case '南蛮貿易':
                            skillData.description = '西洋の武器技術が戦場で輝く！';
                            skillData.bonus = 14;
                            break;
                        case '薩摩隼人':
                            skillData.description = '奇襲攻撃で敵の虚を突いた！';
                            skillData.bonus = 17;
                            break;
                        case '独眼竜':
                            skillData.description = '騎馬鉄砲隊の突撃準備！';
                            skillData.bonus = 10;
                            break;
                        case '謀反':
                            skillData.description = '裏切りの策略で敵内部を分裂！';
                            skillData.bonus = 13;
                            break;
                        case '鬼柴田':
                            skillData.description = '鬼神のごとき武勇で敵陣を蹂躙！';
                            skillData.bonus = 22;
                            break;
                        case '人たらし':
                            skillData.description = '人心掌握で敵兵を味方に引き込む！';
                            skillData.bonus = 15;
                            break;
                        case '影武者':
                            skillData.description = '影武者の術で敵軍を撹乱！';
                            skillData.bonus = 14;
                            break;
                        case '赤備え':
                            skillData.description = '赤い軍装の精鋭隊が敵を圧倒！';
                            skillData.bonus = 20;
                            break;
                        case '不死身':
                            skillData.description = '不死身の武勇で敵陣を駆け抜ける！';
                            skillData.bonus = 18;
                            break;
                        case '愛の字':
                            skillData.description = '義愛の精神で全軍を鼓舞！';
                            skillData.bonus = 17;
                            break;
                        case '先陣':
                            skillData.description = '常に先陣を切って敵軍に突撃！';
                            skillData.bonus = 16;
                            break;
                        case '無傷':
                            skillData.description = '完璧な防御で一切の傷を負わず突進！';
                            skillData.bonus = 18;
                            break;
                        case '宿老':
                            skillData.description = '老練な経験で戦況を見極める！';
                            skillData.bonus = 15;
                            break;
                        case '調整':
                            skillData.description = '絶妙な連携で軍団の力を最大化！';
                            skillData.bonus = 14;
                            break;
                        case '継承者':
                            skillData.description = '名門の誇りで士気を高める！';
                            skillData.bonus = 13;
                            break;
                        case '内政':
                            skillData.description = '内政の手腕で補給を完璧に！';
                            skillData.bonus = 12;
                            break;
                        case '両川':
                            skillData.description = '両川の連携で敵軍を挟撃！';
                            skillData.bonus = 19;
                            break;
                        case '勇猛':
                            skillData.description = '勇猛果敢に敵陣を突破！';
                            skillData.bonus = 17;
                            break;
                        case '雷神':
                            skillData.description = '雷鳴のような轟きで敵軍を震撼！';
                            skillData.bonus = 21;
                            break;
                        case '忠臣':
                            skillData.description = '忠義の心で主君のために奮戦！';
                            skillData.bonus = 16;
                            break;
                        case '鬼島津':
                            skillData.description = '鬼島津の名に恥じぬ猛攻！';
                            skillData.bonus = 23;
                            break;
                        case '智将':
                            skillData.description = '知略を駆使して敵の隙を突く！';
                            skillData.bonus = 15;
                            break;
                        case '軍師':
                            skillData.description = '軍師としての策略が功を奏す！';
                            skillData.bonus = 18;
                            break;
                        case '勇将':
                            skillData.description = '勇猛な武将として前線を駆ける！';
                            skillData.bonus = 16;
                            break;
                        case '二刀流':
                            skillData.description = '二刀流の極意で敵を圧倒！左右の刀が敵将を切り裂く！';
                            skillData.bonus = 32;
                            break;
                        case '隻眼の剣士':
                            skillData.description = '隻眼ながら神技の剣で敵を圧倒！';
                            skillData.bonus = 24;
                            break;
                        case '槍の達人':
                            skillData.description = '槍術の達人として敵軍を貫く！';
                            skillData.bonus = 18;
                            break;
                        case '天才軍師':
                            skillData.description = '天才的な戦術で戦況を逆転！';
                            skillData.bonus = 26;
                            break;
                        case '軍師の才':
                            skillData.description = '軍師の才能で完璧な作戦を立案！';
                            skillData.bonus = 22;
                            break;
                        case '日本一の兵':
                            skillData.description = '日本一の兵として武名を轟かす！';
                            skillData.bonus = 28;
                            break;
                        case '傾奇者':
                            skillData.description = '傾奇者の奇抜な戦法で敵を撹乱！';
                            skillData.bonus = 20;
                            break;
                        case '築城名人':
                            skillData.description = '築城の知識で攻城戦を有利に！';
                            skillData.bonus = 17;
                            break;
                        case '猛将':
                            skillData.description = '猛将として敵陣を縦横無尽に駆ける！';
                            skillData.bonus = 19;
                            break;
                        case '黒母衣衆':
                            skillData.description = '黒母衣衆の精鋭として戦場を制圧！';
                            skillData.bonus = 21;
                            break;
                        case '米五郎左':
                            skillData.description = '織田家筆頭家老として軍勢を完璧に統率！';
                            skillData.bonus = 18;
                            break;
                        case '関東管領':
                            skillData.description = '関東の地の利を活かした戦術で敵を撹乱！';
                            skillData.bonus = 16;
                            break;
                        case '槍の又左':
                            skillData.description = '槍術の名手として敵陣を突破！';
                            skillData.bonus = 19;
                            break;
                        case '小姓頭':
                            skillData.description = '主君への忠義で全軍の士気を高める！';
                            skillData.bonus = 15;
                            break;
                        case '乳兄弟':
                            skillData.description = '信長との絆で結束力を最大化！';
                            skillData.bonus = 17;
                            break;
                        case '幽斎':
                            skillData.description = '文武両道の教養で戦術を洗練！';
                            skillData.bonus = 20;
                            break;
                        case '蜂須賀小六':
                            skillData.description = '野武士上がりの奇策で敵を翻弄！';
                            skillData.bonus = 16;
                            break;
                        case '武田四天王':
                            skillData.description = '武田四天王の一角として鉄壁の守りを披露！';
                            skillData.bonus = 18;
                            break;
                        case '逃げ弾正':
                            skillData.description = '巧みな退却戦術で敵の包囲を突破！';
                            skillData.bonus = 22;
                            break;
                        case '表裏比興':
                            skillData.description = '狡猾な策略で敵軍内部を分裂させ大混乱に陥れる！';
                            skillData.bonus = 32;
                            break;
                        case '兄弟の絆':
                            skillData.description = '兄弟の結束で軍団の連携を強化！';
                            skillData.bonus = 16;
                            break;
                        case '郡内領主':
                            skillData.description = '地元の地理を活かした戦術で有利に展開！';
                            skillData.bonus = 14;
                            break;
                        case '武田重臣':
                            skillData.description = '武田家重臣としての威厳で敵を圧倒！';
                            skillData.bonus = 17;
                            break;
                        case '無言':
                            skillData.description = '寡黙ながら圧倒的な存在感で敵を威圧！';
                            skillData.bonus = 19;
                            break;
                        case '色部勢':
                            skillData.description = '色部勢の精鋭が敵陣を蹂躙！';
                            skillData.bonus = 17;
                            break;
                        case '本庄勢':
                            skillData.description = '本庄勢の勇猛さで敵軍を震撼させる！';
                            skillData.bonus = 18;
                            break;
                        case '下越守護':
                            skillData.description = '下越の統治経験で軍略を効率化！';
                            skillData.bonus = 16;
                            break;
                        case '新発田勢':
                            skillData.description = '新発田勢の機動力で敵の側面を突く！';
                            skillData.bonus = 17;
                            break;
                        case '信濃武士':
                            skillData.description = '信濃武士の誇りで決死の攻撃を敢行！';
                            skillData.bonus = 20;
                            break;
                        case '徳川四天王':
                            skillData.description = '徳川四天王として主君を守り抜く！';
                            skillData.bonus = 21;
                            break;
                        case '赤鬼':
                            skillData.description = '赤鬼の異名通り鬼神のごとき突撃！';
                            skillData.bonus = 23;
                            break;
                        case '知恵伊豆':
                            skillData.description = '知恵伊豆の異名で完璧な作戦を立案！';
                            skillData.bonus = 24;
                            break;
                        case '三河武士':
                            skillData.description = '三河武士の忠義と勇猛さで敵を圧倒！';
                            skillData.bonus = 18;
                            break;
                        case '徳川譜代':
                            skillData.description = '徳川譜代の誇りで主君のために奮戦！';
                            skillData.bonus = 17;
                            break;
                        case '伏見城':
                            skillData.description = '伏見城の戦いで示した忠義で士気向上！';
                            skillData.bonus = 22;
                            break;
                        case '忍者頭':
                            skillData.description = '忍術を駆使して敵陣に混乱を引き起こす！';
                            skillData.bonus = 20;
                            break;
                        case '若殿':
                            skillData.description = '若き当主として全軍を鼓舞！';
                            skillData.bonus = 15;
                            break;
                        case '関東の鬼':
                            skillData.description = '関東の鬼の異名で敵軍を恐怖に陥れる！';
                            skillData.bonus = 21;
                            break;
                        case '忍城主':
                            skillData.description = '忍城の浮城戦術で敵の攻撃を無効化！';
                            skillData.bonus = 19;
                            break;
                        case '江戸城主':
                            skillData.description = '江戸城の要塞戦術で鉄壁の守りを展開！';
                            skillData.bonus = 18;
                            break;
                        case '北条重臣':
                            skillData.description = '北条家重臣として統制の取れた攻撃！';
                            skillData.bonus = 16;
                            break;
                        case '外交僧':
                            skillData.description = '外交僧として敵軍に動揺を与える！';
                            skillData.bonus = 18;
                            break;
                        case '毛利重臣':
                            skillData.description = '毛利家重臣として威厳ある指揮！';
                            skillData.bonus = 17;
                            break;
                        case '石見守護':
                            skillData.description = '石見の山岳戦術で敵を翻弄！';
                            skillData.bonus = 18;
                            break;
                        case '桂勢':
                            skillData.description = '桂勢の機動力で敵の隙を突く！';
                            skillData.bonus = 16;
                            break;
                        case '山陰道':
                            skillData.description = '山陰道の地の利を活かした戦術！';
                            skillData.bonus = 17;
                            break;
                        case '大友重臣':
                            skillData.description = '大友家重臣として九州武士の意地を見せる！';
                            skillData.bonus = 17;
                            break;
                        case '豊後勢':
                            skillData.description = '豊後勢の結束で敵軍を圧倒！';
                            skillData.bonus = 18;
                            break;
                        case '肥後衆':
                            skillData.description = '肥後衆の野性的な戦いで敵を蹂躙！';
                            skillData.bonus = 19;
                            break;
                        case '豊後三老':
                            skillData.description = '豊後三老として老練な戦術を駆使！';
                            skillData.bonus = 20;
                            break;
                        case '西国無双':
                            skillData.description = '西国無双の武勇で敵陣を蹂躙！';
                            skillData.bonus = 25;
                            break;
                        case '戸次勢':
                            skillData.description = '戸次勢の精強さで敵陣を突破！';
                            skillData.bonus = 19;
                            break;
                        case '若武者':
                            skillData.description = '若武者らしい勇猛な突撃で敵を圧倒！';
                            skillData.bonus = 20;
                            break;
                        case '薩摩勢':
                            skillData.description = '薩摩勢の猛攻で敵軍を蹂躙！';
                            skillData.bonus = 19;
                            break;
                        case '島津重臣':
                            skillData.description = '島津家重臣として薩摩武士を統率！';
                            skillData.bonus = 18;
                            break;
                        case '樺山勢':
                            skillData.description = '樺山勢の勇猛さで敵陣を駆け抜ける！';
                            skillData.bonus = 17;
                            break;
                        case '伊達重臣':
                            skillData.description = '伊達家重臣として奥州武士を指揮！';
                            skillData.bonus = 17;
                            break;
                        case '槍奉行':
                            skillData.description = '槍奉行として槍衾戦術で敵を迎撃！';
                            skillData.bonus = 18;
                            break;
                        case '白石勢':
                            skillData.description = '白石勢の機動力で敵の側面を突く！';
                            skillData.bonus = 16;
                            break;
                        case '鬼庭勢':
                            skillData.description = '鬼庭勢の鬼神のような突撃！';
                            skillData.bonus = 19;
                            break;
                        case '山形城主':
                            skillData.description = '山形の地の利を活かした戦術！';
                            skillData.bonus = 16;
                            break;
                        case '啄木鳥戦法':
                            skillData.description = '啄木鳥戦法で敵軍を分断し各個撃破！';
                            skillData.bonus = 30;
                            break;
                        case '武田宿老':
                            skillData.description = '武田家の宿老として重厚な指揮！';
                            skillData.bonus = 20;
                            break;
                        case '赤備えの祖':
                            skillData.description = '赤備えの創始者として部隊を鼓舞！';
                            skillData.bonus = 25;
                            break;
                        case '忍術の極意':
                            skillData.description = '忍術の極意で敵陣に潜入し混乱を引き起こす！';
                            skillData.bonus = 28;
                            break;
                        case '霧隠れ':
                            skillData.description = '霧に紛れて神出鬼没の攻撃を仕掛ける！';
                            skillData.bonus = 26;
                            break;
                        case '十勇士':
                            skillData.description = '真田十勇士の一員として特殊任務を遂行！';
                            skillData.bonus = 22;
                            break;
                        case '上杉重臣':
                            skillData.description = '上杉家重臣として軍勢を統率！';
                            skillData.bonus = 18;
                            break;
                        case '鬼小島':
                            skillData.description = '鬼小島の異名で敵軍を震撼させる！';
                            skillData.bonus = 24;
                            break;
                        case '攻め弾正':
                            skillData.description = '攻め弾正の異名で敵城を攻略！';
                            skillData.bonus = 26;
                            break;
                        case '副将':
                            skillData.description = '信玄公の副将として全軍を完璧に統率！';
                            skillData.bonus = 24;
                            break;
                        case '諏訪勝頼':
                            skillData.description = '諏訪の血を引く若き当主として奮戦！';
                            skillData.bonus = 20;
                            break;
                        case '地黄八幡':
                            skillData.description = '地黄八幡の旗印で敵軍を圧倒！';
                            skillData.bonus = 25;
                            break;
                        case '忠義の士':
                            skillData.description = '忠義の心で主君のために命を捧げる！';
                            skillData.bonus = 20;
                            break;
                        case '若き勇将':
                            skillData.description = '若き勇将として果敢に敵陣に突撃！';
                            skillData.bonus = 19;
                            break;
                        case '渡辺の槍':
                            skillData.description = '渡辺一党伝統の槍術で敵陣を突破！';
                            skillData.bonus = 20;
                            break;

                        case '大和大納言':
                            skillData.description = '大和大納言として完璧な軍政を展開！';
                            skillData.bonus = 22;
                            break;
                        case '五奉行':
                            skillData.description = '五奉行の行政手腕で軍の組織力を強化！';
                            skillData.bonus = 18;
                            break;
                        case '豊臣家臣':
                            skillData.description = '豊臣家臣として主君への忠義を示す！';
                            skillData.bonus = 16;
                            break;
                        case '肥前の熊':
                            skillData.description = '肥前の熊の異名で九州を震撼させる！';
                            skillData.bonus = 28;
                            break;
                        case '龍造寺一族':
                            skillData.description = '龍造寺一族の結束で敵軍を圧倒！';
                            skillData.bonus = 20;
                            break;
                        case '肥前勢':
                            skillData.description = '肥前武士の意地で勇猛に戦う！';
                            skillData.bonus = 18;
                            break;
                        case '七難八苦':
                            skillData.description = '七難八苦を乗り越えた不屈の精神で敵を圧倒！';
                            skillData.bonus = 25;
                            break;
                        case '今川軍師':
                            skillData.description = '今川家軍師として培った完璧な戦術を展開！';
                            skillData.bonus = 28;
                            break;
                        case '化け猫騒動':
                            skillData.description = '肥前の智謀で敵軍を幻惑する！';
                            skillData.bonus = 22;
                            break;
                        case '一乗谷の鬼':
                            skillData.description = '一乗谷の鬼神として敵軍を蹂躙！';
                            skillData.bonus = 26;
                            break;
                        case '上野の黄斑':
                            skillData.description = '関東随一の武勇で敵将を討ち取る！';
                            skillData.bonus = 24;
                            break;
                        case '上杉執政':
                            skillData.description = '上杉家執政としての統治手腕で軍の組織力を強化！';
                            skillData.bonus = 18;
                            break;
                        case '丹波の赤鬼':
                            skillData.description = '丹波の赤鬼として恐怖を与える！';
                            skillData.bonus = 25;
                            break;
                        case '梟雄':
                            skillData.description = '梟雄の策略で敵軍を翻弄する！';
                            skillData.bonus = 27;
                            break;
                        case '会津の麒麟児':
                            skillData.description = '麒麟児の異名に恥じぬ完璧な指揮！';
                            skillData.bonus = 26;
                            break;
                        case '鉄砲大将':
                            skillData.description = '雑賀衆の鉄砲戦術で敵陣を制圧！';
                            skillData.bonus = 29;
                            break;
                        case '鬼左近':
                            skillData.description = '鬼左近の異名で敵将を一騎討ちで撃破！';
                            skillData.bonus = 27;
                            break;
                        case '白頭巾':
                            skillData.description = '白頭巾に隠された智謀で戦況を一変！';
                            skillData.bonus = 25;
                            break;
                        case '行政の鬼':
                            skillData.description = '完璧な兵站で継戦能力を向上！';
                            skillData.bonus = 13;
                            break;
                        default:
                            // 汎用特技効果（未定義の特技用）
                            skillData.description = `「${general.skill}」の技が冴え渡る！`;
                            skillData.bonus = Math.floor(Math.random() * 8) + 10; // 10-17のランダム
                            break;
                    }
                    
                    return skillData;
                    
                } catch (error) {
                    console.warn(`特技発動チェック中にエラー (${general?.name || '不明'}):`, error);
                    return {
                        activated: false,
                        name: general?.name || '不明',
                        skill: general?.skill || '特技なし',
                        description: '',
                        bonus: 0
                    };
                }
            }
            
            checkNewGeneralAppearance() {
                try {
                    // 新浪人登場システム（軽量版）
                    const roll = Math.random() * 100;
                    
                    let newGeneral = null;
                    let isRare = false;
                    
                    if (roll <= 3) {
                        // 3%の確率でレア浪人登場
                        const availableRare = this.gameState.rareRonin.filter(ronin => 
                            !this.gameState.availableGenerals.some(g => g.id === ronin.id) &&
                            !this.gameState.generals.some(g => g.id === ronin.id)
                        );
                        
                        if (availableRare.length > 0) {
                            newGeneral = availableRare[Math.floor(Math.random() * availableRare.length)];
                            isRare = true;
                        }
                    } else if (roll <= 50) {
                        // 50%の確率で通常浪人登場
                        const availableNormal = this.gameState.normalRonin.filter(ronin => 
                            !this.gameState.availableGenerals.some(g => g.id === ronin.id) &&
                            !this.gameState.generals.some(g => g.id === ronin.id)
                        );
                        
                        if (availableNormal.length > 0) {
                            newGeneral = availableNormal[Math.floor(Math.random() * availableNormal.length)];
                        }
                    }
                    
                    if (newGeneral) {
                        this.gameState.availableGenerals.push({ ...newGeneral });
                        
                        let appearanceMessage = '';
                        if (isRare) {
                            appearanceMessage = `⭐【名将登場】${newGeneral.name}が世に現れた！`;
                        } else {
                            appearanceMessage = `新たな武将「${newGeneral.name}」が仕官を希望している`;
                        }
                        
                        this.gameState.addLog(appearanceMessage, 'diplomacy');
                        this.gameState.addPersonnelLog(appearanceMessage);
                    }
                    
                } catch (error) {
                    console.warn('新武将登場処理中にエラーが発生:', error);
                }
            }
            
            checkDaimyoExtinction() {
                try {
                    if (!this.gameState.daimyos || !this.gameState.territories || !this.gameState.generals) {
                        return;
                    }
                    
                    // 滅亡した大名を記録する配列
                    const extinctDaimyos = [];
                    
                    // 各大名の領土数をチェック
                    this.gameState.daimyos.forEach(daimyo => {
                        try {
                            if (!daimyo || !daimyo.id || daimyo.id === this.gameState.playerDaimyo) {
                                return; // プレイヤーは除外
                            }
                            
                            const ownedTerritories = this.gameState.territories.filter(t => 
                                t && t.owner === daimyo.id
                            );
                            
                            // 領土を全て失った場合
                            if (ownedTerritories.length === 0) {
                                this.convertGeneralsToRonin(daimyo.id, daimyo.name);
                                extinctDaimyos.push(daimyo.id);
                            }
                        } catch (error) {
                            console.warn(`大名${daimyo?.name || '不明'}の滅亡チェック中にエラー:`, error);
                        }
                    });
                    
                    // 滅亡した大名を配列から完全に削除
                    if (extinctDaimyos.length > 0) {
                        this.gameState.daimyos = this.gameState.daimyos.filter(d => 
                            !extinctDaimyos.includes(d.id)
                        );
                    }
                } catch (error) {
                    console.warn('大名家滅亡チェック中にエラーが発生:', error);
                }
            }
            
            convertGeneralsToRonin(daimyoId, daimyoName) {
                try {
                    // 滅亡した大名の武将を取得
                    const extinctGenerals = this.gameState.generals.filter(g => 
                        g && g.lord === daimyoId
                    );
                    
                    if (extinctGenerals.length === 0) {
                        return;
                    }
                    
                    let roninCount = 0;
                    
                    // 各武将を浪人に変換
                    extinctGenerals.forEach(general => {
                        try {
                            if (!general || !general.name) return;
                            
                            // 浪人として追加（既存の浪人形式に合わせる）
                            const roninGeneral = {
                                id: `ronin_${general.id}_${Date.now()}`, // 重複を避けるため新しいID
                                name: general.name,
                                stats: { ...general.stats },
                                skill: general.skill || '特技なし',
                                recruitCost: 100,
                                baseCharm: Math.max(50, (general.stats?.charm || 50) - 10) // 少し厳しく
                            };
                            
                            this.gameState.availableGenerals.push(roninGeneral);
                            roninCount++;
                            
                        } catch (error) {
                            console.warn(`武将${general?.name || '不明'}の浪人変換中にエラー:`, error);
                        }
                    });
                    
                    // 元の武将を削除
                    this.gameState.generals = this.gameState.generals.filter(g => 
                        !g || g.lord !== daimyoId
                    );
                    
                    // AI役職設定も削除
                    if (this.gameState.aiRoles && this.gameState.aiRoles[daimyoId]) {
                        delete this.gameState.aiRoles[daimyoId];
                    }
                    
                    // 山城支配・征夷大将軍状況もクリア
                    if (this.gameState.yamashiroControl && this.gameState.yamashiroControl[daimyoId]) {
                        this.gameState.yamashiroControl[daimyoId] = 0;
                    }
                    if (this.gameState.tenkaninStatus && this.gameState.tenkaninStatus[daimyoId]) {
                        this.gameState.tenkaninStatus[daimyoId] = false;
                    }
                    
                    // 滅亡イベントを記録
                    this.gameState.turnEvents.push({
                        type: 'diplomacy',
                        message: `💀${daimyoName}が滅亡！配下武将${roninCount}名が浪人となった`
                    });
                    
                    if (roninCount > 0) {
                        this.gameState.addLog(`${daimyoName}滅亡により${roninCount}名の武将が浪人として登用可能に`, 'diplomacy');
                        this.gameState.addPersonnelLog(`${daimyoName}家滅亡により${roninCount}名の武将が浪人に`);
                    }
                    
                } catch (error) {
                    console.warn(`${daimyoName}の武将浪人化処理中にエラー:`, error);
                }
            }
            
            processAIPersonnel() {
                try {
                    // 必要なプロパティの存在チェック
                    if (!this.gameState.daimyos || !this.gameState.playerDaimyo) {
                        return;
                    }
                    
                    // AI大名の人事管理を実行
                    const aiDaimyos = this.gameState.daimyos.filter(d => d && d.id !== this.gameState.playerDaimyo);
                    
                    aiDaimyos.forEach(daimyo => {
                        try {
                            // 武将登用チェック
                            this.checkAIRecruitment(daimyo);
                            
                            // 役職適正チェック
                            this.checkAIRoleOptimization(daimyo);
                            
                            // 領土担当武将の見直し
                            this.checkAITerritoryAssignments(daimyo);
                        } catch (error) {
                            console.warn(`AI大名${daimyo.name}の人事処理中にエラー:`, error);
                        }
                    });
                } catch (error) {
                    console.warn('AI人事管理中にエラーが発生:', error);
                }
            }
            
            checkAIRecruitment(daimyo) {
                try {
                    // 基本的な存在チェック
                    if (!daimyo || !this.gameState.turn || !this.gameState.generals || !this.gameState.availableGenerals) {
                        return;
                    }
                    
                    // 5ターンに1回、登用を検討
                    if (this.gameState.turn % 5 !== 0) return;
                    
                    // 現在の武将数をチェック
                    const currentGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    if (currentGenerals.length >= 8) return; // 上限8人
                    
                    // 資金チェック
                    if (!daimyo.gold || daimyo.gold < 500) return;
                    
                    // 登用可能武将から選択
                    const availableGenerals = this.gameState.availableGenerals.filter(g => 
                        g && g.recruitCost && g.baseCharm && g.recruitCost <= daimyo.gold && 
                        g.baseCharm <= (daimyo.stats?.charm || 50) + 20
                    );
                    
                    if (availableGenerals.length > 0 && Math.random() < 0.4) {
                        // コストパフォーマンスの良い武将を選択
                        const targetGeneral = availableGenerals.reduce((best, current) => {
                            const bestValue = this.calculateGeneralValue(best) / (best.recruitCost || 1);
                            const currentValue = this.calculateGeneralValue(current) / (current.recruitCost || 1);
                            return currentValue > bestValue ? current : best;
                        });
                        
                        if (!targetGeneral) return;
                        
                        // 登用実行
                        const daimyoCharm = daimyo.stats?.charm || 50;
                        const successChance = Math.min(80, Math.max(30, daimyoCharm - targetGeneral.baseCharm + 40));
                        
                        if (Math.random() * 100 <= successChance) {
                            const newGeneral = {
                                id: targetGeneral.id,
                                name: targetGeneral.name || '無名武将',
                                lord: daimyo.id,
                                stats: { ...targetGeneral.stats } || { battle: 50, command: 50, politics: 50, intelligence: 50, charm: 50 },
                                skill: targetGeneral.skill || '特技なし',
                                loyalty: Math.floor(Math.random() * 20) + 70 // 70-90の忠誠度
                            };
                            
                            this.gameState.generals.push(newGeneral);
                            this.gameState.availableGenerals = this.gameState.availableGenerals.filter(g => g.id !== targetGeneral.id);
                            daimyo.gold -= targetGeneral.recruitCost;
                            
                            // 人事ログに記録
                            if (this.gameState.addPersonnelLog) {
                                this.gameState.addPersonnelLog(`${daimyo.name}が${targetGeneral.name}を登用（忠誠度${newGeneral.loyalty}）`);
                            }
                            
                            // 新武将を適切な役職に配置
                            this.assignNewGeneralRole(daimyo.id, newGeneral.id);
                        }
                    }
                } catch (error) {
                    console.warn('AI登用処理中にエラー:', error);
                }
            }
            
            calculateGeneralValue(general) {
                try {
                    if (!general || !general.stats) return 0;
                    
                    const stats = general.stats;
                    return (stats.battle || 0) + (stats.command || 0) + 
                           (stats.politics || 0) + (stats.intelligence || 0) + (stats.charm || 0);
                } catch (error) {
                    console.warn('武将評価値計算中にエラー:', error);
                    return 0;
                }
            }
            
            checkAIRoleOptimization(daimyo) {
                try {
                    // 基本的な存在チェック
                    if (!daimyo || !this.gameState.turn || !this.gameState.aiRoles) {
                        return;
                    }
                    
                    // 3ターンに1回、役職を見直し
                    if (this.gameState.turn % 3 !== 0) return;
                    
                    const aiRoles = this.gameState.aiRoles[daimyo.id];
                    if (!aiRoles) return;
                    
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    if (daimyoGenerals.length === 0) return;
                    
                    // 各役職の適正度をチェック
                    const roleOptimizations = [];
                    
                    Object.keys(aiRoles).forEach(roleKey => {
                        try {
                            const currentGeneralId = aiRoles[roleKey];
                            let currentScore = 0;
                            let bestGeneral = null;
                            let bestScore = 0;
                            
                            // 現在の武将のスコア
                            if (currentGeneralId) {
                                const currentGeneral = this.gameState.generals.find(g => g && g.id === currentGeneralId);
                                if (currentGeneral) {
                                    currentScore = this.gameState.calculateGeneralScore(currentGeneral, roleKey);
                                }
                            }
                            
                            // より適切な武将を探す
                            daimyoGenerals.forEach(general => {
                                if (!general) return;
                                
                                // 他の役職についていない武将のみ
                                const isAssigned = Object.values(aiRoles).includes(general.id);
                                if (!isAssigned || general.id === currentGeneralId) {
                                    const score = this.gameState.calculateGeneralScore(general, roleKey);
                                    if (score > bestScore) {
                                        bestScore = score;
                                        bestGeneral = general;
                                    }
                                }
                            });
                            
                            // 改善が見込める場合のみ変更
                            if (bestGeneral && bestScore > currentScore + 20) { // 20ポイント以上の改善がある場合
                                roleOptimizations.push({
                                    roleKey: roleKey,
                                    newGeneralId: bestGeneral.id,
                                    newGeneralName: bestGeneral.name || '無名武将',
                                    improvement: bestScore - currentScore
                                });
                            }
                        } catch (error) {
                            console.warn(`役職${roleKey}の最適化中にエラー:`, error);
                        }
                    });
                    
                    // 最も改善効果の高い1つだけを実行（頻繁な変更を避ける）
                    if (roleOptimizations.length > 0) {
                        const bestOptimization = roleOptimizations.reduce((best, current) => 
                            current.improvement > best.improvement ? current : best
                        );
                        
                        const oldGeneralId = aiRoles[bestOptimization.roleKey];
                        const oldGeneralName = oldGeneralId ? 
                            this.gameState.generals.find(g => g && g.id === oldGeneralId)?.name || '不明' : '未設定';
                        
                        // 他の役職から新武将を解除
                        Object.keys(aiRoles).forEach(key => {
                            if (aiRoles[key] === bestOptimization.newGeneralId) {
                                aiRoles[key] = null;
                            }
                        });
                        
                        // 新しい役職に任命
                        aiRoles[bestOptimization.roleKey] = bestOptimization.newGeneralId;
                        
                        // 人事ログに記録
                        const roleNames = {
                            'strategist': '軍師', 'diplomat': '外交担当', 'administrator': '内政総監',
                            'kenchiCommissioner': '検地奉行', 'riceCommissioner': '米奉行', 
                            'townCommissioner': '町奉行', 'goldCommissioner': '金奉行',
                            'constructionCommissioner': '普請奉行', 'militaryCommissioner': '兵奉行',
                            'armyStrategist': '参謀', 'vanguard': '前衛', 'rightWing': '右翼',
                            'leftWing': '左翼', 'reserve': '後詰'
                        };
                        
                        const roleName = roleNames[bestOptimization.roleKey] || bestOptimization.roleKey;
                        
                        if (this.gameState.addPersonnelLog) {
                            this.gameState.addPersonnelLog(
                                `${daimyo.name}が${bestOptimization.newGeneralName}を${roleName}に任命（前任：${oldGeneralName}）`
                            );
                        }
                    }
                } catch (error) {
                    console.warn('AI役職最適化中にエラー:', error);
                }
            }
            
            assignNewGeneralRole(daimyoId, generalId) {
                try {
                    if (!this.gameState.aiRoles || !daimyoId || !generalId) return;
                    
                    const aiRoles = this.gameState.aiRoles[daimyoId];
                    if (!aiRoles) return;
                    
                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                    if (!general) return;
                    
                    // 空いている役職に最適配置
                    const availableRoles = Object.keys(aiRoles).filter(key => !aiRoles[key]);
                    
                    if (availableRoles.length > 0) {
                        let bestRole = availableRoles[0];
                        let bestScore = this.gameState.calculateGeneralScore(general, bestRole);
                        
                        availableRoles.forEach(role => {
                            const score = this.gameState.calculateGeneralScore(general, role);
                            if (score > bestScore) {
                                bestScore = score;
                                bestRole = role;
                            }
                        });
                        
                        aiRoles[bestRole] = generalId;
                        
                        const roleNames = {
                            'strategist': '軍師', 'diplomat': '外交担当', 'administrator': '内政総監',
                            'kenchiCommissioner': '検地奉行', 'riceCommissioner': '米奉行', 
                            'townCommissioner': '町奉行', 'goldCommissioner': '金奉行',
                            'constructionCommissioner': '普請奉行', 'militaryCommissioner': '兵奉行',
                            'armyStrategist': '軍団軍師', 'vanguard': '前衛', 'rightWing': '右翼',
                            'leftWing': '左翼', 'reserve': '後詰'
                        };
                        
                        const roleName = roleNames[bestRole] || bestRole;
                        
                        if (this.gameState.addPersonnelLog) {
                            this.gameState.addPersonnelLog(`${general.name}を${roleName}に配置`);
                        }
                    }
                } catch (error) {
                    console.warn('新武将役職配置中にエラー:', error);
                }
            }
            
            checkAITerritoryAssignments(daimyo) {
                try {
                    // 基本的な存在チェック
                    if (!daimyo || !this.gameState.turn || !this.gameState.territories || !this.gameState.generals) {
                        return;
                    }
                    
                    // 4ターンに1回、領土担当を見直し
                    if (this.gameState.turn % 4 !== 0) return;
                    
                    const daimyoTerritories = this.gameState.territories.filter(t => t && t.owner === daimyo.id);
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                    
                    if (daimyoTerritories.length === 0 || daimyoGenerals.length === 0) return;
                    
                    // 役職についていない武将を取得
                    const aiRoles = this.gameState.aiRoles[daimyo.id] || {};
                    const assignedToRoles = Object.values(aiRoles).filter(id => id !== null);
                    const availableGenerals = daimyoGenerals.filter(g => !assignedToRoles.includes(g.id));
                    
                    // 担当者がいない、または不適切な領土を特定
                    const needsReassignment = [];
                    
                    daimyoTerritories.forEach(territory => {
                        const currentGeneralId = territory.generalGarrison;
                        let shouldReassign = false;
                        
                        if (!currentGeneralId) {
                            // 担当者がいない
                            shouldReassign = true;
                        } else {
                            const currentGeneral = this.gameState.generals.find(g => g && g.id === currentGeneralId);
                            if (!currentGeneral || currentGeneral.lord !== daimyo.id) {
                                // 武将が存在しないか、他の大名の武将
                                shouldReassign = true;
                            } else if (assignedToRoles.includes(currentGeneralId)) {
                                // 重要な役職についている武将は領土担当から外す
                                shouldReassign = true;
                            }
                        }
                        
                        if (shouldReassign) {
                            needsReassignment.push(territory);
                        }
                    });
                    
                    // 政治力の高い順に配置
                    if (needsReassignment.length > 0 && availableGenerals.length > 0) {
                        const sortedGenerals = availableGenerals.sort((a, b) => 
                            (b.stats?.politics || 0) - (a.stats?.politics || 0)
                        );
                        
                        needsReassignment.forEach((territory, index) => {
                            if (index < sortedGenerals.length && territory) {
                                const oldGeneralId = territory.generalGarrison;
                                const oldGeneralName = oldGeneralId ? 
                                    this.gameState.generals.find(g => g && g.id === oldGeneralId)?.name || '不明' : '未設定';
                                
                                territory.generalGarrison = sortedGenerals[index].id;
                                
                                // 人事ログに記録
                                if (this.gameState.addPersonnelLog) {
                                    this.gameState.addPersonnelLog(
                                        `${daimyo.name}が${sortedGenerals[index].name}を${territory.name}担当に任命（前任：${oldGeneralName}）`
                                    );
                                }
                            } else {
                                // 武将が足りない場合は担当なしに
                                if (territory) {
                                    territory.generalGarrison = null;
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.warn('AI領土担当見直し中にエラー:', error);
                }
            }
            
            calculateAIBattlePower(daimyo) {
                try {
                    if (!daimyo || !daimyo.stats) return 50; // デフォルト値
                    
                    let attackPower = daimyo.stats.battle || 50;
                    
                    // AI大名の領土の兵科ボーナスを計算
                    const aiTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    let totalUnitBonus = 0;
                    
                    aiTerritories.forEach(territory => {
                        if (territory.troops > 0 && territory.unitType === territory.advantageType) {
                            // 地域特性と一致する兵科は+20%ボーナス
                            const territoryBonus = Math.floor(territory.troops * 0.2);
                            totalUnitBonus += territoryBonus;
                        }
                    });
                    
                    if (totalUnitBonus > 0) {
                        attackPower += Math.floor(totalUnitBonus / 10); // 兵科ボーナスを戦闘力に反映
                    }
                    
                    // AI大名の武将編成を考慮
                    if (this.gameState.aiRoles && this.gameState.aiRoles[daimyo.id] && this.gameState.generals) {
                        const aiRoles = this.gameState.aiRoles[daimyo.id];
                        const positions = {
                            'armyStrategist': { command: 0.5, intelligence: 0.3 },
                            'vanguard': { battle: 1, command: 0.5 },
                            'rightWing': { battle: 0.8 },
                            'leftWing': { battle: 0.8 },
                            'reserve': { command: 0.3 }
                        };
                        
                        Object.entries(positions).forEach(([roleKey, stats]) => {
                            try {
                                const generalId = aiRoles[roleKey];
                                if (generalId && this.gameState.generals) {
                                    const general = this.gameState.generals.find(g => g && g.id === generalId && g.lord === daimyo.id);
                                    if (general && general.stats) {
                                        if (stats.battle && general.stats.battle) {
                                            attackPower += Math.floor((general.stats.battle || 0) * stats.battle);
                                        }
                                        if (stats.command && general.stats.command) {
                                            attackPower += Math.floor((general.stats.command || 0) * stats.command);
                                        }
                                        if (stats.intelligence && general.stats.intelligence) {
                                            attackPower += Math.floor((general.stats.intelligence || 0) * stats.intelligence);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.warn('AI戦力計算の役職処理中にエラー:', error);
                            }
                        });
                        
                        // 軍師ボーナス（役職設定の軍師）
                        try {
                            if (aiRoles.strategist && this.gameState.generals) {
                                const strategist = this.gameState.generals.find(g => g && g.id === aiRoles.strategist && g.lord === daimyo.id);
                                if (strategist && strategist.stats && strategist.stats.intelligence) {
                                    attackPower += Math.floor(strategist.stats.intelligence / 10);
                                }
                            }
                        } catch (error) {
                            console.warn('AI軍師ボーナス計算中にエラー:', error);
                        }
                    }
                    
                    return Math.max(30, attackPower + Math.random() * 15); // 最低30は保証
                    
                } catch (error) {
                    console.warn('AI戦力計算中にエラー:', error);
                    return 50; // デフォルト値
                }
            }
            
            assignNewTerritoryGeneral(daimyoId, territory) {
                try {
                    if (!daimyoId || !territory || !this.gameState.generals || !this.gameState.territories) {
                        return;
                    }
                    
                    // この大名の未配置武将を取得
                    const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyoId);
                    const assignedGeneralIds = this.gameState.territories
                        .filter(t => t && t.owner === daimyoId && t.generalGarrison)
                        .map(t => t.generalGarrison);
                    
                    const unassignedGenerals = daimyoGenerals.filter(g => g && !assignedGeneralIds.includes(g.id));
                    
                    if (unassignedGenerals.length > 0) {
                        // 政治力が最も高い武将を配置
                        const bestGeneral = unassignedGenerals.reduce((best, current) => {
                            const bestPolitics = best.stats?.politics || 0;
                            const currentPolitics = current.stats?.politics || 0;
                            return currentPolitics > bestPolitics ? current : best;
                        });
                        
                        if (bestGeneral) {
                            territory.generalGarrison = bestGeneral.id;
                        }
                    }
                } catch (error) {
                    console.warn('新領土への武将配置中にエラー:', error);
                }
            }
            
            resetCurrentTab() {
                try {
                    // 現在アクティブなタブを判定
                    const activeTab = document.querySelector('.tab-content.active');
                    if (!activeTab) {
                        this.gameState.addLog('現在のタブを特定できませんでした');
                        return;
                    }
                    
                    const tabId = activeTab.id;
                    let resetCount = 0;
                    let resetMessage = '';
                    
                    switch(tabId) {
                        case 'tab-assignment':
                            // 城主配置をクリア
                            this.gameState.territories.forEach(territory => {
                                if (territory.owner === this.gameState.playerDaimyo && territory.generalGarrison) {
                                    territory.generalGarrison = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `城主配置を${resetCount}人解除しました`;
                            this.updateTerritoryAssignments();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`城主配置を${resetCount}人解除`);
                            }
                            break;
                            
                        case 'tab-roles':
                            // 役職設定をクリア
                            const roleKeys = ['strategist', 'diplomat', 'administrator', 'kenchiCommissioner', 'riceCommissioner', 'townCommissioner', 'goldCommissioner', 'constructionCommissioner', 'militaryCommissioner'];
                            roleKeys.forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey]) {
                                    this.gameState.playerRoles[roleKey] = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `役職設定を${resetCount}件解除しました`;
                            this.updateRoleSelections();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`役職設定を${resetCount}件解除`);
                            }
                            break;
                            
                        case 'tab-army':
                            // 軍団編成をクリア
                            const armyKeys = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                            armyKeys.forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey]) {
                                    this.gameState.playerRoles[roleKey] = null;
                                    resetCount++;
                                }
                            });
                            resetMessage = `軍団編成を${resetCount}件解除しました`;
                            this.updateArmyFormation();
                            if (resetCount > 0) {
                                this.gameState.addPersonnelLog(`軍団編成を${resetCount}件解除`);
                            }
                            break;
                            
                        case 'tab-reward':
                            resetMessage = '下賜は取り消しできません';
                            break;
                            
                        case 'tab-list':
                            resetMessage = '武将一覧は表示専用のため、再編成対象外です';
                            break;
                            
                        default:
                            resetMessage = '不明なタブです';
                            break;
                    }
                    
                    this.gameState.addLog(resetMessage);
                    
                    // 軍団戦力を再計算
                    if (tabId === 'tab-army' || tabId === 'tab-roles') {
                        this.calculateArmyStats();
                    }
                    
                } catch (error) {
                    console.error('再編成処理中にエラーが発生:', error);
                    this.gameState.addLog('再編成処理中にエラーが発生しましたが、ゲームは続行できます');
                }
            }
            
            executeStrategy() {
                const strategyType = document.getElementById('strategy-type')?.value;
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                // 虚報以外は対象が必要
                if (strategyType !== 'rumor' && !target) {
                    this.gameState.addLog('謀略対象が選択されていません');
                    return;
                }
                
                // 虚報以外で自領土への実行を防ぐ
                if (strategyType !== 'rumor' && target && target.owner === this.gameState.playerDaimyo) {
                    this.gameState.addLog('自領土には謀略を仕掛けられません');
                    return;
                }
                
                const intelligencePower = playerDaimyo.stats.intelligence;
                
                // 外交・謀略ボーナス
                let diplomacyBonus = 0;
                
                // 参謀ボーナス
                let strategyBonus = 0;
                if (this.gameState.playerRoles.strategist) {
                    const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                    if (strategist) {
                        strategyBonus = Math.floor(strategist.stats.intelligence / 10);
                    }
                }
                
                const totalIntelligence = intelligencePower + strategyBonus + diplomacyBonus;
                
                const targetDefenseIntelligence = target.owner ? 
                    this.gameState.daimyos.find(d => d.id === target.owner)?.stats.intelligence || 50 : 30;
                
                switch (strategyType) {
                    case 'fire':
                        // 火攻めは城壁専用攻撃（攻撃力強化）
                        if (!target) {
                            this.gameState.addLog('火攻めの対象が不正です');
                            return;
                        }
                        
                        if (totalIntelligence > targetDefenseIntelligence) {
                            const wallDamage = Math.floor(totalIntelligence * (Math.random() * 0.6 + 0.5)); // 攻撃力強化
                            const previousWalls = target.walls;
                            target.walls = Math.max(0, target.walls - wallDamage);
                            
                            let fireMessage = `${target.name}に火攻めを仕掛け、城壁${previousWalls}→${target.walls}に破壊`;
                            this.gameState.addLog(fireMessage, 'strategy');
                            
                            // 城壁が0になったら領土奪取
                            if (target.walls <= 0) {
                                const previousOwner = target.owner ? 
                                    this.gameState.daimyos.find(d => d.id === target.owner)?.name || '不明勢力' : 
                                    '空白地';
                                
                                target.owner = this.gameState.playerDaimyo;
                                target.troops = Math.floor(totalIntelligence / 8); // 新たな守備兵配置
                                target.walls = 100; // 奪取直後は100スタート
                                
                                // 新領土に大名の得意兵科を設定
                                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                                if (playerDaimyo && playerDaimyo.preferredUnit) {
                                    target.unitType = playerDaimyo.preferredUnit;
                                } else {
                                    target.unitType = 'infantry'; // デフォルトは歩兵
                                }
                                
                                let conquestMessage = `火攻めにより${target.name}が陥落！`;
                                if (previousOwner !== '空白地') {
                                    conquestMessage += `${previousOwner}の支配から奪取した`;
                                } else {
                                    conquestMessage += '空白地を新領土として確保';
                                }
                                
                                this.gameState.addLog(conquestMessage, 'strategy');
                                this.gameState.addLog(`新たな守備兵${target.troops}を配置し、城壁${target.walls}を修築`, 'strategy');
                                
                                // 新領土にプレイヤーの武将を配置（可能であれば）
                                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                                const assignedGeneralIds = this.gameState.territories
                                    .filter(t => t.owner === this.gameState.playerDaimyo && t.generalGarrison)
                                    .map(t => t.generalGarrison);
                                const unassignedGenerals = playerGenerals.filter(g => !assignedGeneralIds.includes(g.id));
                                
                                if (unassignedGenerals.length > 0) {
                                    // 政治力が最も高い武将を配置
                                    const bestGeneral = unassignedGenerals.reduce((best, current) => {
                                        const bestPolitics = best.stats?.politics || 0;
                                        const currentPolitics = current.stats?.politics || 0;
                                        return currentPolitics > bestPolitics ? current : best;
                                    });
                                    
                                    if (bestGeneral) {
                                        target.generalGarrison = bestGeneral.id;
                                        this.gameState.addLog(`${bestGeneral.name}を${target.name}担当に任命`, 'strategy');
                                    }
                                }
                            }
                        } else {
                            this.gameState.addLog(`${target.name}への火攻めを見破られた`, 'strategy');
                        }
                        break;
                    case 'water':
                        // 水攻めは米を減らす
                        if (totalIntelligence > targetDefenseIntelligence) {
                            if (target.owner) {
                                const targetDaimyo = this.gameState.daimyos.find(d => d.id === target.owner);
                                if (targetDaimyo) {
                                    const riceDamage = Math.floor(totalIntelligence * (Math.random() * 0.6 + 0.4));
                                    const previousRice = targetDaimyo.rice;
                                    targetDaimyo.rice = Math.max(0, targetDaimyo.rice - riceDamage);
                                    
                                    let waterMessage = `${target.name}に水攻めを仕掛け、${targetDaimyo.name}の米${previousRice}→${targetDaimyo.rice}に減少`;
                                    this.gameState.addLog(waterMessage, 'strategy');
                                    
                                    // 農業値も減少
                                    const agricultureDamage = Math.floor(riceDamage / 10);
                                    if (agricultureDamage > 0) {
                                        const previousAgriculture = target.agriculture;
                                        target.agriculture = Math.max(10, target.agriculture - agricultureDamage);
                                        this.gameState.addLog(`${target.name}の農地が水害により農業${previousAgriculture}→${target.agriculture}に低下`, 'strategy');
                                    }
                                } else {
                                    this.gameState.addLog(`${target.name}への水攻めを実行したが、効果的な損害を与えられなかった`, 'strategy');
                                }
                            } else {
                                this.gameState.addLog(`${target.name}は空白地のため水攻めの効果なし`, 'strategy');
                            }
                        } else {
                            this.gameState.addLog(`${target.name}への水攻めを見破られた`, 'strategy');
                        }
                        break;
                    case 'rumor':
                        // 虚報防御の設定
                        let rumorIntelligence = intelligencePower;
                        
                        // 軍師の知謀をさらに加算
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats && strategist.stats.intelligence) {
                                rumorIntelligence = Math.max(rumorIntelligence, strategist.stats.intelligence);
                            }
                        }
                        
                        // 発動率計算: (知謀-85)*4、最低5%
                        const activationRate = Math.max(5, (rumorIntelligence - 85) * 4);
                        this.gameState.rumorActivationRate = activationRate;
                        this.gameState.rumorDefenseActive = true;
                        
                        let rumorMessage = `虚報工作を展開！敵の攻撃を撹乱する準備が整った`;
                        rumorMessage += ` (発動率: ${activationRate}%)`;
                        
                        this.gameState.addLog(rumorMessage, 'strategy');
                        break;
                    case 'defection':
                        // 参謀の知謀を取得
                        let strategistIntelligence = 0;
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats) {
                                strategistIntelligence = strategist.stats.intelligence || 0;
                            }
                        }
                        
                        // 成功率計算：(参謀の知謀-80)*4
                        const successRate = Math.max(0, (strategistIntelligence - 80) * 4);
                        
                        if (target.owner && Math.random() * 100 <= successRate) {
                            const targetGenerals = this.gameState.generals.filter(g => g && g.lord === target.owner);
                            if (targetGenerals.length > 0) {
                                // 一番忠誠度が低い武将を探す
                                let lowestLoyalty = Math.min(...targetGenerals.map(g => g.loyalty || 100));
                                const lowestLoyaltyGenerals = targetGenerals.filter(g => (g.loyalty || 100) === lowestLoyalty);
                                const targetGeneral = lowestLoyaltyGenerals[Math.floor(Math.random() * lowestLoyaltyGenerals.length)];
                                
                                if (targetGeneral && typeof targetGeneral.loyalty === 'number') {
                                    // 引き抜き判定
                                    if (targetGeneral.loyalty <= 20) {
                                        // 忠誠度20以下：引き抜き成功
                                        const oldLord = this.gameState.daimyos.find(d => d && d.id === targetGeneral.lord)?.name || '不明';
                                        
                                        targetGeneral.lord = this.gameState.playerDaimyo;
                                        targetGeneral.loyalty = Math.floor(Math.random() * 20) + 70; // 70-90で再設定
                                        
                                        // 旧主君の役職・領土から除外
                                        if (this.gameState.aiRoles && this.gameState.aiRoles[target.owner]) {
                                            Object.keys(this.gameState.aiRoles[target.owner]).forEach(roleKey => {
                                                if (this.gameState.aiRoles[target.owner][roleKey] === targetGeneral.id) {
                                                    this.gameState.aiRoles[target.owner][roleKey] = null;
                                                }
                                            });
                                        }
                                        
                                        this.gameState.territories.forEach(territory => {
                                            if (territory && territory.generalGarrison === targetGeneral.id) {
                                                territory.generalGarrison = null;
                                            }
                                        });
                                        
                                        let defectionMessage = `調略成功！${targetGeneral.name}が${oldLord}を裏切り我が軍に参じた！`;
                                        this.gameState.addLog(defectionMessage, 'strategy');
                                        this.gameState.addPersonnelLog(`${targetGeneral.name}を調略により${oldLord}から引き抜き（忠誠度${targetGeneral.loyalty}）`);
                                    } else {
                                        // 忠誠度減少：参謀の知謀-80
                                        const loyaltyDamage = Math.max(1, strategistIntelligence - 80);
                                        targetGeneral.loyalty = Math.max(0, targetGeneral.loyalty - loyaltyDamage);
                                        let defectionMessage = `${target.name}の${targetGeneral.name}の忠誠度を${loyaltyDamage}低下させた`;
                                        if (diplomacyBonus > 0) defectionMessage += `。独眼竜の人格的魅力が調略を成功に導いた`;
                                        this.gameState.addLog(defectionMessage, 'strategy');
                                        
                                        if (targetGeneral.loyalty <= 20) {
                                            this.gameState.addLog(`${targetGeneral.name}の忠誠度が危険水準に！次回の調略で引き抜けるかもしれない`, 'strategy');
                                        }
                                    }
                                }
                            } else {
                                this.gameState.addLog(`${target.name}には調略対象となる武将がいない`, 'strategy');
                            }
                        } else {
                            let strategistName = '';
                            if (this.gameState.playerRoles.strategist) {
                                const strategist = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.strategist);
                                if (strategist) strategistName = strategist.name;
                            }
                            
                            let failMessage = `${target.name}への調略が失敗した`;
                            if (strategistName) {
                                failMessage += ` (${strategistName}の知謀${strategistIntelligence} 成功率${successRate}%)`;
                            } else {
                                failMessage += ` (参謀不在のため成功率0%)`;
                            }
                            this.gameState.addLog(failMessage, 'strategy');
                        }
                        break;
                }
                
                this.gameState.strategyUsed = true;
                this.updateActionButtons();
                this.renderMap();
                this.updateStatus();
            }
            
            executeDiplomacy() {
                const target = this.gameState.selectedTerritory;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!target || !target.owner || target.owner === this.gameState.playerDaimyo) {
                    this.gameState.addLog('外交対象が不正です');
                    return;
                }
                
                // 費用チェック
                if (playerDaimyo.gold < 10) {
                    this.gameState.addLog('外交交渉には金10が必要です');
                    return;
                }
                
                // 費用を支払う
                playerDaimyo.gold -= 10;
                
                const targetDaimyo = this.gameState.daimyos.find(d => d.id === target.owner);
                if (!targetDaimyo) {
                    this.gameState.addLog('外交対象の大名が見つかりません');
                    return;
                }
                
                // 外交力を計算
                let diplomacyPower = playerDaimyo.stats.charm || 50;
                
                // 外交担当武将のボーナス
                if (this.gameState.playerRoles.diplomat) {
                    const diplomat = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.diplomat);
                    if (diplomat && diplomat.stats) {
                        diplomacyPower += diplomat.stats.politics || 0;
                    }
                }
                
                // 伊達政宗の独眼竜特技効果
                if (playerDaimyo.skill === '独眼竜') {
                    diplomacyPower += 20;
                }
                
                // 相手の外交抵抗力
                const targetResistance = (targetDaimyo.stats.politics || 50) + (targetDaimyo.stats.intelligence || 50);
                
                // 基本成功率を計算（30-80%の範囲）
                const baseSuccessRate = Math.max(30, Math.min(80, 50 + (diplomacyPower - targetResistance) / 2));
                const roll = Math.random() * 100;
                
                let diplomacyMessage = '';
                let diplomatName = '';
                
                // 外交担当武将の名前を取得
                if (this.gameState.playerRoles.diplomat) {
                    const diplomat = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.diplomat);
                    if (diplomat) {
                        diplomatName = diplomat.name;
                    }
                }
                
                if (roll <= baseSuccessRate) {
                    // 外交成功
                    diplomacyMessage = `${target.name}の${targetDaimyo.name}との外交交渉が成功！`;
                    
                    if (diplomatName) {
                        diplomacyMessage += ` ${diplomatName}の交渉術が功を奏した`;
                    }
                    
                    if (playerDaimyo.skill === '独眼竜') {
                        diplomacyMessage += `。独眼竜の威厳が外交を有利に導いた`;
                    }
                    
                    diplomacyMessage += ` (成功率:${Math.floor(baseSuccessRate)}%)`;
                    
                    // 外交協定を結ぶ
                    if (!this.gameState.diplomacyTreaties[this.gameState.playerDaimyo]) {
                        this.gameState.diplomacyTreaties[this.gameState.playerDaimyo] = [];
                    }
                    if (!this.gameState.diplomacyTreaties[targetDaimyo.id]) {
                        this.gameState.diplomacyTreaties[targetDaimyo.id] = [];
                    }
                    
                    this.gameState.diplomacyTreaties[this.gameState.playerDaimyo].push(targetDaimyo.id);
                    this.gameState.diplomacyTreaties[targetDaimyo.id].push(this.gameState.playerDaimyo);
                    
                    this.gameState.addLog(diplomacyMessage, 'diplomacy');
                    this.gameState.addLog(`${targetDaimyo.name}と今ターンは相互不可侵となった`, 'diplomacy');
                    
                } else {
                    // 外交失敗
                    diplomacyMessage = `${target.name}の${targetDaimyo.name}との外交交渉が決裂...`;
                    
                    if (diplomatName) {
                        diplomacyMessage += ` ${diplomatName}の努力も実らず`;
                    }
                    
                    if (playerDaimyo.skill === '独眼竜') {
                        diplomacyMessage += `。独眼竜の威厳をもってしても`;
                    }
                    
                    diplomacyMessage += ` (成功率:${Math.floor(baseSuccessRate)}%)`;
                    
                    this.gameState.addLog(diplomacyMessage, 'diplomacy');
                    this.gameState.addLog('交渉決裂により緊張状態が続く', 'diplomacy');
                }
                
                this.gameState.diplomacyUsed = true;
                this.updateActionButtons();
                this.updateStatus();
            }
            
            executeTrade() {
                const amount = parseInt(document.getElementById('trade-amount')?.value || '0');
                const type = document.getElementById('trade-type')?.value;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (type === 'buy' && playerDaimyo.gold >= amount * 2) {
                    playerDaimyo.gold -= amount * 2;
                    playerDaimyo.rice += amount;
                    this.gameState.addLog(`金${amount * 2}で米${amount}を購入した`);
                } else if (type === 'sell' && playerDaimyo.rice >= amount) {
                    playerDaimyo.rice -= amount;
                    playerDaimyo.gold += amount * 2;
                    this.gameState.addLog(`米${amount}を売って金${amount * 2}を得た`);
                }
                
                this.updateStatus();
            }
            
            executeRecruit() {
                const amount = parseInt(document.getElementById('recruit-amount')?.value || '0');
                const territoryId = document.getElementById('recruit-territory')?.value;
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const targetTerritory = this.gameState.territories.find(t => t.id === territoryId);
                
                if (playerDaimyo.gold >= amount && targetTerritory) {
                    playerDaimyo.gold -= amount;
                    targetTerritory.troops += amount;
                    
                    const unitTypeNames = {
                        'infantry': '歩兵',
                        'cavalry': '騎馬', 
                        'arquebus': '鉄砲'
                    };
                    
                    const unitName = unitTypeNames[targetTerritory.unitType] || '兵士';
                    this.gameState.addLog(`${targetTerritory.name}に${unitName}${amount}人を雇用した`);
                    this.gameState.addPersonnelLog(`${targetTerritory.name}で${unitName}${amount}人を新規募集`);
                } else if (!targetTerritory) {
                    this.gameState.addLog('配置先の領土が見つかりません');
                } else {
                    this.gameState.addLog('資金が不足しています');
                }
                
                this.updateStatus();
                this.renderMap();
            }
            
            nextTurn() {
                this.processTurn();
                this.showTurnLog();
            }
            
            processTurn() {
                this.gameState.turn++;
                this.gameState.attackUsed = false;
                this.gameState.diplomacyUsed = false;
                this.gameState.strategyUsed = false;
                this.gameState.turnEvents = [];
                this.gameState.personnelEvents = []; // 人事ログもクリア
                
                // 各領土の発展
                this.gameState.territories.forEach(territory => {
                    if (territory.owner) {
                        let agricultureBonus = 1;
                        let commerceBonus = 1;
                        let troopsBonus = 1;
                        let wallsBonus = 1;
                        
                        // 担当武将のボーナス計算
                        if (territory.generalGarrison) {
                            const general = this.gameState.generals.find(g => g.id === territory.generalGarrison);
                            if (general) {
                                // 政治力：農業・商業ボーナス
                                agricultureBonus += Math.floor(general.stats.politics / 20);
                                commerceBonus += Math.floor(general.stats.politics / 20);
                                
                                // 戦闘力：兵数ボーナス
                                troopsBonus += Math.floor(general.stats.battle / 15);
                                
                                // 統率力：城壁ボーナス
                                wallsBonus += Math.floor(general.stats.command / 15);
                                
                                // 魅力：士気向上による追加兵数ボーナス
                                troopsBonus += Math.floor(general.stats.charm / 30);
                            }
                        }
                        
                        territory.agriculture += Math.floor(Math.random() * 3) + agricultureBonus;
                        territory.commerce += Math.floor(Math.random() * 3) + commerceBonus;
                        territory.troops += Math.floor(territory.agriculture / 10) + troopsBonus;
                        
                        // 城壁回復（北条氏康は2倍回復）
                        let wallsGrowth = Math.floor(Math.random() * 2) + wallsBonus;
                        if (territory.owner === 'hojo') {
                            wallsGrowth *= 2; // 北条氏康の関東制覇特技効果
                        }
                        territory.walls += wallsGrowth;
                        
                        territory.agriculture = Math.min(200, territory.agriculture);
                        territory.commerce = Math.min(200, territory.commerce);
                        // 相模は城壁最大1000、その他は500
                        const maxWalls = territory.name === '相模' ? 1000 : 500;
                        territory.walls = Math.min(maxWalls, territory.walls);
                    }
                });
                
                // 大名の収入
                this.gameState.daimyos.forEach(daimyo => {
                    const territories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    const income = territories.reduce((sum, t) => sum + t.commerce, 0);
                    const riceIncome = territories.reduce((sum, t) => sum + t.agriculture, 0);
                    daimyo.gold += Math.floor(income / 10);
                    daimyo.rice += Math.floor(riceIncome / 10);
                    
                    // 奉行職による追加効果
                    let totalAgricultureBonus = 0;
                    let totalCommerceBonus = 0;
                    let totalGoldBonus = 0;
                    let totalRiceBonus = 0;
                    let totalWallsBonus = 0;
                    let totalTroopsBonus = 0;
                    
                    const roles = daimyo.id === this.gameState.playerDaimyo ? 
                        this.gameState.playerRoles : 
                        (this.gameState.aiRoles[daimyo.id] || {});
                    
                    // 検地奉行効果（政治-90の数値分だけ農業向上）
                    if (roles.kenchiCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.kenchiCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 90) {
                            totalAgricultureBonus = commissioner.stats.politics - 90;
                        }
                    }
                    
                    // 米奉行効果（政治-80の数値分だけ米増加）
                    if (roles.riceCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.riceCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 80) {
                            totalRiceBonus = commissioner.stats.politics - 80;
                        }
                    }
                    
                    // 町奉行効果（政治-90の数値分だけ商業向上）
                    if (roles.townCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.townCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 90) {
                            totalCommerceBonus = commissioner.stats.politics - 90;
                        }
                    }
                    
                    // 金奉行効果（政治-80の数値分だけ金増加）
                    if (roles.goldCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.goldCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.politics >= 80) {
                            totalGoldBonus = commissioner.stats.politics - 80;
                        }
                    }
                    
                    // 普請奉行効果（統率-80の数値分だけ城壁向上）
                    if (roles.constructionCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.constructionCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.command >= 80) {
                            totalWallsBonus = commissioner.stats.command - 80;
                        }
                    }
                    
                    // 兵奉行効果（戦闘-80の数値分だけ兵数向上）
                    if (roles.militaryCommissioner) {
                        const commissioner = this.gameState.generals.find(g => g && g.id === roles.militaryCommissioner);
                        if (commissioner && commissioner.stats && commissioner.stats.battle >= 80) {
                            totalTroopsBonus = commissioner.stats.battle - 80;
                        }
                    }
                    
                    // 奉行職効果を領土に適用
                    if (totalAgricultureBonus > 0 || totalCommerceBonus > 0 || totalWallsBonus > 0 || totalTroopsBonus > 0) {
                        territories.forEach(territory => {
                            territory.agriculture += totalAgricultureBonus;
                            territory.commerce += totalCommerceBonus;
                            territory.walls += totalWallsBonus;
                            territory.troops += totalTroopsBonus;
                            
                            // 上限チェック
                            territory.agriculture = Math.min(200, territory.agriculture);
                            territory.commerce = Math.min(200, territory.commerce);
                            const maxWalls = territory.name === '相模' ? 1000 : 500;
                            territory.walls = Math.min(maxWalls, territory.walls);
                        });
                    }
                    
                    // 金・米の直接ボーナス
                    daimyo.gold += totalGoldBonus;
                    daimyo.rice += totalRiceBonus;
                    
                    // プレイヤーへのログ表示
                    if (daimyo.id === this.gameState.playerDaimyo) {
                        if (totalAgricultureBonus > 0) this.gameState.addLog(`検地奉行効果で全領土の農業+${totalAgricultureBonus}`, 'strategy');
                        if (totalCommerceBonus > 0) this.gameState.addLog(`町奉行効果で全領土の商業+${totalCommerceBonus}`, 'strategy');
                        if (totalWallsBonus > 0) this.gameState.addLog(`普請奉行効果で全領土の城壁+${totalWallsBonus}`, 'strategy');
                        if (totalTroopsBonus > 0) this.gameState.addLog(`兵奉行効果で全領土の兵数+${totalTroopsBonus}`, 'strategy');
                        if (totalGoldBonus > 0) this.gameState.addLog(`金奉行効果で金+${totalGoldBonus}`, 'strategy');
                        if (totalRiceBonus > 0) this.gameState.addLog(`米奉行効果で米+${totalRiceBonus}`, 'strategy');
                    }
                });
                
                // 兵の維持費（全国総兵数の50分の1の米を消費）
                let totalTroops = 0;
                this.gameState.territories.forEach(territory => {
                    if (territory.owner && territory.troops > 0) {
                        totalTroops += territory.troops;
                    }
                });
                
                const maintenanceCost = Math.floor(totalTroops / 50);
                if (maintenanceCost > 0) {
                    this.gameState.daimyos.forEach(daimyo => {
                        const daimyoTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                        const daimyoTroops = daimyoTerritories.reduce((sum, t) => sum + (t.troops || 0), 0);
                        
                        if (daimyoTroops > 0) {
                            const daimyoMaintenanceCost = Math.floor((daimyoTroops / totalTroops) * maintenanceCost);
                            daimyo.rice -= daimyoMaintenanceCost;
                            
                            // プレイヤーにはログ表示
                            if (daimyo.id === this.gameState.playerDaimyo && daimyoMaintenanceCost > 0) {
                                this.gameState.addLog(`兵の維持費として米${daimyoMaintenanceCost}を消費 (全軍${daimyoTroops}人)`, 'strategy');
                            }
                        }
                    });
                }
                
                // AI大名の米補充システム（米不足対策）
                this.gameState.daimyos.forEach(daimyo => {
                    if (daimyo.id !== this.gameState.playerDaimyo && daimyo.rice < 100 && daimyo.gold >= 100) {
                        const riceToBuy = Math.min(200, 100 - daimyo.rice + 100); // 100不足分+余裕分
                        const cost = riceToBuy * 2; // 金2 = 米1の交換レート
                        
                        if (daimyo.gold >= cost) {
                            daimyo.gold -= cost;
                            daimyo.rice += riceToBuy;
                            
                            // 人事ログに記録
                            this.gameState.addPersonnelLog(`${daimyo.name}が米不足のため金${cost}で米${riceToBuy}を調達`);
                        }
                    }
                });
                
                // 米不足による兵力減少処理
                this.gameState.daimyos.forEach(daimyo => {
                    if (daimyo.rice <= 0) {
                        const territories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                        let totalTroopsLost = 0;
                        
                        territories.forEach(territory => {
                            const previousTroops = territory.troops;
                            territory.troops = Math.floor(territory.troops / 2);
                            totalTroopsLost += (previousTroops - territory.troops);
                        });
                        
                        if (totalTroopsLost > 0) {
                            if (daimyo.id === this.gameState.playerDaimyo) {
                                this.gameState.addLog(`米不足により軍が離散！兵力${totalTroopsLost}失う`, 'strategy');
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `${daimyo.name}の軍が米不足で大幅に離散！`
                                });
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `${daimyo.name}が米不足により軍が離散！兵力${totalTroopsLost}減少`
                                });
                            }
                            
                            // 人事ログにも記録
                            this.gameState.addPersonnelLog(`${daimyo.name}が食料不足により軍の士気低下、兵力大幅減少`);
                        }
                    }
                });
                
                // 山城支配状況と天下人認定チェック
                try {
                    const yamashiro = this.gameState.territories.find(t => t && t.id === 'yamashiro');
                    if (yamashiro && yamashiro.owner) {
                        const currentOwner = yamashiro.owner;
                        
                        // 山城支配ターン数を更新
                        if (!this.gameState.yamashiroControl[currentOwner]) {
                            this.gameState.yamashiroControl[currentOwner] = 1;
                        } else {
                            this.gameState.yamashiroControl[currentOwner]++;
                        }
                        
                        // 他の大名の山城支配ターン数をリセット
                        Object.keys(this.gameState.yamashiroControl).forEach(daimyoId => {
                            if (daimyoId !== currentOwner) {
                                this.gameState.yamashiroControl[daimyoId] = 0;
                                this.gameState.tenkaninStatus[daimyoId] = false;
                            }
                        });
                        
                        // 6ターン連続支配で征夷大将軍認定
                        if (this.gameState.yamashiroControl[currentOwner] === 6 && !this.gameState.tenkaninStatus[currentOwner]) {
                            this.gameState.tenkaninStatus[currentOwner] = true;
                            
                            const ownerName = this.gameState.daimyos.find(d => d && d.id === currentOwner)?.name || '不明';
                            
                            if (currentOwner === this.gameState.playerDaimyo) {
                                // プレイヤーが征夷大将軍認定
                                const playerGenerals = this.gameState.generals.filter(g => g && g.lord === this.gameState.playerDaimyo);
                                const loyaltyBonus = 25;
                                
                                playerGenerals.forEach(general => {
                                    if (general && typeof general.loyalty === 'number') {
                                        general.loyalty = Math.min(100, general.loyalty + loyaltyBonus);
                                    }
                                });
                                
                                this.gameState.addLog(`🏛️【征夷大将軍就任】山城を6ターン支配！${ownerName}が征夷大将軍として幕府を開府！`, 'diplomacy');
                                this.gameState.addLog(`全武将の忠誠度が大幅上昇！武家政権の確立により士気向上効果も獲得`, 'diplomacy');
                                this.gameState.addPersonnelLog(`征夷大将軍就任により全武将の忠誠度+${loyaltyBonus}`);
                                
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `🏛️${ownerName}が征夷大将軍として幕府を開府！天下に武家政権を確立した`
                                });
                            } else {
                                // AI大名が征夷大将軍認定
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `🏛️【征夷大将軍就任】${ownerName}が山城を6ターン支配し、征夷大将軍として幕府を開府！`
                                });
                                
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `武家政権が確立！${ownerName}への対抗がますます困難となった`
                                });
                                
                                if (this.gameState.playerDaimyo) {
                                    this.gameState.addLog(`💀危機！${ownerName}が征夷大将軍となった。幕府との戦いが待っている`, 'strategy');
                                }
                            }
                        } else if (this.gameState.yamashiroControl[currentOwner] < 6) {
                            // まだ6ターンに達していない場合
                            const remainingTurns = 6 - this.gameState.yamashiroControl[currentOwner];
                            const ownerName = this.gameState.daimyos.find(d => d && d.id === currentOwner)?.name || '不明';
                            
                            if (currentOwner === this.gameState.playerDaimyo) {
                                this.gameState.addLog(`山城支配${this.gameState.yamashiroControl[currentOwner]}ターン目。征夷大将軍就任まであと${remainingTurns}ターン`, 'diplomacy');
                            } else if (Math.random() < 0.4) { // 40%の確率で表示
                                this.gameState.turnEvents.push({
                                    type: 'diplomacy',
                                    message: `${ownerName}が山城を${this.gameState.yamashiroControl[currentOwner]}ターン支配中。征夷大将軍就任まであと${remainingTurns}ターン`
                                });
                            }
                        }
                    } else {
                        // 山城が空白地の場合、全ての支配ターン数をリセット
                        Object.keys(this.gameState.yamashiroControl).forEach(daimyoId => {
                            this.gameState.yamashiroControl[daimyoId] = 0;
                            this.gameState.tenkaninStatus[daimyoId] = false;
                        });
                    }
                } catch (error) {
                    console.warn('山城支配チェック中にエラー:', error);
                }
                
                // 武将の忠誠度変化（自然減少のみ）
                try {
                    this.gameState.daimyos.forEach(daimyo => {
                        if (!daimyo || !daimyo.id) return;
                        
                        const daimyoGenerals = this.gameState.generals.filter(g => g && g.lord === daimyo.id);
                        
                        if (daimyoGenerals.length === 0) return;
                        
                        // 忠誠度の自然減少（70%の確率で-1）
                        daimyoGenerals.forEach(general => {
                            if (general && typeof general.loyalty === 'number' && Math.random() < 0.7) {
                                general.loyalty = Math.max(0, general.loyalty - 1);
                            }
                        });
                        
                        // プレイヤーの危険レベル武将の警告
                        if (daimyo.id === this.gameState.playerDaimyo) {
                            daimyoGenerals.forEach(general => {
                                if (general && general.loyalty <= 15 && Math.random() < 0.4) {
                                    this.gameState.addLog(`${general.name}の忠誠度が極めて危険(${general.loyalty})！`, 'strategy');
                                }
                            });
                        }
                    });
                } catch (error) {
                    console.warn('忠誠度変化処理中にエラー:', error);
                }
                
                // AI行動
                this.processAIActions();
                
                // 虚報防御をリセット（AI行動の後）
                this.gameState.rumorDefenseActive = false;
                this.gameState.rumorActivationRate = 0;
                
                // AI大名の人事管理（安全に実行）
                try {
                    this.processAIPersonnel();
                } catch (error) {
                    console.warn('AI人事管理中にエラーが発生しましたが、ゲームは続行します:', error);
                }
                
                // 新しい武将の登場チェック
                this.checkNewGeneralAppearance();
                
                // 大名家滅亡チェック
                this.checkDaimyoExtinction();
                
                // 外交協定をリセット（1ターン限りの効果）
                this.gameState.diplomacyTreaties = {};
                
                this.updateActionButtons();
            }
            
            processAIActions() {
                const aiDaimyos = this.gameState.daimyos.filter(d => d.id !== this.gameState.playerDaimyo);
                
                aiDaimyos.forEach(daimyo => {
                    const ownedTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                    if (ownedTerritories.length === 0) return;
                    
                    // 山城の状況をチェック
                    const yamashiro = this.gameState.territories.find(t => t.id === 'yamashiro');
                    const ownsYamashiro = yamashiro && yamashiro.owner === daimyo.id;
                    
                    // AI行動ロジック（山城優先）
                    const borderTerritories = [];
                    let yamashiroTarget = null;
                    
                    ownedTerritories.forEach(territory => {
                        territory.adjacentTerritories.forEach(adjId => {
                            const adjTerritory = this.gameState.territories.find(t => t.id === adjId);
                            if (adjTerritory && adjTerritory.owner !== daimyo.id) {
                                // 山城への攻撃は近江・大和からのみ可能
                                if (adjTerritory.id === 'yamashiro') {
                                    if (territory.id === 'omi' || territory.id === 'yamato') {
                                        borderTerritories.push(adjTerritory);
                                        yamashiroTarget = adjTerritory;
                                    }
                                } else {
                                    borderTerritories.push(adjTerritory);
                                }
                            }
                        });
                    });
                    
                    let target = null;
                    let attackReason = '';
                    
                    if (yamashiroTarget && !ownsYamashiro) {
                        // 山城が攻撃可能で、まだ持っていない場合は最優先
                        target = yamashiroTarget;
                        attackReason = '天下の中心地・山城を狙い';
                    } else if (borderTerritories.length > 0) {
                        if (ownsYamashiro) {
                            // 山城を既に持っている場合は通常の拡大戦略
                            target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                            attackReason = '山城を拠点として領土拡大を図り';
                        } else {
                            // 山城を持っていない場合は、山城に近い領土を優先
                            const yamashiroAdjacent = this.gameState.territories.find(t => t.id === 'yamashiro');
                            if (yamashiroAdjacent) {
                                const yamashiroNeighbors = borderTerritories.filter(t => 
                                    yamashiroAdjacent.adjacentTerritories.includes(t.id)
                                );
                                
                                if (yamashiroNeighbors.length > 0) {
                                    target = yamashiroNeighbors[Math.floor(Math.random() * yamashiroNeighbors.length)];
                                    attackReason = '山城への足がかりとして';
                                } else {
                                    target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                                    attackReason = '天下統一の野望を抱き';
                                }
                            } else {
                                target = borderTerritories[Math.floor(Math.random() * borderTerritories.length)];
                                attackReason = '領土拡大を図り';
                            }
                        }
                    }
                    
                    // 攻撃判定：山城を狙う場合は積極性を上げる
                    const baseAttackChance = target && target.id === 'yamashiro' ? 0.6 : 0.3;
                    
                    if (target && Math.random() < baseAttackChance) {
                        
                        // 外交協定チェック：相互不可侵条約がある場合は攻撃を控える
                        if (target.owner && this.gameState.diplomacyTreaties[daimyo.id] && 
                            this.gameState.diplomacyTreaties[daimyo.id].includes(target.owner)) {
                            this.gameState.turnEvents.push({
                                type: 'diplomacy',
                                message: `${daimyo.name}は${target.name}への攻撃を外交協定により控えた`
                            });
                            return; // 攻撃を中止
                        }
                        
                        // プレイヤー領土への攻撃の場合、虚報防御をチェック
                        if (target.owner === this.gameState.playerDaimyo && this.gameState.rumorDefenseActive) {
                            const rumorRoll = Math.random() * 100;
                            
                            if (rumorRoll <= this.gameState.rumorActivationRate) {
                                // 虚報防御成功
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `【虚報発動】${daimyo.name}の${target.name}への攻撃を虚報で撹乱し撃退！`
                                });
                                
                                this.gameState.addLog(`虚報防御発動！${daimyo.name}の攻撃を撹乱して追い返した`, 'strategy');
                                return; // 攻撃を無効化して処理終了
                            } else {
                                // 虚報防御失敗
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `【虚報失敗】${daimyo.name}が虚報を見破り${target.name}への攻撃を続行`
                                });
                                
                                this.gameState.addLog(`虚報防御失敗...${daimyo.name}に虚報を見破られた`, 'strategy');
                                // 攻撃処理は続行
                            }
                        }
                        
                        // プレイヤーが織田信長で鉄砲兵科の場合の守備効果をチェック
                        let nobunagaDefenseBonus = 1.0;
                        if (target.owner === this.gameState.playerDaimyo) {
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            if (playerDaimyo && playerDaimyo.skill === '革新者' && target.unitType === 'arquebus') {
                                nobunagaDefenseBonus = Math.random() * 0.1 + 1.3; // 1.3-1.4倍
                                this.gameState.turnEvents.push({
                                    type: 'strategy',
                                    message: `【鉄砲反撃発動】織田信長の革新的戦術により${target.name}の鉄砲隊が迎撃態勢！反撃力${(nobunagaDefenseBonus * 100).toFixed(0)}%増強！`
                                });
                            }
                        }
                        
                        // AI軍団戦力を計算（武将編成を考慮）+ 攻撃力強化
                        let aiAttackPower = this.calculateAIBattlePower(daimyo) + 15; // +15攻撃ボーナス
                        
                        // プレイヤー領土への攻撃時の鉄壁チェック
                        let ironwallActivated = false;
                        let ironwallActivator = '';
                        
                        if (target.owner === this.gameState.playerDaimyo) {
                            try {
                                // プレイヤーの防御武将を収集
                                let playerDefenderGenerals = [];
                                
                                // 城主武将
                                if (target.generalGarrison) {
                                    const castleCommander = this.gameState.generals.find(g => g && g.id === target.generalGarrison);
                                    if (castleCommander) {
                                        playerDefenderGenerals.push(castleCommander);
                                    }
                                }
                                
                                // プレイヤーの軍団武将
                                const playerMilitaryRoles = ['armyStrategist', 'vanguard', 'rightWing', 'leftWing', 'reserve'];
                                playerMilitaryRoles.forEach(roleKey => {
                                    const generalId = this.gameState.playerRoles[roleKey];
                                    if (generalId) {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId);
                                        if (general) {
                                            playerDefenderGenerals.push(general);
                                        }
                                    }
                                });
                                
                                // プレイヤー大名も追加
                                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                                if (playerDaimyo) {
                                    playerDefenderGenerals.push(playerDaimyo);
                                }
                                
                                // 鉄壁チェック（ターンイベント用のbattleLogを作成）
                                const tempBattleLog = { events: [] };
                                const ironwallResult = this.checkIronwallDefense(playerDefenderGenerals, tempBattleLog);
                                
                                if (ironwallResult.activated) {
                                    ironwallActivated = true;
                                    ironwallActivator = ironwallResult.activator;
                                    aiAttackPower = Math.floor(aiAttackPower * ironwallResult.multiplier);
                                    
                                    // 鉄壁発動をターンイベントに追加
                                    tempBattleLog.events.forEach(event => {
                                        if (event.message.includes('鉄壁の陣を敷こうとしている')) {
                                            this.gameState.turnEvents.push({
                                                type: 'strategy',
                                                message: event.message
                                            });
                                        } else if (event.message.includes('【鉄壁発動】')) {
                                            this.gameState.turnEvents.push({
                                                type: 'defense',
                                                message: event.message
                                            });
                                        }
                                    });
                                }
                            } catch (error) {
                                console.warn('AI戦闘での鉄壁チェック中にエラー:', error);
                            }
                        }
                        
                        // 武田信玄の風林火山効果：AI版騎馬突撃
                        if (daimyo.skill === '風林火山') {
                            const aiTerritories = this.gameState.territories.filter(t => t.owner === daimyo.id);
                            let aiMainUnit = 'infantry';
                            let maxTroops = 0;
                            
                            aiTerritories.forEach(territory => {
                                if (territory && territory.troops > maxTroops) {
                                    maxTroops = territory.troops;
                                    aiMainUnit = territory.unitType || 'infantry';
                                }
                            });
                            
                            if (aiMainUnit === 'cavalry') {
                                const chargeMultiplier = Math.random() * 0.4 + 1.1; // 1.1-1.5倍
                                aiAttackPower = Math.floor(aiAttackPower * chargeMultiplier);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `【騎馬突撃発動】${daimyo.name}の風林火山により騎馬隊が疾風迅雷の突撃！戦力${(chargeMultiplier * 100).toFixed(0)}%増強！`
                                });
                            }
                        }
                        
                        // AI攻撃側の士気補正
                        const aiDaimyoCharm = daimyo.stats?.charm || 50;
                        let aiMorale = 1.0;
                        if (aiDaimyoCharm <= 79) {
                            aiMorale = 0.8;
                        } else {
                            aiMorale = 1.0 + (aiDaimyoCharm - 80) * 0.07;
                        }
                        
                        // AI征夷大将軍効果：士気1.2倍
                        if (this.gameState.tenkaninStatus[daimyo.id]) {
                            aiMorale *= 1.2;
                            this.gameState.turnEvents.push({
                                type: 'battle',
                                message: `【征夷大将軍】${daimyo.name}の軍が幕府の威光により士気1.2倍で進軍！`
                            });
                        }
                        
                        const finalAiAttackPower = Math.floor(aiAttackPower * aiMorale);
                        
                        const troopDefensePower = Math.floor((target.troops || 0) / 10) + Math.random() * 10;
                        
                        // AI攻撃用の基本防御力を定義
                        const baseDefensePower = Math.floor((target.troops || 0) / 8) + Math.random() * 15;
                        
                        // AI武将の名前と数を取得
                        let aiGeneralsCount = 0;
                        let aiGeneralNames = [];
                        
                        try {
                            if (this.gameState.aiRoles && this.gameState.aiRoles[daimyo.id] && this.gameState.generals) {
                                const aiRoles = this.gameState.aiRoles[daimyo.id];
                                const assignedGeneralIds = Object.values(aiRoles).filter(id => {
                                    if (!id) return false;
                                    const general = this.gameState.generals.find(g => g && g.id === id && g.lord === daimyo.id);
                                    return general !== undefined;
                                });
                                
                                aiGeneralsCount = assignedGeneralIds.length;
                                
                                // 武将名を取得
                                assignedGeneralIds.forEach(generalId => {
                                    try {
                                        const general = this.gameState.generals.find(g => g && g.id === generalId && g.lord === daimyo.id);
                                        if (general && general.name) {
                                            aiGeneralNames.push(general.name);
                                        }
                                    } catch (error) {
                                        console.warn('AI武将名取得中にエラー:', error);
                                    }
                                });
                            }
                        } catch (error) {
                            console.warn('AI武将情報取得中にエラー:', error);
                        }
                        
                        // 攻撃開始メッセージ（武将名を含む + 山城への野望）
                        let attackMessage = `${daimyo.name}が${attackReason}${target.name}に攻撃を開始！軍団戦力${Math.floor(finalAiAttackPower)} (士気${(aiMorale * 100).toFixed(0)}%)`;
                        
                        try {
                            if (aiGeneralNames.length > 0) {
                                if (aiGeneralNames.length <= 2) {
                                    attackMessage += ` (${aiGeneralNames.join('、')}が参戦)`;
                                } else if (aiGeneralNames.length <= 4) {
                                    attackMessage += ` (${aiGeneralNames.slice(0, 3).join('、')}らが参戦)`;
                                } else {
                                    attackMessage += ` (${aiGeneralNames.slice(0, 2).join('、')}ら${aiGeneralsCount}名が参戦)`;
                                }
                            } else if (aiGeneralsCount > 0) {
                                attackMessage += ` (武将${aiGeneralsCount}名参戦)`;
                            }
                        } catch (error) {
                            console.warn('攻撃メッセージ作成中にエラー:', error);
                            if (aiGeneralsCount > 0) {
                                attackMessage += ` (武将${aiGeneralsCount}名参戦)`;
                            }
                        }
                        
                        this.gameState.turnEvents.push({
                            type: 'battle',
                            message: attackMessage
                        });
                        
                        if ((target.troops || 0) > 0) {
                            // 第1段階: 兵数への攻撃
                            if (finalAiAttackPower > troopDefensePower) {
                                const damage = Math.floor((finalAiAttackPower - troopDefensePower) * (Math.random() * 0.5 + 0.5));
                                const previousTroops = target.troops || 0;
                                target.troops = Math.max(0, (target.troops || 0) - damage);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}の守備兵${previousTroops}→${target.troops}に減少`
                                });
                                
                                if (target.troops === 0) {
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: `${target.name}の守備兵が全滅！城壁への攻撃開始`
                                    });
                                }
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}の守備兵が${daimyo.name}の攻撃を防いだ`
                                });
                            }
                        }
                        
                        if ((target.troops || 0) === 0) {
                            // 第2段階: 城壁への攻撃（兵数が0の場合のみ）
                            let wallDefensePower = (Math.floor((target.walls || 0) / 5) + Math.random() * 10) * 3;
                            
                            // AI大名が上杉謙信の場合、城壁守備力も半減
                            if (daimyo.skill === '軍神') {
                                wallDefensePower = Math.floor(wallDefensePower / 2);
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `【軍神効果】${daimyo.name}の神威により城壁守備力も半減！`
                                });
                            }
                            
                            if (finalAiAttackPower > wallDefensePower) {
                                const wallDamage = Math.floor((finalAiAttackPower - wallDefensePower) * (Math.random() * 0.4 + 0.3));
                                const previousWalls = target.walls || 0;
                                target.walls = Math.max(0, (target.walls || 0) - wallDamage);
                                
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}の城壁${previousWalls}→${target.walls}に破壊`
                                });
                                
                                if (target.walls <= 0) {
                                    // 城壁破壊で領土陥落
                                    const previousOwner = target.owner ? 
                                        this.gameState.daimyos.find(d => d && d.id === target.owner)?.name || '不明勢力' : 
                                        '空白地';
                                    
                                    target.owner = daimyo.id;
                                    target.troops = Math.floor(finalAiAttackPower / 5);
                                    target.walls = 100; // 奪取直後は100スタート
                                    
                                    // AI大名の得意兵科を設定
                                    if (daimyo.preferredUnit) {
                                        target.unitType = daimyo.preferredUnit;
                                    } else {
                                        target.unitType = 'infantry'; // デフォルトは歩兵
                                    }
                                    
                                    // 新しく獲得した領土にAI武将を配置
                                    this.assignNewTerritoryGeneral(daimyo.id, target);
                                    
                                    // プレイヤーが領土を失った場合の忠誠度減少
                                    if (previousOwner === this.gameState.playerDaimyo) {
                                        try {
                                            const playerGenerals = this.gameState.generals.filter(g => g && g.lord === this.gameState.playerDaimyo);
                                            if (playerGenerals.length > 0) {
                                                if (target.id === 'yamashiro') {
                                                    // 山城失陥時：天下人だった場合は大きなペナルティ
                                                    const wasTenkanin = this.gameState.tenkaninStatus[this.gameState.playerDaimyo];
                                                    const loyaltyPenalty = wasTenkanin ? 30 : 15;
                                                    
                                                    playerGenerals.forEach(general => {
                                                        if (general && typeof general.loyalty === 'number') {
                                                            general.loyalty = Math.max(0, general.loyalty - loyaltyPenalty);
                                                        }
                                                    });
                                                    
                                                    if (wasTenkanin) {
                                                        this.gameState.addLog(`💔天下人の地位を失った！山城失陥により威信が失墜...`, 'strategy');
                                                        this.gameState.addLog(`全武将の忠誠度が大幅低下。天下統一への道のりが遠のいた`, 'strategy');
                                                        this.gameState.addPersonnelLog(`天下人失墜により全武将の忠誠度-${loyaltyPenalty}`);
                                                    } else {
                                                        this.gameState.addLog(`💔天下の中心地・山城を失陥！武将の忠誠度が大幅低下...`, 'strategy');
                                                        this.gameState.addPersonnelLog(`山城失陥により全武将の忠誠度-${loyaltyPenalty}`);
                                                    }
                                                    
                                                    // 山城失陥の特別な影響
                                                    this.gameState.addLog(`天下への野望が大きく後退した...`, 'strategy');
                                                } else {
                                                    const loyaltyPenalty = 5;
                                                    playerGenerals.forEach(general => {
                                                        if (general && typeof general.loyalty === 'number') {
                                                            general.loyalty = Math.max(0, general.loyalty - loyaltyPenalty);
                                                        }
                                                    });
                                                    this.gameState.addLog(`領土失陥により武将の士気低下...`, 'strategy');
                                                    this.gameState.addPersonnelLog(`領土失陥により全武将の忠誠度-${loyaltyPenalty}`);
                                                }
                                            }
                                        } catch (error) {
                                            console.warn('領土失陥時の忠誠度減少処理中にエラー:', error);
                                        }
                                    }
                                    
                                    // 他のAI大名が山城を失った場合の特別メッセージ
                                    if (target.id === 'yamashiro' && previousOwner !== this.gameState.playerDaimyo && previousOwner !== '空白地') {
                                        const previousDaimyoName = this.gameState.daimyos.find(d => d && d.id === previousOwner)?.name || '不明勢力';
                                        const wasPreviousShogun = this.gameState.tenkaninStatus[previousOwner];
                                        
                                        if (wasPreviousShogun) {
                                            this.gameState.turnEvents.push({
                                                type: 'battle',
                                                message: `🏛️征夷大将軍${previousDaimyoName}が山城を失い、幕府が崩壊した！天下の覇権が移動している`
                                            });
                                        } else {
                                            this.gameState.turnEvents.push({
                                                type: 'battle',
                                                message: `${previousDaimyoName}が天下の覇権を失い、各地の情勢が一変した！`
                                            });
                                        }
                                    }
                                    
                                    let conquestMessage = `${daimyo.name}が${target.name}を攻略！`;
                                    if (previousOwner !== '空白地') {
                                        conquestMessage += `${previousOwner}の支配から奪取した。`;
                                    } else {
                                        conquestMessage += '空白地を新領土として確保。';
                                    }
                                    
                                    // 武将の活躍を具体的に表示
                                    try {
                                        if (aiGeneralNames.length > 0) {
                                            if (aiGeneralNames.length <= 2) {
                                                conquestMessage += ` ${aiGeneralNames.join('、')}が奮戦した。`;
                                            } else if (aiGeneralNames.length <= 3) {
                                                conquestMessage += ` ${aiGeneralNames.join('、')}らが奮戦した。`;
                                            } else {
                                                conquestMessage += ` ${aiGeneralNames.slice(0, 2).join('、')}ら${aiGeneralsCount}名が奮戦した。`;
                                            }
                                        } else if (aiGeneralsCount > 0) {
                                            conquestMessage += ` 配下武将${aiGeneralsCount}名が奮戦した。`;
                                        }
                                    } catch (error) {
                                        console.warn('AI攻略メッセージ作成中にエラー:', error);
                                        if (aiGeneralsCount > 0) {
                                            conquestMessage += ` 配下武将${aiGeneralsCount}名が奮戦した。`;
                                        }
                                    }
                                    
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: conquestMessage
                                    });
                                } else {
                                    this.gameState.turnEvents.push({
                                        type: 'battle',
                                        message: `${daimyo.name}が${target.name}の城壁に損傷を与えたが陥落には至らず`
                                    });
                                }
                            } else {
                                this.gameState.turnEvents.push({
                                    type: 'battle',
                                    message: `${target.name}の城壁が堅固で${daimyo.name}の攻撃を防いだ`
                                });
                            }
                        }
                    }
                });
            }
            
            showTurnLog() {
                document.getElementById('turn-log-screen').classList.remove('hidden');
                
                // 行動ログを表示
                const actionEventsContainer = document.getElementById('action-events');
                if (actionEventsContainer) {
                    if (this.gameState.turnEvents.length === 0) {
                        actionEventsContainer.innerHTML = '<div class="no-events">平穏な一年が過ぎた...</div>';
                    } else {
                        actionEventsContainer.innerHTML = this.gameState.turnEvents.map(event => 
                            `<div class="event-entry">${event.message}</div>`
                        ).join('');
                    }
                    
                    // 追加の迫力あるイベント
                    const dramaticEvents = [
                        '武将たちが激しく刀を交えた！',
                        '戦場に雄叫びが響き渡る！',
                        '城壁が崩れ落ちる音が轟いた！',
                        '騎馬隊が大地を駆け抜けた！',
                        '軍師の策略が功を奏した！'
                    ];
                    
                    if (this.gameState.turnEvents.length > 0 && Math.random() < 0.7) {
                        const dramaticEvent = dramaticEvents[Math.floor(Math.random() * dramaticEvents.length)];
                        actionEventsContainer.innerHTML += `<div class="event-entry">${dramaticEvent}</div>`;
                    }
                }
                
                // 人事ログを表示
                const personnelEventsContainer = document.getElementById('personnel-events');
                if (personnelEventsContainer) {
                    if (!this.gameState.personnelEvents || this.gameState.personnelEvents.length === 0) {
                        personnelEventsContainer.innerHTML = '<div class="no-events">人事関連の動きはありませんでした</div>';
                    } else {
                        try {
                            // 人事イベントを種類別に分類して表示
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            const playerName = playerDaimyo ? playerDaimyo.name : '';
                            
                            const playerEvents = this.gameState.personnelEvents.filter(e => 
                                playerName && (e.message.includes(playerName) ||
                                (!e.message.includes('が') && !e.message.includes('を')))
                            );
                            const aiEvents = this.gameState.personnelEvents.filter(e => !playerEvents.includes(e));
                            
                            let html = '';
                            
                            if (playerEvents.length > 0) {
                                html += '<div style="color: #66ff66; font-weight: bold; margin-bottom: 8px;">【自勢力】</div>';
                                html += playerEvents.map(event => 
                                    `<div class="event-entry" style="margin-left: 10px;">${event.message}</div>`
                                ).join('');
                            }
                            
                            if (aiEvents.length > 0) {
                                html += '<div style="color: #ffaa66; font-weight: bold; margin: 8px 0;">【他勢力】</div>';
                                html += aiEvents.map(event => 
                                    `<div class="event-entry" style="margin-left: 10px; color: #ccc;">${event.message}</div>`
                                ).join('');
                            }
                            
                            if (html === '') {
                                html = '<div class="no-events">人事関連の動きはありませんでした</div>';
                            }
                            
                            personnelEventsContainer.innerHTML = html;
                        } catch (error) {
                            console.warn('人事ログ表示中にエラー:', error);
                            personnelEventsContainer.innerHTML = '<div class="no-events">人事ログの表示でエラーが発生しました</div>';
                        }
                    }
                }
            }
            
            hideTurnLog() {
                document.getElementById('turn-log-screen').classList.add('hidden');
                this.renderMap();
                this.updateStatus();
            }
            
            showGeneralsModal() {
                document.getElementById('generals-modal').style.display = 'flex';
                this.initializeGeneralsModal();
            }
            
            hideGeneralsModal() {
                document.getElementById('generals-modal').style.display = 'none';
            }
            
            showRecruitGeneralModal() {
                document.getElementById('recruit-general-modal').style.display = 'flex';
                this.updateAvailableGeneralsList();
            }
            
            hideRecruitGeneralModal() {
                document.getElementById('recruit-general-modal').style.display = 'none';
            }
            
            showScoutModal() {
                try {
                    const target = this.gameState.selectedTerritory;
                    if (!target) {
                        this.gameState.addLog('偵察対象が選択されていません');
                        return;
                    }
                    
                    if (target.owner === this.gameState.playerDaimyo) {
                        this.gameState.addLog('自領土は偵察できません');
                        return;
                    }
                    
                    this.displayScoutInfo(target);
                    document.getElementById('scout-modal').style.display = 'flex';
                    
                    // 偵察ログ
                    const targetOwner = target.owner ? 
                        this.gameState.daimyos.find(d => d && d.id === target.owner)?.name || '不明勢力' : 
                        '空白地';
                    
                    let scoutMessage = `${target.name}(${targetOwner})を偵察`;
                    
                    // 財政情報を含める
                    if (target.owner) {
                        const ownerData = this.gameState.daimyos.find(d => d && d.id === target.owner);
                        if (ownerData) {
                            scoutMessage += ` - 金${ownerData.gold || 0} 米${ownerData.rice || 0}を確認`;
                        }
                    }
                    
                    this.gameState.addLog(scoutMessage, 'strategy');
                } catch (error) {
                    console.error('偵察モーダル表示中にエラー:', error);
                    this.gameState.addLog('偵察中にエラーが発生しました');
                }
            }
            
            hideScoutModal() {
                document.getElementById('scout-modal').style.display = 'none';
            }
            
            displayScoutInfo(target) {
                try {
                    const targetInfo = document.getElementById('scout-target-info');
                    const generalsInfo = document.getElementById('scout-generals-info');
                    
                    if (!targetInfo || !generalsInfo) {
                        console.error('偵察モーダルの要素が見つかりません');
                        return;
                    }
                    
                    // 対象領土の情報
                    const targetOwner = target.owner ? 
                        this.gameState.daimyos.find(d => d && d.id === target.owner) : 
                        null;
                    
                    let targetInfoHtml = `
                        <div style="background: #333; border: 1px solid #666; border-radius: 8px; padding: 15px;">
                            <h3 style="color: #ff6666; margin-bottom: 10px; text-align: center;">【${target.name} 偵察報告】</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                                <div><strong>支配者:</strong> ${targetOwner ? targetOwner.name : '空白地'}</div>
                                <div><strong>守備兵:</strong> ${target.troops || 0}</div>
                                <div><strong>城壁強度:</strong> ${target.walls || 0}</div>
                                <div><strong>農業:</strong> ${target.agriculture || 0}</div>
                                <div><strong>商業:</strong> ${target.commerce || 0}</div>
                                <div><strong>担当武将:</strong> ${this.getGeneralName(target.generalGarrison) || '未配置'}</div>
                            </div>
                    `;
                    
                    // 大名の資金情報を追加
                    if (targetOwner) {
                        targetInfoHtml += `
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #666;">
                                <h4 style="color: #ffff66; margin-bottom: 8px; text-align: center;">【財政状況】</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                                    <div><strong>保有金:</strong> <span style="color: #ffff66;">${targetOwner.gold || 0}</span></div>
                                    <div><strong>保有米:</strong> <span style="color: #66ff66;">${targetOwner.rice || 0}</span></div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; font-size: 11px; color: #ccc;">
                                    ※諜報網による推定値
                                </div>
                            </div>
                        `;
                    }
                    
                    targetInfoHtml += `</div>`;
                    
                    targetInfo.innerHTML = targetInfoHtml;
                    
                    // 武将情報
                    if (targetOwner && targetOwner.id) {
                        this.displayEnemyGenerals(targetOwner.id, generalsInfo);
                    } else {
                        generalsInfo.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">空白地のため武将情報はありません</div>';
                    }
                } catch (error) {
                    console.error('偵察情報表示中にエラー:', error);
                    const targetInfo = document.getElementById('scout-target-info');
                    const generalsInfo = document.getElementById('scout-generals-info');
                    
                    if (targetInfo) {
                        targetInfo.innerHTML = '<div style="color: #ff6666; text-align: center;">偵察情報の取得に失敗しました</div>';
                    }
                    if (generalsInfo) {
                        generalsInfo.innerHTML = '<div style="color: #ff6666; text-align: center;">武将情報の取得に失敗しました</div>';
                    }
                }
            }
            
            getGeneralName(generalId) {
                try {
                    if (!generalId || !this.gameState.generals) return null;
                    
                    const general = this.gameState.generals.find(g => g && g.id === generalId);
                    return general ? general.name : null;
                } catch (error) {
                    console.warn('武将名取得中にエラー:', error);
                    return null;
                }
            }
            
            displayEnemyGenerals(daimyoId, container) {
                try {
                    if (!daimyoId || !container || !this.gameState.generals) {
                        if (container) {
                            container.innerHTML = '<div style="color: #888; text-align: center;">武将情報を取得できません</div>';
                        }
                        return;
                    }
                    
                    // 敵の武将を取得
                    const enemyGenerals = this.gameState.generals.filter(g => g && g.lord === daimyoId);
                    
                    if (enemyGenerals.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">配下武将なし</div>';
                        return;
                    }
                    
                    // 敵の役職情報を取得
                    const enemyRoles = this.gameState.aiRoles && this.gameState.aiRoles[daimyoId] ? 
                        this.gameState.aiRoles[daimyoId] : {};
                    
                    let generalsHtml = `
                        <div style="background: #222; border: 1px solid #666; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #ff6666; margin-bottom: 15px; text-align: center;">配下武将一覧 (${enemyGenerals.length}名)</h4>
                    `;
                    
                    // 役職配置情報
                    const roleNames = {
                        'strategist': '参謀',
                        'diplomat': '外交担当',
                        'administrator': '人事総監',
                        'kenchiCommissioner': '検地奉行',
                        'riceCommissioner': '米奉行',
                        'townCommissioner': '町奉行',
                        'goldCommissioner': '金奉行',
                        'constructionCommissioner': '普請奉行',
                        'militaryCommissioner': '兵奉行',
                        'armyStrategist': '軍団軍師',
                        'vanguard': '前衛',
                        'rightWing': '右翼',
                        'leftWing': '左翼',
                        'reserve': '後詰'
                    };
                    
                    // 役職情報を表示
                    generalsHtml += '<div style="margin-bottom: 20px; background: #333; padding: 10px; border-radius: 5px;">';
                    generalsHtml += '<h5 style="color: #66ff66; margin-bottom: 10px;">役職配置</h5>';
                    generalsHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">';
                    
                    Object.entries(roleNames).forEach(([roleKey, roleName]) => {
                        try {
                            const assignedGeneralId = enemyRoles[roleKey];
                            let assignedGeneralName = '未設定';
                            
                            if (assignedGeneralId) {
                                const assignedGeneral = enemyGenerals.find(g => g && g.id === assignedGeneralId);
                                if (assignedGeneral) {
                                    assignedGeneralName = assignedGeneral.name || '無名武将';
                                }
                            }
                            
                            generalsHtml += `<div><strong>${roleName}:</strong> ${assignedGeneralName}</div>`;
                        } catch (error) {
                            console.warn(`役職${roleKey}の表示中にエラー:`, error);
                            generalsHtml += `<div><strong>${roleName}:</strong> 不明</div>`;
                        }
                    });
                    
                    generalsHtml += '</div></div>';
                    
                    // 武将詳細リスト
                    generalsHtml += '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    enemyGenerals.forEach((general, index) => {
                        try {
                            if (!general) return;
                            
                            // この武将の役職を特定
                            let currentRoles = [];
                            Object.entries(enemyRoles).forEach(([roleKey, assignedId]) => {
                                if (assignedId === general.id && roleNames[roleKey]) {
                                    currentRoles.push(roleNames[roleKey]);
                                }
                            });
                            
                            // 領土担当チェック
                            const assignedTerritories = this.gameState.territories.filter(t => 
                                t && t.generalGarrison === general.id
                            );
                            
                            if (assignedTerritories.length > 0) {
                                const territoryNames = assignedTerritories.map(t => t.name).join('、');
                                currentRoles.push(`${territoryNames}担当`);
                            }
                            
                            const roleText = currentRoles.length > 0 ? currentRoles.join('、') : '待機中';
                            const roleColor = currentRoles.length > 0 ? '#66ff66' : '#888';
                            
                            generalsHtml += `
                                <div style="background: #333; border: 1px solid #555; border-radius: 5px; padding: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: bold; color: #ff6666; font-size: 15px;">${general.name || '無名武将'}</div>
                                        <div style="color: ${roleColor}; font-size: 11px;">${roleText}</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-bottom: 8px;">
                                        <div><span>戦闘:</span> <span style="color: #ffaa66;">${general.stats?.battle || 0}</span></div>
                                        <div><span>統率:</span> <span style="color: #ffaa66;">${general.stats?.command || 0}</span></div>
                                        <div><span>政治:</span> <span style="color: #ffaa66;">${general.stats?.politics || 0}</span></div>
                                        <div><span>知謀:</span> <span style="color: #ffaa66;">${general.stats?.intelligence || 0}</span></div>
                                        <div><span>魅力:</span> <span style="color: #ffaa66;">${general.stats?.charm || 0}</span></div>
                                        <div><span>忠誠:</span> <span style="color: #ffff66;">${general.loyalty || 0}</span></div>
                                    </div>
                                    <div style="color: #66ff66; font-size: 12px;">
                                        <strong>特技:</strong> ${general.skill || '特技なし'}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.warn(`武将${general?.name || index}の表示中にエラー:`, error);
                            generalsHtml += `
                                <div style="background: #333; border: 1px solid #555; border-radius: 5px; padding: 12px; margin-bottom: 8px;">
                                    <div style="color: #ff6666;">武将情報の表示でエラーが発生しました</div>
                                </div>
                            `;
                        }
                    });
                    
                    generalsHtml += '</div></div>';
                    
                    container.innerHTML = generalsHtml;
                } catch (error) {
                    console.error('敵武将表示中にエラー:', error);
                    if (container) {
                        container.innerHTML = '<div style="color: #ff6666; text-align: center; padding: 20px;">武将情報の表示でエラーが発生しました</div>';
                    }
                }
            }
            
            showBattleLogModal() {
                document.getElementById('battle-log-modal').style.display = 'flex';
            }
            
            hideBattleLogModal() {
                document.getElementById('battle-log-modal').style.display = 'none';
            }
            
            displayBattleLog(battleLog) {
                try {
                    // 攻撃側情報を表示
                    const attackerDetails = document.getElementById('attacker-details');
                    if (!attackerDetails) {
                        return;
                    }
                    
                    let attackerHtml = `
                        <div><strong>${battleLog.attacker?.name || '不明'}</strong></div>
                        <div class="participant-stats">
                            <div><span>基本戦力:</span><span class="power-display">${battleLog.attacker?.basePower || 0}</span></div>
                            <div><span>総合戦力:</span><span class="power-display">${battleLog.attacker?.totalPower || 0}</span></div>
                    `;
                    
                    if (battleLog.attacker?.generals && Array.isArray(battleLog.attacker.generals) && battleLog.attacker.generals.length > 0) {
                        attackerHtml += '<div style="margin-top: 10px; color: #66ff66;"><strong>参戦武将:</strong></div>';
                        battleLog.attacker.generals.forEach(general => {
                            if (general && general.name) {
                                const roleNames = {
                                    'armyStrategist': '軍師', 'vanguard': '前衛', 
                                    'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                                };
                                const roleName = roleNames[general.role] || general.role || '不明';
                                const skillText = general.skill && general.skill !== '特技なし' ? ` 特技:${general.skill}` : '';
                                attackerHtml += `<div style="font-size: 11px; margin-left: 10px;">・${general.name}(${roleName}) 戦${general.battle || 0} 統${general.command || 0}${skillText}</div>`;
                            }
                        });
                    }
                    
                    attackerHtml += '</div>';
                    attackerDetails.innerHTML = attackerHtml;
                    
                    // 防御側情報を表示
                    const defenderDetails = document.getElementById('defender-details');
                    if (defenderDetails) {
                        let defenderHtml = `
                            <div><strong>${battleLog.defender?.name || '不明'}</strong></div>
                            <div class="participant-stats">
                                <div><span>基本戦力:</span><span class="power-display">${battleLog.defender?.basePower || 0}</span></div>
                                <div><span>守備兵:</span><span class="damage-display">${battleLog.defender?.troops || 0}</span></div>
                                <div><span>城壁強度:</span><span class="damage-display">${battleLog.defender?.walls || 0}</span></div>
                        `;
                        
                        if (battleLog.defender?.generals && Array.isArray(battleLog.defender.generals) && battleLog.defender.generals.length > 0) {
                            defenderHtml += '<div style="margin-top: 10px; color: #ff6666;"><strong>参戦武将:</strong></div>';
                            battleLog.defender.generals.forEach(general => {
                                if (general && general.name) {
                                    const roleNames = {
                                        'armyStrategist': '軍師', 'vanguard': '前衛', 
                                        'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                                    };
                                    const roleName = roleNames[general.role] || general.role || '不明';
                                    const skillText = general.skill && general.skill !== '特技なし' ? ` 特技:${general.skill}` : '';
                                    defenderHtml += `<div style="font-size: 11px; margin-left: 10px;">・${general.name}(${roleName}) 戦${general.battle || 0} 統${general.command || 0}${skillText}</div>`;
                                }
                            });
                        }
                        
                        defenderHtml += '</div>';
                        defenderDetails.innerHTML = defenderHtml;
                    }
                } catch (error) {
                    // 戦闘参加者情報表示中にエラーが発生しても継続
                }
                
                try {
                    // 戦闘イベントログを表示
                    const battleEvents = document.getElementById('battle-events-log');
                    if (!battleEvents) {
                        return;
                    }
                    
                    battleEvents.innerHTML = '';
                    
                    // 通常の戦闘イベント
                    if (battleLog.events && Array.isArray(battleLog.events)) {
                        battleLog.events.forEach(event => {
                            if (event && event.message) {
                                const eventDiv = document.createElement('div');
                                eventDiv.className = `battle-event ${event.type || 'normal'}`;
                                eventDiv.textContent = event.message;
                                battleEvents.appendChild(eventDiv);
                            }
                        });
                    }
                    
                    // 武将の活躍を表示（攻撃側と防御側を分けて表示）
                    if (battleLog.generalActivities && Array.isArray(battleLog.generalActivities) && battleLog.generalActivities.length > 0) {
                        const attackerActivities = battleLog.generalActivities.filter(activity => 
                            activity && (!activity.side || activity.side === 'attacker')
                        );
                        const defenderActivities = battleLog.generalActivities.filter(activity => 
                            activity && activity.side === 'defender'
                        );
                        
                        // 攻撃側の活躍
                        if (attackerActivities.length > 0) {
                            const activitiesHeader = document.createElement('div');
                            activitiesHeader.className = 'battle-event';
                            activitiesHeader.style.backgroundColor = '#003366';
                            activitiesHeader.style.borderLeftColor = '#66ccff';
                            activitiesHeader.style.fontWeight = 'bold';
                            activitiesHeader.style.marginTop = '15px';
                            activitiesHeader.textContent = '【攻撃軍武将の活躍】';
                            battleEvents.appendChild(activitiesHeader);
                            
                            attackerActivities.forEach(activity => {
                                if (activity && activity.name && activity.action) {
                                    const activityDiv = document.createElement('div');
                                    activityDiv.className = 'battle-event';
                                    activityDiv.style.backgroundColor = '#001133';
                                    activityDiv.style.borderLeftColor = '#66ccff';
                                    activityDiv.style.marginLeft = '10px';
                                    activityDiv.textContent = `${activity.name}(${activity.role || '不明'})が${activity.action}し、戦力${activity.contribution || 0}を発揮！`;
                                    battleEvents.appendChild(activityDiv);
                                }
                            });
                        }
                        
                        // 防御側の活躍
                        if (defenderActivities.length > 0) {
                            const defenderActivitiesHeader = document.createElement('div');
                            defenderActivitiesHeader.className = 'battle-event';
                            defenderActivitiesHeader.style.backgroundColor = '#330000';
                            defenderActivitiesHeader.style.borderLeftColor = '#ff6666';
                            defenderActivitiesHeader.style.fontWeight = 'bold';
                            defenderActivitiesHeader.style.marginTop = '15px';
                            defenderActivitiesHeader.textContent = '【守備軍武将の活躍】';
                            battleEvents.appendChild(defenderActivitiesHeader);
                            
                            defenderActivities.forEach(activity => {
                                if (activity && activity.name && activity.action) {
                                    const activityDiv = document.createElement('div');
                                    activityDiv.className = 'battle-event';
                                    activityDiv.style.backgroundColor = '#110000';
                                    activityDiv.style.borderLeftColor = '#ff6666';
                                    activityDiv.style.marginLeft = '10px';
                                    activityDiv.textContent = `${activity.name}(${activity.role || '不明'})が${activity.action}し、戦力${activity.contribution || 0}を発揮！`;
                                    battleEvents.appendChild(activityDiv);
                                }
                            });
                        }
                    }
                    
                    // 特技発動を表示（攻撃側と防御側を分けて表示）
                    if (battleLog.skillActivations && Array.isArray(battleLog.skillActivations) && battleLog.skillActivations.length > 0) {
                        const attackerSkills = battleLog.skillActivations.filter(s => s && s.activated && (!s.side || s.side === 'attacker'));
                        const defenderSkills = battleLog.skillActivations.filter(s => s && s.activated && s.side === 'defender');
                        
                        // 攻撃側の特技発動
                        if (attackerSkills.length > 0) {
                            const skillsHeader = document.createElement('div');
                            skillsHeader.className = 'battle-event';
                            skillsHeader.style.backgroundColor = '#330033';
                            skillsHeader.style.borderLeftColor = '#ff66ff';
                            skillsHeader.style.fontWeight = 'bold';
                            skillsHeader.style.marginTop = '15px';
                            skillsHeader.textContent = '【攻撃軍特技発動】';
                            battleEvents.appendChild(skillsHeader);
                            
                            attackerSkills.forEach(skill => {
                                if (skill && skill.name && skill.skill && skill.description) {
                                    const skillDiv = document.createElement('div');
                                    skillDiv.className = 'battle-event';
                                    skillDiv.style.backgroundColor = '#220022';
                                    skillDiv.style.borderLeftColor = '#ff66ff';
                                    skillDiv.style.marginLeft = '10px';
                                    skillDiv.innerHTML = `<strong>${skill.name}</strong>の「${skill.skill}」が発動！<br>${skill.description} (+${skill.bonus || 0}戦力)`;
                                    battleEvents.appendChild(skillDiv);
                                }
                            });
                        }
                        
                        // 防御側の特技発動
                        if (defenderSkills.length > 0) {
                            const defenderSkillsHeader = document.createElement('div');
                            defenderSkillsHeader.className = 'battle-event';
                            defenderSkillsHeader.style.backgroundColor = '#003300';
                            defenderSkillsHeader.style.borderLeftColor = '#66ff66';
                            defenderSkillsHeader.style.fontWeight = 'bold';
                            defenderSkillsHeader.style.marginTop = '15px';
                            defenderSkillsHeader.textContent = '【守備軍特技発動】';
                            battleEvents.appendChild(defenderSkillsHeader);
                            
                            defenderSkills.forEach(skill => {
                                if (skill && skill.name && skill.skill && skill.description) {
                                    const skillDiv = document.createElement('div');
                                    skillDiv.className = 'battle-event';
                                    skillDiv.style.backgroundColor = '#002200';
                                    skillDiv.style.borderLeftColor = '#66ff66';
                                    skillDiv.style.marginLeft = '10px';
                                    skillDiv.innerHTML = `<strong>${skill.name}</strong>の「${skill.skill}」が発動！<br>${skill.description} (+${skill.bonus || 0}戦力)`;
                                    battleEvents.appendChild(skillDiv);
                                }
                            });
                        }
                    }
                    
                    // 特技ボーナスの合計を表示（攻撃側と防御側を分けて）
                    const attackerSkillBonus = battleLog.result?.skillBonuses || 0;
                    const defenderSkillBonus = battleLog.result?.defenderSkillBonuses || 0;
                    
                    if (attackerSkillBonus > 0 || defenderSkillBonus > 0) {
                        const bonusDiv = document.createElement('div');
                        bonusDiv.className = 'battle-event victory';
                        bonusDiv.style.marginTop = '10px';
                        
                        let bonusText = '';
                        if (attackerSkillBonus > 0 && defenderSkillBonus > 0) {
                            bonusText = `特技効果 - 攻撃軍: +${attackerSkillBonus} 守備軍: +${defenderSkillBonus}`;
                        } else if (attackerSkillBonus > 0) {
                            bonusText = `攻撃軍特技効果: +${attackerSkillBonus}`;
                        } else if (defenderSkillBonus > 0) {
                            bonusText = `守備軍特技効果: +${defenderSkillBonus}`;
                        }
                        
                        bonusDiv.textContent = bonusText;
                        battleEvents.appendChild(bonusDiv);
                    }
                } catch (error) {
                    // 戦闘イベントログ表示中にエラーが発生しても継続
                }
                
                try {
                    // 戦果を表示
                    const battleResult = document.getElementById('battle-final-result');
                    if (!battleResult) {
                        return;
                    }
                    
                    let resultHtml = '';
                    const result = battleLog.result || {};
                    const attackerSkillBonuses = result.skillBonuses || 0;
                    const defenderSkillBonuses = result.defenderSkillBonuses || 0;
                    const attackerGeneralsCount = (battleLog.attacker && battleLog.attacker.generals) ? battleLog.attacker.generals.length : 0;
                    const defenderGeneralsCount = (battleLog.defender && battleLog.defender.generals) ? battleLog.defender.generals.length : 0;
                    const playerCasualties = result.playerCasualties || 0;
                    
                    if (result.conquered) {
                        resultHtml = `
                            <div class="result-summary success-display">勝利！領土を獲得しました！</div>
                            <div class="result-details">
                                <div class="result-item"><span>敵兵損害:</span><span class="damage-display">${result.troopDamage || 0}</span></div>
                                <div class="result-item"><span>敵城壁破壊:</span><span class="damage-display">${result.wallDamage || 0}</span></div>
                                <div class="result-item"><span>我軍損害:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>攻撃特技:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>守備特技:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>奇襲攻撃:</span><span class="success-display">${result.surpriseAttack ? '成功(1.5倍)' : '未発動'}</span></div>
                                <div class="result-item"><span>中央突破:</span><span class="success-display">${result.centralBreakthrough ? '発動(+100)' : '未発動'}</span></div>
                                <div class="result-item"><span>攻撃武将:</span><span class="power-display">${attackerGeneralsCount}名</span></div>
                                <div class="result-item"><span>守備武将:</span><span class="damage-display">${defenderGeneralsCount}名</span></div>
                            </div>
                        `;
                    } else if ((result.troopDamage || 0) > 0 || (result.wallDamage || 0) > 0) {
                        resultHtml = `
                            <div class="result-summary power-display">損害を与えました</div>
                            <div class="result-details">
                                <div class="result-item"><span>敵兵損害:</span><span class="damage-display">${result.troopDamage || 0}</span></div>
                                <div class="result-item"><span>敵城壁損傷:</span><span class="damage-display">${result.wallDamage || 0}</span></div>
                                <div class="result-item"><span>我軍損害:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>攻撃特技:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>守備特技:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>奇襲攻撃:</span><span class="success-display">${result.surpriseAttack ? '成功(1.5倍)' : '未発動'}</span></div>
                                <div class="result-item"><span>攻撃武将:</span><span class="power-display">${attackerGeneralsCount}名</span></div>
                                <div class="result-item"><span>守備武将:</span><span class="damage-display">${defenderGeneralsCount}名</span></div>
                            </div>
                        `;
                    } else {
                        resultHtml = `
                            <div class="result-summary damage-display">攻撃は防がれました</div>
                            <div class="result-details">
                                <div class="result-item"><span>我軍損害:</span><span class="damage-display">${playerCasualties}</span></div>
                                <div class="result-item"><span>攻撃特技:</span><span class="success-display">+${attackerSkillBonuses}</span></div>
                                <div class="result-item"><span>守備特技:</span><span class="power-display">+${defenderSkillBonuses}</span></div>
                                <div class="result-item"><span>奇襲攻撃:</span><span class="success-display">${result.surpriseAttack ? '成功も不発' : '未発動'}</span></div>
                                <div class="result-item"><span>中央突破:</span><span class="success-display">${result.centralBreakthrough ? '発動も不発' : '未発動'}</span></div>
                                <div class="result-item"><span>攻撃武将:</span><span class="power-display">${attackerGeneralsCount}名</span></div>
                                <div class="result-item"><span>守備武将:</span><span class="damage-display">${defenderGeneralsCount}名</span></div>
                            </div>
                            <div style="font-size: 12px; color: #ccc; margin-top: 10px;">
                                ${defenderGeneralsCount > 0 ? '敵武将の奮戦により攻撃が阻まれました' : '敵の防御が固く、有効な損害を与えることができませんでした'}
                                ${playerCasualties > 0 ? `<br>戦闘により我軍にも${playerCasualties}の損害が発生しました` : ''}
                            </div>
                        `;
                    }
                    
                    battleResult.innerHTML = resultHtml;
                } catch (error) {
                    console.warn('戦果表示中にエラー:', error);
                }
                
                // モーダルを表示
                this.showBattleLogModal();
            }
            
            switchTab(tabName) {
                // タブボタンの状態更新
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
                if (targetTabBtn) {
                    targetTabBtn.classList.add('active');
                }
                
                // タブコンテンツの表示切り替え
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                const targetTab = document.getElementById(`tab-${tabName}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // タブに応じた内容を更新（エラー防止）
                try {
                    switch(tabName) {
                        case 'assignment':
                            this.updateTerritoryAssignments();
                            break;
                        case 'roles':
                            this.updateRoleSelections();
                            break;
                        case 'army':
                            this.updateArmyFormation();
                            break;
                        case 'reward':
                            this.updateRewardTab();
                            break;
                        case 'list':
                            this.updateGeneralsList();
                            break;
                    }
                } catch (error) {
                    console.warn('タブ切り替え中にエラーが発生しましたが、継続します:', error);
                }
            }
            
            initializeGeneralsModal() {
                try {
                    // 初期化前に兼任チェックを実行
                    this.validateAndFixRoleAssignments();
                    this.switchTab('assignment');
                } catch (error) {
                    console.warn('武将モーダル初期化中にエラーが発生しましたが、継続します:', error);
                    // エラーが発生してもタブは切り替える
                    this.switchTab('assignment');
                }
            }
            
            updateTerritoryAssignments() {
                const container = document.getElementById('territory-assignment-list');
                const playerTerritories = this.gameState.getPlayerTerritories();
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                container.innerHTML = '';
                
                playerTerritories.forEach(territory => {
                    const assignmentDiv = document.createElement('div');
                    assignmentDiv.className = 'territory-assignment';
                    
                    // 既に他の領土に配置されている武将IDを取得
                    const assignedGeneralIds = playerTerritories
                        .filter(t => t.id !== territory.id && t.generalGarrison)
                        .map(t => t.generalGarrison);
                    
                    // 役職についている武将IDも取得
                    const roleAssignedIds = Object.values(this.gameState.playerRoles).filter(id => id !== null);
                    
                    // 利用可能な武将（未配置 and 役職なし or 現在この領土に配置済み）
                    const availableGenerals = playerGenerals.filter(g => 
                        (!assignedGeneralIds.includes(g.id) && !roleAssignedIds.includes(g.id)) || g.id === territory.generalGarrison
                    );
                    
                    assignmentDiv.innerHTML = `
                        <div class="territory-info">
                            <div class="territory-name-assign">${territory.name}</div>
                            <div class="territory-stats-assign">
                                農業:${territory.agriculture} 商業:${territory.commerce} 兵:${territory.troops}
                            </div>
                        </div>
                        <div class="assignment-controls">
                            <label>城主:</label>
                            <select data-territory="${territory.id}" class="territory-general-select">
                                <option value="">未設定</option>
                                ${availableGenerals.map(g => 
                                    `<option value="${g.id}" ${territory.generalGarrison === g.id ? 'selected' : ''}>${g.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    
                    container.appendChild(assignmentDiv);
                });
                
                // 変更イベントリスナーを追加
                container.querySelectorAll('.territory-general-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const territoryId = e.target.dataset.territory;
                        const newGeneralId = e.target.value;
                        const territory = this.gameState.territories.find(t => t.id === territoryId);
                        
                        // 新しい武将が選ばれた場合、他の領土・役職から同じ武将を除外
                        if (newGeneralId) {
                            // 他の領土から除外
                            playerTerritories.forEach(t => {
                                if (t.id !== territoryId && t.generalGarrison === newGeneralId) {
                                    t.generalGarrison = null;
                                }
                            });
                            
                            // 全ての役職から除外
                            Object.keys(this.gameState.playerRoles).forEach(roleKey => {
                                if (this.gameState.playerRoles[roleKey] === newGeneralId) {
                                    this.gameState.playerRoles[roleKey] = null;
                                }
                            });
                            
                            // 人事ログに記録
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            if (general) {
                                this.gameState.addPersonnelLog(`${general.name}を${territory.name}城主に任命`);
                            }
                        }
                        
                        territory.generalGarrison = newGeneralId || null;
                        
                        // 全ての武将配置を更新（重複除去のため）
                        this.updateAllGeneralAssignments();
                    });
                });
            }
            
            updateRoleSelections() {
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                // 現在の役職設定を表示
                this.displayCurrentRoles();
                
                // セレクトボックスを更新
                const roleSelects = [
                    { id: 'strategist-select', roleKey: 'strategist' },
                    { id: 'diplomat-select', roleKey: 'diplomat' },
                    { id: 'administrator-select', roleKey: 'administrator' },
                    { id: 'kenchi-commissioner-select', roleKey: 'kenchiCommissioner' },
                    { id: 'rice-commissioner-select', roleKey: 'riceCommissioner' },
                    { id: 'town-commissioner-select', roleKey: 'townCommissioner' },
                    { id: 'gold-commissioner-select', roleKey: 'goldCommissioner' },
                    { id: 'construction-commissioner-select', roleKey: 'constructionCommissioner' },
                    { id: 'military-commissioner-select', roleKey: 'militaryCommissioner' }
                ];
                
                roleSelects.forEach(({ id, roleKey }) => {
                    const select = document.getElementById(id);
                    if (!select) return; // エラー防止
                    
                    // 現在設定されている武将ID
                    const currentGeneralId = this.gameState.playerRoles[roleKey];
                    
                    // セレクトボックスをクリア
                    select.innerHTML = '<option value="">未設定</option>';
                    
                    // 利用可能な武将のみを追加
                    playerGenerals.forEach(general => {
                        // この武将が他の役職についていないか、または現在のこの役職についているかをチェック
                        const isAvailable = this.isGeneralAvailable(general.id, roleKey);
                        
                        if (isAvailable || general.id === currentGeneralId) {
                            const option = document.createElement('option');
                            option.value = general.id;
                            option.textContent = general.name;
                            if (general.id === currentGeneralId) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        }
                    });
                    
                    // 変更イベントリスナーを新たに追加（重複防止のため削除してから追加）
                    const newSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(newSelect, select);
                    
                    newSelect.addEventListener('change', (e) => {
                        const newGeneralId = e.target.value || null;
                        const oldGeneralId = this.gameState.playerRoles[roleKey];
                        
                        // 重要役職の変更には金100が必要
                        const importantRoles = ['strategist', 'diplomat', 'administrator'];
                        if (importantRoles.includes(roleKey) && newGeneralId && newGeneralId !== oldGeneralId) {
                            const playerDaimyo = this.gameState.getPlayerDaimyoData();
                            if (playerDaimyo.gold < 100) {
                                this.gameState.addLog('重要役職の変更には金100が必要です');
                                e.target.value = oldGeneralId || '';
                                return;
                            }
                            playerDaimyo.gold -= 100;
                            this.gameState.addLog('重要役職変更により金100を消費', 'strategy');
                        }
                        
                        // 新しい武将が選ばれた場合、他の役職から除外
                        if (newGeneralId && newGeneralId !== oldGeneralId) {
                            this.removeGeneralFromOtherRoles(newGeneralId, roleKey);
                            
                            // 人事ログに記録
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            const roleNames = { 
                                'strategist': '参謀', 
                                'diplomat': '外交担当', 
                                'administrator': '人事総監',
                                'kenchiCommissioner': '検地奉行',
                                'riceCommissioner': '米奉行',
                                'townCommissioner': '町奉行',
                                'goldCommissioner': '金奉行',
                                'constructionCommissioner': '普請奉行',
                                'militaryCommissioner': '兵奉行'
                            };
                            const roleName = roleNames[roleKey];
                            if (general && roleName) {
                                const costText = importantRoles.includes(roleKey) ? '（費用：金100）' : '';
                                this.gameState.addPersonnelLog(`${general.name}を${roleName}に任命${costText}`);
                            }
                        }
                        
                        this.gameState.playerRoles[roleKey] = newGeneralId;
                        this.displayCurrentRoles();
                        this.updateAllGeneralAssignments(); // 全てのセレクトボックスを更新
                        this.updateStatus(); // 金の表示を更新
                    });
                });
            }
            
            updateArmyFormation() {
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                // 現在の軍団編成を表示
                this.displayCurrentArmyFormation();
                
                // 大将名を表示
                const generalNameElement = document.getElementById('general-name');
                if (generalNameElement) {
                    generalNameElement.textContent = playerDaimyo.name;
                }
                
                // 各ポジションのセレクトボックスを更新
                const positions = [
                    { id: 'army-strategist', roleKey: 'armyStrategist' },
                    { id: 'vanguard', roleKey: 'vanguard' },
                    { id: 'right-wing', roleKey: 'rightWing' },
                    { id: 'left-wing', roleKey: 'leftWing' },
                    { id: 'reserve', roleKey: 'reserve' }
                ];
                
                positions.forEach(({ id, roleKey }) => {
                    const select = document.getElementById(id);
                    if (!select) return; // エラー防止
                    
                    // 現在設定されている武将ID
                    const currentGeneralId = this.gameState.playerRoles[roleKey];
                    
                    // セレクトボックスをクリア
                    select.innerHTML = '<option value="">未設定</option>';
                    
                    // 利用可能な武将のみを追加
                    playerGenerals.forEach(general => {
                        const isAvailable = this.isGeneralAvailable(general.id, roleKey);
                        
                        if (isAvailable || general.id === currentGeneralId) {
                            const option = document.createElement('option');
                            option.value = general.id;
                            option.textContent = general.name;
                            if (general.id === currentGeneralId) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        }
                    });
                    
                    // 変更イベントリスナーを新たに追加
                    const newSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(newSelect, select);
                    
                    newSelect.addEventListener('change', (e) => {
                        const newGeneralId = e.target.value || null;
                        const oldGeneralId = this.gameState.playerRoles[roleKey];
                        
                        // 新しい武将が選ばれた場合、他の役職から除外
                        if (newGeneralId && newGeneralId !== oldGeneralId) {
                            this.removeGeneralFromOtherRoles(newGeneralId, roleKey);
                            
                            // 人事ログに記録
                            const general = this.gameState.generals.find(g => g.id === newGeneralId);
                            const positionNames = { 
                                'armyStrategist': '軍師', 'vanguard': '前衛', 
                                'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰' 
                            };
                            const positionName = positionNames[roleKey];
                            if (general && positionName) {
                                this.gameState.addPersonnelLog(`${general.name}を${positionName}に配置`);
                            }
                        }
                        
                        this.gameState.playerRoles[roleKey] = newGeneralId;
                        this.displayCurrentArmyFormation();
                        this.calculateArmyStats();
                        this.updateAllGeneralAssignments(); // 全てのセレクトボックスを更新
                    });
                });
                
                this.calculateArmyStats();
            }
            
            // 武将が他の役職についていないかチェック（領土担当も含む）
            isGeneralAvailable(generalId, currentRoleKey) {
                // 役職チェック
                const allRoles = Object.keys(this.gameState.playerRoles);
                for (let roleKey of allRoles) {
                    if (roleKey !== currentRoleKey && this.gameState.playerRoles[roleKey] === generalId) {
                        return false; // 他の役職についている
                    }
                }
                
                // 領土担当チェック
                const assignedToTerritory = this.gameState.territories.some(t => 
                    t.owner === this.gameState.playerDaimyo && t.generalGarrison === generalId
                );
                
                if (assignedToTerritory) {
                    return false; // 領土担当についている
                }
                
                return true; // 利用可能
            }
            
            // 武将を他の役職から除外（領土担当も含む）
            removeGeneralFromOtherRoles(generalId, keepRoleKey) {
                // 役職から除外
                const allRoles = Object.keys(this.gameState.playerRoles);
                allRoles.forEach(roleKey => {
                    if (roleKey !== keepRoleKey && this.gameState.playerRoles[roleKey] === generalId) {
                        this.gameState.playerRoles[roleKey] = null;
                    }
                });
                
                // 領土担当から除外
                this.gameState.territories.forEach(territory => {
                    if (territory.owner === this.gameState.playerDaimyo && territory.generalGarrison === generalId) {
                        territory.generalGarrison = null;
                    }
                });
            }
            
            // 全ての武将配置を更新
            updateAllGeneralAssignments() {
                setTimeout(() => {
                    try {
                        this.updateTerritoryAssignments();
                        this.updateRoleSelections();
                        this.updateArmyFormation();
                        this.calculateArmyStats();
                    } catch (error) {
                        console.warn('武将配置更新中にエラーが発生しましたが、継続します:', error);
                    }
                }, 50);
            }
            
            // 全ての役職セレクトボックスを更新
            updateAllRoleSelects() {
                // 遅延実行でエラーを防ぐ
                setTimeout(() => {
                    try {
                        this.updateRoleSelections();
                        this.updateArmyFormation();
                    } catch (error) {
                        console.warn('役職更新中にエラーが発生しましたが、継続します:', error);
                    }
                }, 50);
            }
            
            displayCurrentRoles() {
                const container = document.getElementById('current-roles-list');
                if (!container) return; // エラー防止
                
                const importantRoles = {
                    'strategist': '参謀',
                    'diplomat': '外交担当',
                    'administrator': '人事総監'
                };
                
                const commissionerRoles = {
                    'kenchiCommissioner': '検地奉行',
                    'riceCommissioner': '米奉行',
                    'townCommissioner': '町奉行',
                    'goldCommissioner': '金奉行',
                    'constructionCommissioner': '普請奉行',
                    'militaryCommissioner': '兵奉行'
                };
                
                container.innerHTML = '';
                
                // 重要役職セクション
                const importantHeader = document.createElement('div');
                importantHeader.style.cssText = 'color: #ff6666; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;';
                importantHeader.textContent = '重要役職';
                container.appendChild(importantHeader);
                
                Object.entries(importantRoles).forEach(([key, label]) => {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = '未設定';
                    let valueClass = 'role-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'role-value';
                        }
                    }
                    
                    roleDiv.innerHTML = `
                        <span class="role-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(roleDiv);
                });
                
                // 奉行職セクション
                const commissionerHeader = document.createElement('div');
                commissionerHeader.style.cssText = 'color: #66ff66; font-weight: bold; margin: 15px 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px;';
                commissionerHeader.textContent = '奉行職';
                container.appendChild(commissionerHeader);
                
                Object.entries(commissionerRoles).forEach(([key, label]) => {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = '未設定';
                    let valueClass = 'role-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'role-value';
                        }
                    }
                    
                    roleDiv.innerHTML = `
                        <span class="role-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(roleDiv);
                });
            }
            
            displayCurrentArmyFormation() {
                const container = document.getElementById('current-army-formation');
                const positions = {
                    'armyStrategist': '軍師',
                    'vanguard': '前衛',
                    'rightWing': '右翼',
                    'leftWing': '左翼',
                    'reserve': '後詰'
                };
                
                container.innerHTML = '';
                
                // 大将を追加
                const generalDiv = document.createElement('div');
                generalDiv.className = 'formation-item';
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                generalDiv.innerHTML = `
                    <span class="formation-label">大将:</span>
                    <span class="formation-value">${playerDaimyo.name}</span>
                `;
                container.appendChild(generalDiv);
                
                // その他のポジション
                Object.entries(positions).forEach(([key, label]) => {
                    const formationDiv = document.createElement('div');
                    formationDiv.className = 'formation-item';
                    
                    const generalId = this.gameState.playerRoles[key];
                    let generalName = '未設定';
                    let valueClass = 'formation-value empty';
                    
                    if (generalId) {
                        const general = this.gameState.generals.find(g => g.id === generalId);
                        if (general) {
                            generalName = general.name;
                            valueClass = 'formation-value';
                        }
                    }
                    
                    formationDiv.innerHTML = `
                        <span class="formation-label">${label}:</span>
                        <span class="${valueClass}">${generalName}</span>
                    `;
                    
                    container.appendChild(formationDiv);
                });
            }
            
            calculateArmyStats() {
                try {
                    const playerDaimyo = this.gameState.getPlayerDaimyoData();
                    if (!playerDaimyo || !playerDaimyo.stats) {
                        return; // 大名データがない場合は処理を中断
                    }
                    
                    let attackPower = playerDaimyo.stats.battle || 0;
                    let defensePower = Math.floor((playerDaimyo.stats.command || 0) / 3);
                    let intelligencePower = playerDaimyo.stats.intelligence || 0;
                    
                    // 各ポジションの武将を取得して能力を合計
                    const positions = {
                        'armyStrategist': { command: 1, intelligence: 1 },
                        'vanguard': { battle: 1, command: 1 },
                        'rightWing': { battle: 1 },
                        'leftWing': { battle: 1 },
                        'reserve': { command: 1 }
                    };
                    
                    let assignedGeneralsCount = 0;
                    
                    Object.entries(positions).forEach(([roleKey, stats]) => {
                        try {
                            const generalId = this.gameState.playerRoles[roleKey];
                            if (generalId) {
                                const general = this.gameState.generals.find(g => g && g.id === generalId);
                                if (general && general.stats) {
                                    assignedGeneralsCount++;
                                    if (stats.battle) attackPower += general.stats.battle || 0;
                                    if (stats.command) defensePower += Math.floor((general.stats.command || 0) / 3);
                                    if (stats.intelligence) intelligencePower += general.stats.intelligence || 0;
                                }
                            }
                        } catch (error) {
                            // 軍団戦力計算中にエラーが発生しても継続
                        }
                    });
                    
                    // 軍師ボーナス（役職設定の軍師）
                    try {
                        if (this.gameState.playerRoles.strategist) {
                            const strategist = this.gameState.generals.find(g => g && g.id === this.gameState.playerRoles.strategist);
                            if (strategist && strategist.stats) {
                                defensePower += Math.floor(((strategist.stats.command || 0) + (strategist.stats.intelligence || 0)) / 10);
                                intelligencePower += Math.floor((strategist.stats.intelligence || 0) / 5);
                            }
                        }
                    } catch (error) {
                        // 軍師ボーナス計算中にエラーが発生しても継続
                    }
                    
                    const totalPower = attackPower + defensePower + intelligencePower;
                    
                    // UI要素の存在確認後に更新
                    const attackElement = document.getElementById('army-attack');
                    const defenseElement = document.getElementById('army-defense');
                    const intelligenceElement = document.getElementById('army-intelligence');
                    const totalElement = document.getElementById('total-army-power');
                    
                    if (attackElement) attackElement.textContent = attackPower;
                    if (defenseElement) defenseElement.textContent = defensePower;
                    if (intelligenceElement) intelligenceElement.textContent = intelligencePower;
                    if (totalElement) totalElement.textContent = totalPower;
                } catch (error) {
                    // 軍団戦力計算中にエラーが発生しても継続
                }
            }
            
            updateMainStatusWithArmyPower(attack, defense, intelligence, total, assignedCount = 0) {
                try {
                    // メインステータス表示エリアに軍団戦力を表示
                    const statusDisplay = document.querySelector('.status-display');
                    if (!statusDisplay) return;
                    
                    let armyPowerDiv = statusDisplay.querySelector('.army-power-status');
                    
                    if (!armyPowerDiv) {
                        armyPowerDiv = document.createElement('div');
                        armyPowerDiv.className = 'army-power-status';
                        armyPowerDiv.style.marginTop = '10px';
                        armyPowerDiv.style.borderTop = '1px solid #666';
                        armyPowerDiv.style.paddingTop = '10px';
                        statusDisplay.appendChild(armyPowerDiv);
                    }
                    
                    const assignedText = assignedCount > 0 ? ` (武将${assignedCount}名)` : '';
                    
                    armyPowerDiv.innerHTML = `
                        <div><strong>軍団戦力:</strong> ${total}${assignedText}</div>
                        <div style="font-size: 10px; color: #ccc;">
                            攻:${attack} 防:${defense} 謀:${intelligence}
                        </div>
                    `;
                } catch (error) {
                    // 軍団戦力表示更新中にエラーが発生しても継続
                }
            }
            
            updateGeneralsList() {
                const container = document.getElementById('generals-list');
                if (!container) return;
                
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                if (playerGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">配下武将なし</div>';
                    return;
                }
                
                let html = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #444; border-bottom: 2px solid #666;">
                                <th style="padding: 8px; border: 1px solid #666; color: #ff6666;">武将名</th>
                                <th style="padding: 8px; border: 1px solid #666;">戦</th>
                                <th style="padding: 8px; border: 1px solid #666;">統</th>
                                <th style="padding: 8px; border: 1px solid #666;">政</th>
                                <th style="padding: 8px; border: 1px solid #666;">知</th>
                                <th style="padding: 8px; border: 1px solid #666;">魅</th>
                                <th style="padding: 8px; border: 1px solid #666;">忠誠</th>
                                <th style="padding: 8px; border: 1px solid #666;">配置</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                playerGenerals.forEach(general => {
                    // 配置状況を取得
                    let assignmentStatus = [];
                    
                    const assignedTerritory = this.gameState.territories.find(t => t.generalGarrison === general.id);
                    if (assignedTerritory) {
                        assignmentStatus.push(`${assignedTerritory.name}城主`);
                    }
                    
                    const roleNames = {
                        'strategist': '参謀', 'diplomat': '外交', 'administrator': '人事',
                        'kenchiCommissioner': '検地', 'riceCommissioner': '米奉行',
                        'townCommissioner': '町奉行', 'goldCommissioner': '金奉行',
                        'constructionCommissioner': '普請', 'militaryCommissioner': '兵奉行',
                        'armyStrategist': '軍師', 'vanguard': '前衛',
                        'rightWing': '右翼', 'leftWing': '左翼', 'reserve': '後詰'
                    };
                    
                    Object.entries(this.gameState.playerRoles).forEach(([roleKey, assignedGeneralId]) => {
                        if (assignedGeneralId === general.id && roleNames[roleKey]) {
                            assignmentStatus.push(roleNames[roleKey]);
                        }
                    });
                    
                    const statusText = assignmentStatus.length > 0 ? assignmentStatus.join(',') : '待機';
                    const loyaltyColor = general.loyalty > 70 ? '#66ff66' : general.loyalty > 40 ? '#ffff66' : '#ff6666';
                    
                    html += `
                        <tr style="border-bottom: 1px solid #555;">
                            <td style="padding: 6px; border: 1px solid #555; color: #ff6666; font-weight: bold;">${general.name}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.battle}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.command}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.politics}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.intelligence}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.charm}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${loyaltyColor};">${general.loyalty}</td>
                            <td style="padding: 6px; border: 1px solid #555; font-size: 10px;">${statusText}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            updateRewardTab() {
                const container = document.getElementById('reward-generals-list');
                if (!container) return;
                
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                const playerGenerals = this.gameState.generals.filter(g => g.lord === this.gameState.playerDaimyo);
                
                if (playerGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">配下武将なし</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                playerGenerals.forEach(general => {
                    const generalCard = document.createElement('div');
                    generalCard.className = 'general-card';
                    generalCard.style.marginBottom = '10px';
                    
                    const loyaltyColor = general.loyalty > 70 ? '#66ff66' : general.loyalty > 40 ? '#ffff66' : '#ff6666';
                    const canAfford = playerDaimyo.gold >= 100;
                    const canIncrease = general.loyalty < 100;
                    const canReward = canAfford && canIncrease;
                    
                    generalCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div class="general-name">${general.name}</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin: 8px 0;">
                                    <div>戦闘: ${general.stats.battle}</div>
                                    <div>統率: ${general.stats.command}</div>
                                    <div>政治: ${general.stats.politics}</div>
                                    <div>知謀: ${general.stats.intelligence}</div>
                                    <div>魅力: ${general.stats.charm}</div>
                                    <div style="color: ${loyaltyColor};">忠誠: ${general.loyalty}</div>
                                </div>
                                <div style="color: #66ff66; font-size: 12px;">特技: ${general.skill}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <button class="btn" onclick="uiManager.giveReward('${general.id}')" 
                                        ${!canReward ? 'disabled' : ''} 
                                        style="padding: 8px 16px; font-size: 11px; ${canReward ? 'background: linear-gradient(145deg, #006600, #008800); border-color: #00aa00;' : ''}">
                                    ${!canAfford ? '金不足' : !canIncrease ? '上限' : '下賜する'}
                                </button>
                                <div style="font-size: 10px; color: #ccc; text-align: center;">
                                    金100 → 忠誠+25
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(generalCard);
                });
            }
            
            giveReward(generalId) {
                const general = this.gameState.generals.find(g => g.id === generalId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!general || !playerDaimyo || playerDaimyo.gold < 100 || general.loyalty >= 100) {
                    this.gameState.addLog('下賜を実行できません');
                    return;
                }
                
                // 費用を支払い、忠誠度を上昇
                playerDaimyo.gold -= 100;
                const oldLoyalty = general.loyalty;
                general.loyalty = Math.min(100, general.loyalty + 25);
                
                this.gameState.addLog(`${general.name}に下賜を行い、忠誠度が${oldLoyalty}→${general.loyalty}に上昇`, 'diplomacy');
                this.gameState.addPersonnelLog(`${general.name}に金100を下賜し忠誠度+25`);
                
                // 表示を更新
                this.updateRewardTab();
                this.updateStatus();
            }
            
            saveGeneralsSettings() {
                try {
                    // 兼任チェックを行い、問題がある場合は修正
                    this.validateAndFixRoleAssignments();
                    
                    // 設定を保存（現在は即時反映済み）
                    this.gameState.addLog('武将設定を更新しました');
                    this.gameState.addPersonnelLog('武将の役職設定を変更しました');
                    this.hideGeneralsModal();
                    this.renderMap();
                    this.updateStatus();
                } catch (error) {
                    console.error('武将設定保存中にエラーが発生:', error);
                    this.gameState.addLog('設定保存中にエラーが発生しましたが、ゲームは続行できます');
                }
            }
            
            // 役職の重複をチェックして修正
            validateAndFixRoleAssignments() {
                const usedGenerals = new Set();
                const conflictingRoles = [];
                
                // 重複をチェック
                Object.entries(this.gameState.playerRoles).forEach(([roleKey, generalId]) => {
                    if (generalId) {
                        if (usedGenerals.has(generalId)) {
                            conflictingRoles.push(roleKey);
                        } else {
                            usedGenerals.add(generalId);
                        }
                    }
                });
                
                // 重複がある場合は最後に設定されたもの以外をクリア
                conflictingRoles.forEach(roleKey => {
                    this.gameState.playerRoles[roleKey] = null;
                });
                
                if (conflictingRoles.length > 0) {
                    this.gameState.addLog(`重複した役職設定を修正しました: ${conflictingRoles.length}件`);
                }
            }
            
            updateAvailableGeneralsList() {
                const container = document.getElementById('available-generals-list');
                if (!container) return;
                
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                if (!playerDaimyo) return;
                
                if (this.gameState.availableGenerals.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">現在登用可能な武将はいません</div>';
                    return;
                }
                
                // 天下人ボーナス表示
                const bonusDisplay = playerDaimyo.skill === '天下人' ? ' <span style="color: #ffcc33;">(+20%)</span>' : '';
                
                let html = `
                    <div style="color: #ccc; font-size: 11px; margin-bottom: 10px;">※成功率は人事総監の魅力に依存${bonusDisplay}</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #444; border-bottom: 2px solid #666;">
                                <th style="padding: 6px; border: 1px solid #666; color: #ff6666;">武将名</th>
                                <th style="padding: 6px; border: 1px solid #666;">戦</th>
                                <th style="padding: 6px; border: 1px solid #666;">統</th>
                                <th style="padding: 6px; border: 1px solid #666;">政</th>
                                <th style="padding: 6px; border: 1px solid #666;">知</th>
                                <th style="padding: 6px; border: 1px solid #666;">魅</th>
                                <th style="padding: 6px; border: 1px solid #666;">特技</th>
                                <th style="padding: 6px; border: 1px solid #666;">成功率</th>
                                <th style="padding: 6px; border: 1px solid #666;">登用</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                this.gameState.availableGenerals.forEach(general => {
                    const recruitChance = this.calculateRecruitChance(general, playerDaimyo);
                    let chanceColor = '#ff6666';
                    if (recruitChance >= 70) chanceColor = '#66ff66';
                    else if (recruitChance >= 40) chanceColor = '#ffff66';
                    
                    const canAfford = playerDaimyo.gold >= 100;
                    
                    html += `
                        <tr style="border-bottom: 1px solid #555;">
                            <td style="padding: 6px; border: 1px solid #555; color: #ff6666; font-weight: bold;">${general.name}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.battle}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.command}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.politics}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.intelligence}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">${general.stats.charm}</td>
                            <td style="padding: 6px; border: 1px solid #555; font-size: 10px;">${general.skill}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${chanceColor};">${recruitChance}%</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: center;">
                                <button class="btn" onclick="uiManager.attemptGeneralRecruitment('${general.id}')" 
                                        ${!canAfford ? 'disabled' : ''} 
                                        style="padding: 4px 8px; font-size: 10px; ${canAfford ? 'background: linear-gradient(145deg, #006600, #008800); border-color: #00aa00;' : ''}">
                                    ${canAfford ? '登用' : '金不足'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            calculateRecruitChance(general, playerDaimyo) {
                try {
                    // 人事総監の魅力を取得
                    let administratorCharm = 0;
                    if (this.gameState.playerRoles.administrator) {
                        const administrator = this.gameState.generals.find(g => g.id === this.gameState.playerRoles.administrator);
                        if (administrator && administrator.stats) {
                            administratorCharm = administrator.stats.charm || 0;
                        }
                    }
                    
                    // 新しい成功率計算: (人事総監の魅力 - 80) * 4
                    let successChance = (administratorCharm - 80) * 4;
                    
                    // 羽柴秀吉の天下人効果: 登用成功率+20%
                    if (playerDaimyo.skill === '天下人') {
                        successChance += 20;
                    }
                    
                    // 最低10%保証
                    return Math.max(10, successChance);
                } catch (error) {
                    console.warn('登用成功率計算中にエラーが発生:', error);
                    return 10; // デフォルト値
                }
            }
            
            attemptGeneralRecruitment(generalId) {
                const general = this.gameState.availableGenerals.find(g => g.id === generalId);
                const playerDaimyo = this.gameState.getPlayerDaimyoData();
                
                if (!general || !playerDaimyo || playerDaimyo.gold < 100) {
                    this.gameState.addLog('登用には金100が必要です');
                    return;
                }
                
                // 費用を支払う（成功失敗関係なく100）
                playerDaimyo.gold -= 100;
                
                // 成功率を計算
                const successChance = this.calculateRecruitChance(general, playerDaimyo);
                const roll = Math.random() * 100;
                
                if (roll <= successChance) {
                    // 登用成功
                    const newGeneral = {
                        id: general.id,
                        name: general.name,
                        lord: this.gameState.playerDaimyo,
                        stats: { ...general.stats },
                        skill: general.skill,
                        loyalty: Math.floor(Math.random() * 30) + 60
                    };
                    
                    this.gameState.generals.push(newGeneral);
                    this.gameState.availableGenerals = this.gameState.availableGenerals.filter(g => g.id !== generalId);
                    
                    this.gameState.addLog(`${general.name}の登用に成功！`, 'diplomacy');
                } else {
                    // 登用失敗
                    this.gameState.addLog(`${general.name}の登用に失敗...`, 'diplomacy');
                }
                
                this.updateAvailableGeneralsList();
                this.updateStatus();
            }
        }
        
        // ゲーム初期化
        const gameState = new GameState();
        const uiManager = new UIManager(gameState);
    </script>
</body>
</html>
